//! G-Code Visualizer Panel
//! Displays a 3D visualization of the loaded G-Code toolpath
//! Shows machine position, bounding box, and real-time tool movement

import { ScrollView, VerticalBox, HorizontalBox, Button, GridBox } from "std-widgets.slint";

export component GcodeVisualizerPanel inherits VerticalBox {
    spacing: 0px;
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;

    in property <string> gcode-filename: "untitled.gcode";
    in property <string> gcode-content: "";
    in property <image> visualization-image;
    in property <string> machine-x: "0.000";
    in property <string> machine-y: "0.000";
    in property <string> machine-z: "0.000";
    in property <string> work-x: "0.000";
    in property <string> work-y: "0.000";
    in property <string> work-z: "0.000";
    in property <float> progress: 0.0;
    in property <string> visualizer-status: "Ready";
    in property <float> x-offset: 0.0;
    in property <float> y-offset: 0.0;
    in property <float> zoom-scale: 1.0;
    
    callback refresh-visualization();
    callback zoom-in();
    callback zoom-out();
    callback fit-to-view();
    callback reset-view();
    callback pan-left();
    callback pan-right();
    callback pan-up();
    callback pan-down();

    VerticalBox {
        spacing: 8px;
        padding: 12px;

        // Toolbar
        HorizontalBox {
            height: 40px;
            spacing: 8px;
            alignment: start;

            Text {
                text: "Visualization Controls:";
                font-weight: 700;
                font-size: 12px;
                color: #2c3e50;
            }

            Button {
                text: "🔄 Refresh";
                width: 100px;
                clicked => {
                    root.refresh-visualization();
                }
            }

            Button {
                text: "🔍+ Zoom In";
                width: 100px;
                clicked => {
                    root.zoom-in();
                }
            }

            Button {
                text: "🔍- Zoom Out";
                width: 100px;
                clicked => {
                    root.zoom-out();
                }
            }

            Button {
                text: "⊡ Fit";
                width: 80px;
                clicked => {
                    root.fit-to-view();
                }
            }

            Button {
                text: "↺ Reset";
                width: 80px;
                clicked => {
                    root.reset-view();
                }
            }
        }

        // Pan controls toolbar
        HorizontalBox {
            height: 40px;
            spacing: 8px;
            alignment: start;

            Text {
                text: "Pan:";
                font-weight: 700;
                font-size: 12px;
                color: #2c3e50;
            }

            Button {
                text: "← Left";
                width: 80px;
                clicked => {
                    root.pan-left();
                }
            }

            Button {
                text: "→ Right";
                width: 80px;
                clicked => {
                    root.pan-right();
                }
            }

            Button {
                text: "↑ Up";
                width: 80px;
                clicked => {
                    root.pan-up();
                }
            }

            Button {
                text: "↓ Down";
                width: 80px;
                clicked => {
                    root.pan-down();
                }
            }
        }

        // Main visualization area with scrollview
        ScrollView {
            VerticalBox {
                padding: 20px;
                spacing: 12px;
                alignment: center;

                    // 2D Visualizer - Rendered Toolpath
                    Rectangle {
                        width: 100%;
                        height: 500px;
                        background: #f5f5f5;
                        border-width: 2px;
                        border-color: #ddd;
                        border-radius: 4px;
                        
                        if root.gcode-content != "" && root.visualization-image.width > 0 : Image {
                            source: root.visualization-image;
                            width: 100%;
                            height: 100%;
                        }
                    }

                    // Progress indicator
                    VerticalBox {
                        width: 100%;
                        spacing: 4px;

                        HorizontalBox {
                            spacing: 8px;
                            alignment: space-between;

                            Text {
                                text: "Execution Progress:";
                                font-size: 11px;
                                font-weight: 700;
                                color: #34495e;
                            }

                            Text {
                                text: Math.round(root.progress * 100) + "%";
                                font-size: 11px;
                                font-weight: 700;
                                color: #e74c3c;
                            }
                        }

                        Rectangle {
                            height: 20px;
                            background: #ecf0f1;
                            border-width: 1px;
                            border-color: #bdc3c7;
                            border-radius: 2px;

                            Rectangle {
                                width: (root.progress * 100%) * 1px;
                                height: 100%;
                                background: #27ae60;
                                border-radius: 1px;
                            }

                            Text {
                                text: Math.round(root.progress * 100) + "%";
                                font-size: 10px;
                                color: #2c3e50;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Position display
                    GridBox {
                        spacing: 12px;
                        width: 100%;

                        Rectangle {
                            col: 0;
                            row: 0;
                            background: #f8f9fa;
                            border-width: 1px;
                            border-color: #dee2e6;
                            border-radius: 2px;
                            width: 120px;
                            height: 70px;

                            VerticalBox {
                                alignment: center;
                                spacing: 4px;
                                padding-left: 8px;
                                padding-right: 8px;
                                padding-top: 8px;
                                padding-bottom: 8px;

                                Text {
                                    text: "Machine Position";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #34495e;
                                }

                                Text {
                                    text: "X: " + root.machine-x;
                                    font-size: 10px;
                                    color: #2c3e50;
                                }

                                Text {
                                    text: "Y: " + root.machine-y;
                                    font-size: 10px;
                                    color: #2c3e50;
                                }

                                Text {
                                    text: "Z: " + root.machine-z;
                                    font-size: 10px;
                                    color: #2c3e50;
                                }
                            }
                        }

                        Rectangle {
                            col: 1;
                            row: 0;
                            background: #f8f9fa;
                            border-width: 1px;
                            border-color: #dee2e6;
                            border-radius: 2px;
                            width: 120px;
                            height: 70px;

                            VerticalBox {
                                alignment: center;
                                spacing: 4px;
                                padding-left: 8px;
                                padding-right: 8px;
                                padding-top: 8px;
                                padding-bottom: 8px;

                                Text {
                                    text: "Work Position";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #34495e;
                                }

                                Text {
                                    text: "X: " + root.work-x;
                                    font-size: 10px;
                                    color: #2c3e50;
                                }

                                Text {
                                    text: "Y: " + root.work-y;
                                    font-size: 10px;
                                    color: #2c3e50;
                                }

                                Text {
                                    text: "Z: " + root.work-z;
                                    font-size: 10px;
                                    color: #2c3e50;
                                }
                            }
                        }

                        Rectangle {
                            col: 2;
                            row: 0;
                            background: #e8f5e9;
                            border-width: 1px;
                            border-color: #4caf50;
                            border-radius: 2px;
                            width: 120px;
                            height: 70px;

                            VerticalBox {
                                alignment: center;
                                spacing: 4px;
                                padding-left: 8px;
                                padding-right: 8px;
                                padding-top: 8px;
                                padding-bottom: 8px;

                                Text {
                                    text: "Zoom Scale";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #2e7d32;
                                }

                                Text {
                                    text: Math.round(root.zoom-scale * 1000.0) / 10.0 + "%";
                                    font-size: 11px;
                                    font-weight: 700;
                                    color: #1b5e20;
                                }

                                Text {
                                    text: "(" + Math.round(root.zoom-scale * 100.0) / 100.0 + "x)";
                                    font-size: 9px;
                                    color: #2e7d32;
                                }
                            }
                        }

                        Rectangle {
                            col: 3;
                            row: 0;
                            background: #e3f2fd;
                            border-width: 1px;
                            border-color: #2196f3;
                            border-radius: 2px;
                            width: 120px;
                            height: 70px;

                            VerticalBox {
                                alignment: center;
                                spacing: 4px;
                                padding-left: 8px;
                                padding-right: 8px;
                                padding-top: 8px;
                                padding-bottom: 8px;

                                Text {
                                    text: "X Offset";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #1565c0;
                                }

                                Text {
                                    text: Math.round(root.x-offset * 10.0) / 10.0;
                                    font-size: 11px;
                                    font-weight: 700;
                                    color: #0d47a1;
                                }

                                Text {
                                    text: "px";
                                    font-size: 9px;
                                    color: #1565c0;
                                }
                            }
                        }

                        Rectangle {
                            col: 4;
                            row: 0;
                            background: #f3e5f5;
                            border-width: 1px;
                            border-color: #9c27b0;
                            border-radius: 2px;
                            width: 120px;
                            height: 70px;

                            VerticalBox {
                                alignment: center;
                                spacing: 4px;
                                padding-left: 8px;
                                padding-right: 8px;
                                padding-top: 8px;
                                padding-bottom: 8px;

                                Text {
                                    text: "Y Offset";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #6a1b9a;
                                }

                                Text {
                                    text: Math.round(root.y-offset * 10.0) / 10.0;
                                    font-size: 11px;
                                    font-weight: 700;
                                    color: #4a148c;
                                }

                                Text {
                                    text: "px";
                                    font-size: 9px;
                                    color: #6a1b9a;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
