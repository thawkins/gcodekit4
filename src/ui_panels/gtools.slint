//! GTools Panel - G-Code Utilities and Quick Generators
//! Provides rapid G-code generation for common operations (geometry, patterns, drilling, etc.)

import { LineEdit, VerticalBox, HorizontalBox, ScrollView, ComboBox, Button, SpinBox, CheckBox } from "std-widgets.slint";

export struct GToolParameter {
    name: string,
    label: string,
    value: float,
    min: float,
    max: float,
    unit: string,
}

export struct GToolConfig {
    tool_id: int,
    tool_name: string,
    category: string,
    parameters: [GToolParameter],
}

export component GToolsPanel inherits VerticalBox {
    spacing: 0px;
    padding: 10px;
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    
    // Current configuration
    in-out property <GToolConfig> current-tool;
    in property <[string]> categories: [
        "Basic Geometry",
        "Patterns",
        "Drilling",
        "Text & Engraving",
        "Facing & Surfacing",
        "Utilities",
        "Probing & Setup",
        "Motion Control",
        "Templates",
        "Calculators"
    ];
    in property <[string]> geometry-tools: [
        "Rectangle",
        "Circle",
        "Polygon",
        "Line"
    ];
    in property <[string]> pattern-tools: [
        "Linear Array",
        "Circular Array",
        "Grid Array"
    ];
    in property <[string]> drilling-tools: [
        "Single Hole",
        "Hole Pattern",
        "Thread Mill"
    ];
    in property <string> generated-gcode: "";
    in property <bool> has-preview: false;
    
    // Callbacks
    callback select-tool(string, string);  // category, tool_name
    callback set-parameter(string, float); // parameter_name, value
    callback generate();
    callback preview();
    callback send-to-editor();
    callback send-to-machine();
    
    ScrollView {
        VerticalBox {
            spacing: 10px;
            padding: 5px;
            horizontal-stretch: 1.0;
            vertical-stretch: 1.0;
            
            /// Header
            Rectangle {
                background: #e67e22;
                height: 50px;
                vertical-stretch: 0;
                
                VerticalBox {
                    padding: 8px;
                    alignment: center;
                    
                    Text {
                        text: "🛠️ GTools - G-Code Utilities";
                        color: white;
                        font-size: 16px;
                        font-weight: 700;
                    }
                }
            }
            
            /// Category Selection
            Rectangle {
                background: #ecf0f1;
                border-width: 1px;
                border-color: #bdc3c7;
                border-radius: 5px;
                vertical-stretch: 0;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 8px;
                    
                    Text {
                        text: "Select Tool Category";
                        font-size: 12px;
                        font-weight: 700;
                        color: #2c3e50;
                    }
                    
                    ComboBox {
                        model: root.categories;
                        current-index: 0;
                        selected(value) => {
                            root.select-tool(value, "");
                        }
                    }
                }
            }
            
            /// Tool Selection
            Rectangle {
                background: #ecf0f1;
                border-width: 1px;
                border-color: #bdc3c7;
                border-radius: 5px;
                vertical-stretch: 0;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 8px;
                    
                    Text {
                        text: "Select Tool";
                        font-size: 12px;
                        font-weight: 700;
                        color: #2c3e50;
                    }
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        Button {
                            text: "📐 Rectangle";
                            clicked => { root.select-tool("Basic Geometry", "Rectangle"); }
                        }
                        
                        Button {
                            text: "⭕ Circle";
                            clicked => { root.select-tool("Basic Geometry", "Circle"); }
                        }
                        
                        Button {
                            text: "📍 Line";
                            clicked => { root.select-tool("Basic Geometry", "Line"); }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        Button {
                            text: "🔄 Array";
                            clicked => { root.select-tool("Patterns", "Linear Array"); }
                        }
                        
                        Button {
                            text: "⚙️ Drill";
                            clicked => { root.select-tool("Drilling", "Single Hole"); }
                        }
                        
                        Button {
                            text: "📝 Text";
                            clicked => { root.select-tool("Text & Engraving", "Text Engraving"); }
                        }
                    }
                }
            }
            
            /// Tool Name Display
            if root.current-tool.tool_name != "" : Rectangle {
                background: #d5f4e6;
                border-width: 1px;
                border-color: #27ae60;
                border-radius: 5px;
                vertical-stretch: 0;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 4px;
                    
                    HorizontalBox {
                        spacing: 8px;
                        
                        Text {
                            text: "Current Tool:";
                            font-size: 11px;
                            font-weight: 700;
                            color: #27ae60;
                        }
                        
                        Text {
                            text: root.current-tool.tool_name;
                            font-size: 12px;
                            font-weight: 700;
                            color: #1e8449;
                        }
                    }
                }
            }
            
            /// Parameters Section
            if root.current-tool.tool_name != "" : Rectangle {
                background: #ecf0f1;
                border-width: 1px;
                border-color: #bdc3c7;
                border-radius: 5px;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 10px;
                    
                    Text {
                        text: "Parameters";
                        font-size: 12px;
                        font-weight: 700;
                        color: #2c3e50;
                    }
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 8px;
                            horizontal-stretch: 1.0;
                            
                            // Width parameter (for Rectangle)
                            if root.current-tool.tool_name == "Rectangle" : Rectangle {
                                background: white;
                                border-width: 1px;
                                border-color: #bdc3c7;
                                border-radius: 3px;
                                height: 45px;
                                
                                HorizontalBox {
                                    padding: 8px;
                                    spacing: 8px;
                                    alignment: center;
                                    
                                    Text {
                                        text: "Width (mm):";
                                        width: 40%;
                                        font-size: 11px;
                                    }
                                    
                                    SpinBox {
                                        value: root.current-tool.parameters[0].value;
                                        minimum: 1;
                                        maximum: 500;
                                    }
                                }
                            }
                            
                            // Height parameter (for Rectangle)
                            if root.current-tool.tool_name == "Rectangle" : Rectangle {
                                background: white;
                                border-width: 1px;
                                border-color: #bdc3c7;
                                border-radius: 3px;
                                height: 45px;
                                
                                HorizontalBox {
                                    padding: 8px;
                                    spacing: 8px;
                                    alignment: center;
                                    
                                    Text {
                                        text: "Height (mm):";
                                        width: 40%;
                                        font-size: 11px;
                                    }
                                    
                                    SpinBox {
                                        value: root.current-tool.parameters[1].value;
                                        minimum: 1;
                                        maximum: 500;
                                    }
                                }
                            }
                            
                            // Depth parameter
                            if root.current-tool.tool_name == "Rectangle" || root.current-tool.tool_name == "Circle" : Rectangle {
                                background: white;
                                border-width: 1px;
                                border-color: #bdc3c7;
                                border-radius: 3px;
                                height: 45px;
                                
                                HorizontalBox {
                                    padding: 8px;
                                    spacing: 8px;
                                    alignment: center;
                                    
                                    Text {
                                        text: "Depth (mm):";
                                        width: 40%;
                                        font-size: 11px;
                                    }
                                    
                                    SpinBox {
                                        value: 5;
                                        minimum: 1;
                                        maximum: 100;
                                    }
                                }
                            }
                            
                            // Diameter parameter (for Circle)
                            if root.current-tool.tool_name == "Circle" : Rectangle {
                                background: white;
                                border-width: 1px;
                                border-color: #bdc3c7;
                                border-radius: 3px;
                                height: 45px;
                                
                                HorizontalBox {
                                    padding: 8px;
                                    spacing: 8px;
                                    alignment: center;
                                    
                                    Text {
                                        text: "Diameter (mm):";
                                        width: 40%;
                                        font-size: 11px;
                                    }
                                    
                                    SpinBox {
                                        value: 25;
                                        minimum: 1;
                                        maximum: 500;
                                    }
                                }
                            }
                            
                            // Operation type
                            if root.current-tool.tool_name == "Rectangle" || root.current-tool.tool_name == "Circle" : Rectangle {
                                background: white;
                                border-width: 1px;
                                border-color: #bdc3c7;
                                border-radius: 3px;
                                height: 40px;
                                
                                HorizontalBox {
                                    padding: 8px;
                                    spacing: 8px;
                                    alignment: center;
                                    
                                    Text {
                                        text: "Mode:";
                                        width: 40%;
                                        font-size: 11px;
                                    }
                                    
                                    ComboBox {
                                        model: ["Contour", "Pocket"];
                                        current-index: 0;
                                        selected(value) => { root.set-parameter("mode", 0); }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            /// Action Buttons
            if root.current-tool.tool_name != "" : Rectangle {
                background: #fff3e0;
                border-width: 1px;
                border-color: #ffb74d;
                border-radius: 5px;
                vertical-stretch: 0;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 8px;
                    
                    Text {
                        text: "Actions";
                        font-size: 12px;
                        font-weight: 700;
                        color: #e67e22;
                    }
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        Button {
                            text: "📊 Preview";
                            clicked => { root.preview(); }
                        }
                        
                        Button {
                            text: "⚡ Generate";
                            clicked => { root.generate(); }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        Button {
                            text: "✏️ Send to Editor";
                            clicked => { root.send-to-editor(); }
                        }
                        
                        Button {
                            text: "🚀 Send to Machine";
                            clicked => { root.send-to-machine(); }
                        }
                    }
                }
            }
            
            /// G-Code Output Preview
            if root.has-preview && root.generated-gcode != "" : Rectangle {
                background: #f8f9fa;
                border-width: 1px;
                border-color: #dee2e6;
                border-radius: 5px;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 8px;
                    
                    Text {
                        text: "Generated G-Code Preview";
                        font-size: 11px;
                        font-weight: 700;
                        color: #495057;
                    }
                    
                    Rectangle {
                        background: white;
                        border-width: 1px;
                        border-color: #dee2e6;
                        border-radius: 3px;
                        height: 150px;
                        
                        ScrollView {
                            Text {
                                text: root.generated-gcode;
                                font-family: "Courier New";
                                font-size: 9px;
                                color: #212529;
                                wrap: word-wrap;
                                horizontal-alignment: left;
                                vertical-alignment: top;
                            }
                        }
                    }
                }
            }
            
            /// Help/Info Footer
            Rectangle {
                background: #e8f4f8;
                border-width: 1px;
                border-color: #b3e5fc;
                border-radius: 5px;
                vertical-stretch: 0;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 4px;
                    
                    Text {
                        text: "💡 Tip:";
                        font-size: 10px;
                        font-weight: 700;
                        color: #0277bd;
                    }
                    
                    Text {
                        text: "Select a tool category and tool above, adjust parameters, then click Generate to create G-code. Preview shows the output, send to editor to refine or directly to machine.";
                        font-size: 9px;
                        color: #01579b;
                        wrap: word-wrap;
                    }
                }
            }
        }
    }
}
