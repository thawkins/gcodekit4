// GCodeKit4 Main UI
// Universal G-Code Sender for CNC Machines

import { Button, ComboBox, LineEdit, TextEdit, VerticalBox, HorizontalBox, ScrollView, SpinBox } from "std-widgets.slint";

export struct PortInfo {
    port: string,
    description: string,
}

export component MainWindow inherits Window {
    title: "GCodeKit4 - Universal G-Code Sender";
    
    // Dynamic properties exposed to Rust
    in property <[string]> available-ports: [];
    in-out property <string> selected-port: "";
    in property <bool> connected: false;
    in property <string> connection-status: "Disconnected";
    in property <string> device-version: "Unknown";
    in property <float> position-x: 0.0;
    in property <float> position-y: 0.0;
    in property <float> position-z: 0.0;
    in property <string> machine-state: "DISCONNECTED";
    out property <int> selected-baud: 115200;
    
    callback refresh-ports();
    callback connect(string, int);
    callback disconnect();
    callback menu-file-open();
    callback menu-file-exit();
    callback menu-edit-preferences();
    callback menu-view-fullscreen();
    callback menu-help-about();
    
    // Internal state for UI selections
    private property <int> port-index: 0;
    private property <int> baud-index: 3;  // Default to 115200
    
    // Private properties for menu state
    private property <bool> file-menu-open: false;
    private property <bool> edit-menu-open: false;
    private property <bool> view-menu-open: false;
    private property <bool> help-menu-open: false;
    
    VerticalBox {
        spacing: 0px;
        
        // Menu bar
        Rectangle {
            height: 40px;
            background: #2c3e50;
            z: 1000;
            
            HorizontalBox {
                padding: 8px;
                spacing: 20px;
                alignment: start;
                height: 40px;
                
                // File Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: file-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "File";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            file-menu-open = !file-menu-open;
                            edit-menu-open = false;
                            view-menu-open = false;
                            help-menu-open = false;
                        }
                    }
                }
                
                // Edit Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: edit-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "Edit";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            edit-menu-open = !edit-menu-open;
                            file-menu-open = false;
                            view-menu-open = false;
                            help-menu-open = false;
                        }
                    }
                }
                
                // View Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: view-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "View";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            view-menu-open = !view-menu-open;
                            file-menu-open = false;
                            edit-menu-open = false;
                            help-menu-open = false;
                        }
                    }
                }
                
                // Help Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: help-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "Help";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            help-menu-open = !help-menu-open;
                            file-menu-open = false;
                            edit-menu-open = false;
                            view-menu-open = false;
                        }
                    }
                }
            }
        }
        
        // Main content area - with constrained height
        Rectangle {
            HorizontalBox {
                spacing: 10px;
                padding: 10px;
            
            // Left panel - Connection and Control
            VerticalBox {
                width: 300px;
                spacing: 10px;
                
                // Connection Panel
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        
                        Text {
                            text: "Connection";
                            font-weight: 700;
                            font-size: 14px;
                        }
                        
                        HorizontalBox {
                            Text { text: "Port:"; width: 50px; }
                            port-combo := ComboBox {
                                model: root.available-ports;
                                current-index: port-index;
                                selected => {
                                    port-index = port-combo.current-index;
                                    if (port-combo.current-index >= 0 && port-combo.current-index < root.available-ports.length) {
                                        root.selected-port = root.available-ports[port-combo.current-index];
                                    }
                                }
                            }
                        }
                        
                        HorizontalBox {
                            Text { text: "Baud:"; width: 50px; }
                            baud-combo := ComboBox {
                                model: ["9600", "19200", "38400", "57600", "115200", "230400"];
                                current-index: baud-index;
                                selected => {
                                    baud-index = baud-combo.current-index;
                                    if (baud-combo.current-index == 0) { root.selected-baud = 9600; }
                                    else if (baud-combo.current-index == 1) { root.selected-baud = 19200; }
                                    else if (baud-combo.current-index == 2) { root.selected-baud = 38400; }
                                    else if (baud-combo.current-index == 3) { root.selected-baud = 57600; }
                                    else if (baud-combo.current-index == 4) { root.selected-baud = 115200; }
                                    else if (baud-combo.current-index == 5) { root.selected-baud = 230400; }
                                }
                            }
                        }
                        
                        HorizontalBox {
                            spacing: 5px;
                            Button {
                                text: root.connected ? "Disconnect" : "Connect";
                                width: 50%;
                                clicked => {
                                    if (root.connected) {
                                        root.disconnect();
                                    } else {
                                        root.connect(root.selected-port, root.selected-baud);
                                    }
                                }
                            }
                            Button {
                                text: "Refresh";
                                width: 50%;
                                clicked => { root.refresh-ports(); }
                            }
                        }
                    }
                }
                
                // DRO Panel (Display Readout)
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        
                        Text {
                            text: "Position (Work)";
                            font-weight: 700;
                            font-size: 14px;
                        }
                        
                        HorizontalBox {
                            Text { text: "X:"; width: 30px; }
                            LineEdit {
                                read-only: true;
                                text: "0.000";
                            }
                        }
                        
                        HorizontalBox {
                            Text { text: "Y:"; width: 30px; }
                            LineEdit {
                                read-only: true;
                                text: "0.000";
                            }
                        }
                        
                        HorizontalBox {
                            Text { text: "Z:"; width: 30px; }
                            LineEdit {
                                read-only: true;
                                text: "0.000";
                            }
                        }
                    }
                }
                
                // Control Buttons
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        
                        Button {
                            text: "Start";
                        }
                        Button {
                            text: "Pause";
                        }
                        Button {
                            text: "Stop";
                        }
                        Button {
                            text: "Reset";
                        }
                    }
                }
            }
            
            // Center panel - File and Viewer
            VerticalBox {
                spacing: 10px;
                
                // File Operations
                Rectangle {
                    background: #ecf0f1;
                    height: 50px;
                    
                    HorizontalBox {
                        padding: 10px;
                        spacing: 5px;
                        
                        Button {
                            text: "Open File";
                        }
                        Button {
                            text: "Save";
                        }
                        Text {
                            text: "Ready";
                            color: green;
                        }
                    }
                }
                
                // G-Code Viewer
                Rectangle {
                    background: white;
                    ScrollView {
                        TextEdit {
                            read-only: true;
                            text: "; G-Code viewer\nG00 X10 Y10\nG01 Z-5 F100\nG00 Z5\n";
                        }
                    }
                }
                
                // Console Output
                Rectangle {
                    background: #2c3e50;
                    height: 100px;
                    
                    ScrollView {
                        TextEdit {
                            read-only: true;
                            text: "[INFO] GCodeKit4 initialized\n[INFO] Ready for operation\n";
                        }
                    }
                }
            }
            
            // Right panel - Jog and Overrides
            VerticalBox {
                width: 250px;
                spacing: 10px;
                
                // Jog Controller
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 5px;
                        
                        Text {
                            text: "Jog";
                            font-weight: 700;
                            font-size: 14px;
                        }
                        
                        HorizontalBox {
                            Button { text: "←"; width: 25%; }
                            Button { text: "↑"; width: 25%; }
                            Button { text: "→"; width: 25%; }
                            Button { text: "↓"; width: 25%; }
                        }
                        
                        HorizontalBox {
                            Text { text: "Step:"; width: 50px; }
                            LineEdit {
                                text: "1.00";
                            }
                        }
                    }
                }
                
                // Overrides
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        
                        Text {
                            text: "Overrides";
                            font-weight: 700;
                            font-size: 14px;
                        }
                        
                        HorizontalBox {
                            Text { text: "Feed:"; width: 50px; }
                            SpinBox {
                                value: 100;
                                minimum: 0;
                                maximum: 200;
                            }
                            Text { text: "%"; }
                        }
                        
                        HorizontalBox {
                            Text { text: "Spindle:"; width: 50px; }
                            SpinBox {
                                value: 100;
                                minimum: 0;
                                maximum: 200;
                            }
                            Text { text: "%"; }
                        }
                    }
                }
            }
            }
        }
        
        // Status Panel - Compact Single Line
        Rectangle {
            height: 30px;
            background: #2c3e50;
            
            HorizontalBox {
                padding-top: 4px;
                padding-bottom: 4px;
                padding-left: 10px;
                padding-right: 10px;
                spacing: 15px;
                
                // Connection Status Indicator (colored square)
                Rectangle {
                    width: 16px;
                    height: 16px;
                    background: root.connected ? #2ecc71 : #e74c3c;
                    border-radius: 2px;
                }
                
                // Port and Device Info (shown only when connected)
                Text {
                    text: root.connected ? root.selected-port + " | Version: " + root.device-version : "Disconnected";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
                
                // Position Display (X, Y, Z) - shown only when connected
                Text {
                    text: root.connected ? "X: " + round(root.position-x * 1000.0) / 1000.0 + "  Y: " + round(root.position-y * 1000.0) / 1000.0 + "  Z: " + round(root.position-z * 1000.0) / 1000.0 : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
            }
        }
    }
    
    // File Menu Dropdown
    if file-menu-open : Rectangle {
        y: 40px;
        x: 8px;
        width: 120px;
        height: 70px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-file-open-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Open File";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-file-open-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        file-menu-open = false;
                        root.menu-file-open();
                    }
                }
            }
            
            Rectangle {
                height: 28px;
                background: mi-file-exit-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Exit";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-file-exit-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        file-menu-open = false;
                        root.menu-file-exit();
                    }
                }
            }
        }
    }
    
    // Edit Menu Dropdown
    if edit-menu-open : Rectangle {
        y: 40px;
        x: 78px;
        width: 140px;
        height: 40px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-edit-prefs-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Preferences";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-edit-prefs-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        edit-menu-open = false;
                        root.menu-edit-preferences();
                    }
                }
            }
        }
    }
    
    // View Menu Dropdown
    if view-menu-open : Rectangle {
        y: 40px;
        x: 156px;
        width: 140px;
        height: 40px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-view-fullscreen-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Fullscreen";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-view-fullscreen-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        view-menu-open = false;
                        root.menu-view-fullscreen();
                    }
                }
            }
        }
    }
    
    // Help Menu Dropdown
    if help-menu-open : Rectangle {
        y: 40px;
        x: 234px;
        width: 120px;
        height: 40px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-help-about-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "About";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-help-about-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        help-menu-open = false;
                        root.menu-help-about();
                    }
                }
            }
        }
    }
}
