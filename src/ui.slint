// GCodeKit4 Main UI
// Universal G-Code Sender for CNC Machines

import { Button, ComboBox, LineEdit, TextEdit, VerticalBox, HorizontalBox, ScrollView, SpinBox, CheckBox } from "std-widgets.slint";

export struct PortInfo {
    port: string,
    description: string,
}

export struct SettingItem {
    id: string,
    name: string,
    value: string,
    value-type: string, // "Boolean", "String", "Integer", "Float"
    category: string,
    description: string,
}

export component MainWindow inherits Window {
    title: "GCodeKit4 - Universal G-Code Sender";
    
    // Dynamic properties exposed to Rust
    in property <[string]> available-ports: [];
    in-out property <string> selected-port: "";
    in property <bool> connected: false;
    in property <string> connection-status: "Disconnected";
    in property <string> device-version: "Unknown";
    in property <[SettingItem]> all-settings: [];
    in property <float> position-x: 0.0;
    in property <float> position-y: 0.0;
    in property <float> position-z: 0.0;
    in property <float> position-a: 0.0;
    in property <float> position-b: 0.0;
    in property <float> position-c: 0.0;
    in property <float> feed-rate: 0.0;
    in property <float> spindle-speed: 0.0;
    in property <string> machine-state: "DISCONNECTED";
    in property <string> app-version: "0.9.1";
    in property <string> app-build-date: "2025-10-22";
    in property <string> console-output: "[INFO] GCodeKit4 initialized\n[INFO] Ready for operation\n";
    in-out property <string> gcode-content: "";
    in-out property <string> current-view: "gcode-editor";
    in-out property <string> gcode-filename: "untitled.gcode";
    in property <int> console-scroll-trigger: 0;
    
    callback refresh-ports();
    callback connect(string, int);
    callback disconnect();
    callback menu-file-open();
    callback menu-file-save();
    callback menu-file-save-as();
    callback menu-file-exit();
    callback menu-edit-preferences();
    callback menu-settings-save();
    callback menu-settings-cancel();
    callback menu-settings-restore-defaults();
    callback menu-view-fullscreen();
    callback menu-view-gcode-editor();
    callback menu-view-machine();
    callback menu-view-device-console();
    callback menu-help-about();
    callback update-setting(string, string);
    callback console-clear-clicked();
    callback console-copy-clicked();
    
    // Internal state for UI selections
    private property <int> port-index: 0;
    private property <int> console-scroll-ref: 0;
    private property <float> step-size: 1.0;
    private property <int> step-index: 1;
    
    // Private properties for menu state
    private property <bool> file-menu-open: false;
    private property <bool> edit-menu-open: false;
    private property <bool> view-menu-open: false;
    private property <bool> help-menu-open: false;
    private property <bool> about-dialog-visible: false;
    private property <bool> settings-dialog-visible: false;
    private property <string> settings-category: "controller";
    
    VerticalBox {
        spacing: 0px;
        
        // Menu bar
        Rectangle {
            height: 40px;
            background: #2c3e50;
            z: 1000;
            
            HorizontalBox {
                padding: 8px;
                spacing: 20px;
                alignment: start;
                height: 40px;
                
                // File Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: file-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "File";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            file-menu-open = !file-menu-open;
                            edit-menu-open = false;
                            view-menu-open = false;
                            help-menu-open = false;
                        }
                    }
                }
                
                // Edit Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: edit-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "Edit";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            edit-menu-open = !edit-menu-open;
                            file-menu-open = false;
                            view-menu-open = false;
                            help-menu-open = false;
                        }
                    }
                }
                
                // View Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: view-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "View";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            view-menu-open = !view-menu-open;
                            file-menu-open = false;
                            edit-menu-open = false;
                            help-menu-open = false;
                        }
                    }
                }
                
                // Help Menu
                Rectangle {
                    width: 50px;
                    height: 24px;
                    background: help-menu-open ? #34495e : transparent;
                    border-radius: 3px;
                    
                    Text {
                        text: "Help";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            help-menu-open = !help-menu-open;
                            file-menu-open = false;
                            edit-menu-open = false;
                            view-menu-open = false;
                        }
                    }
                }
            }
        }
        
        // Main content area
        HorizontalBox {
            spacing: 10px;
            padding: 10px;
            
            // Left panel - Connection and Control
            VerticalBox {
                width: 300px;
                spacing: 10px;
                
                // Connection Panel
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        
                        Text {
                            text: "Connection";
                            font-weight: 700;
                            font-size: 14px;
                        }
                        
                        HorizontalBox {
                            Text { text: "Port:"; width: 50px; }
                            port-combo := ComboBox {
                                model: root.available-ports;
                                current-index: port-index;
                                selected => {
                                    port-index = port-combo.current-index;
                                    if (port-combo.current-index >= 0 && port-combo.current-index < root.available-ports.length) {
                                        root.selected-port = root.available-ports[port-combo.current-index];
                                    }
                                }
                            }
                        }
                        
                        HorizontalBox {
                            spacing: 5px;
                            Button {
                                text: root.connected ? "Disconnect" : "Connect";
                                width: 50%;
                                clicked => {
                                    if (root.connected) {
                                        root.disconnect();
                                    } else {
                                        root.connect(root.selected-port, 115200);
                                    }
                                }
                            }
                            Button {
                                text: "Refresh";
                                width: 50%;
                                clicked => { root.refresh-ports(); }
                            }
                        }
                    }
                }
                
                // Control Buttons
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        
                        Button {
                            text: "Start";
                        }
                        Button {
                            text: "Pause";
                        }
                        Button {
                            text: "Stop";
                        }
                        Button {
                            text: "Reset";
                        }
                    }
                }
            }
            
            // Center panel - File and Viewer
            VerticalBox {
                spacing: 0px;
                
                // View title
                Rectangle {
                    background: #34495e;
                    height: 35px;
                    
                    Text {
                        text: current-view == "gcode-editor" ? "G-Code Editor" : 
                              current-view == "machine" ? "Machine Control" : "Device Console";
                        color: white;
                        font-size: 14px;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        padding-left: 15px;
                    }
                }
                
                // GCode Editor View
                if current-view == "gcode-editor" : VerticalBox {
                    spacing: 0px;
                    
                    // File Operations Toolbar
                    Rectangle {
                        background: #ecf0f1;
                        height: 120px;
                        
                        VerticalBox {
                            padding: 10px;
                            spacing: 8px;
                            
                            HorizontalBox {
                                spacing: 15px;
                                
                                Button {
                                    text: "Open File";
                                    clicked => {
                                        root.menu-file-open();
                                    }
                                }
                                Button {
                                    text: "Save";
                                    enabled: root.gcode-content != "" && root.gcode-filename != "untitled.gcode";
                                    clicked => {
                                        root.menu-file-save();
                                    }
                                }
                                Button {
                                    text: "Save As";
                                    enabled: root.gcode-content != "";
                                    clicked => {
                                        root.menu-file-save-as();
                                    }
                                }
                                Button {
                                    text: "Send";
                                    enabled: root.gcode-content != "";
                                    clicked => {
                                        // Will implement send to machine
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                spacing: 15px;
                                
                                Text {
                                    text: "Filename:";
                                    vertical-alignment: center;
                                }
                                LineEdit {
                                    text <=> root.gcode-filename;
                                    horizontal-stretch: 1.0;
                                }
                                Text {
                                    text: "Ready";
                                    color: green;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                    
                    // G-Code Content Display
                    Rectangle {
                        background: #f5f5f5;
                        
                        ScrollView {
                            VerticalBox {
                                TextEdit {
                                    enabled: true;
                                    text <=> root.gcode-content;
                                    read-only: false;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
                
                // Device Console View
                if current-view == "device-console" : VerticalBox {
                    spacing: 5px;
                    padding: 10px;
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        Button {
                            text: "Clear";
                            clicked => {
                                root.console-clear-clicked();
                            }
                        }
                        
                        Button {
                            text: "Copy";
                            clicked => {
                                root.console-copy-clicked();
                            }
                        }
                    }
                    
                    console-scroll := ScrollView {
                        VerticalBox {
                            padding: 5px;
                            alignment: start;
                            
                            Text {
                                text: root.console-output;
                                color: #000000;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
                
                // Machine Control View
                if current-view == "machine" : VerticalBox {
                    spacing: 0px;
                    padding: 10px;
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 15px;
                            padding: 5px;
                            padding-right: 5px;
                            
                            // DRO Display (moved to top)
                            Rectangle {
                                background: #ecf0f1;
                                height: 175px;
                                
                                VerticalBox {
                                    padding: 10px;
                                    spacing: 6px;
                                    
                                    Text {
                                        text: "Position (Work)";
                                        font-weight: 700;
                                        font-size: 14px;
                                    }
                                    
                                    // Linear axes (X, Y, Z) + Feed
                                    HorizontalBox {
                                        spacing: 10px;
                                        alignment: start;
                                        
                                        HorizontalBox {
                                            width: 23%;
                                            spacing: 4px;
                                            Text { 
                                                text: "X:"; 
                                                width: 20px;
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.position-x * 1000.0) / 1000.0 + " mm\u{2003}";
                                            }
                                        }
                                        
                                        HorizontalBox {
                                            width: 23%;
                                            spacing: 4px;
                                            Text { 
                                                text: "Y:"; 
                                                width: 20px;
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.position-y * 1000.0) / 1000.0 + " mm\u{2003}";
                                            }
                                        }
                                        
                                        HorizontalBox {
                                            width: 23%;
                                            spacing: 4px;
                                            Text { 
                                                text: "Z:"; 
                                                width: 20px;
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.position-z * 1000.0) / 1000.0 + " mm\u{2003}";
                                            }
                                        }
                                        
                                        HorizontalBox {
                                            width: 24.8%;
                                            spacing: 4px;
                                            Text { 
                                                text: "Feed:"; 
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.feed-rate * 10.0) / 10.0 + " mm/m\u{2003}\u{2003}";
                                            }
                                        }
                                    }
                                    
                                    // Rotary axes (A, B, C) + Speed
                                    HorizontalBox {
                                        spacing: 10px;
                                        alignment: start;
                                        width: 100%;
                                        
                                        HorizontalBox {
                                            width: 23%;
                                            spacing: 4px;
                                            Text { 
                                                text: "A:"; 
                                                width: 20px;
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.position-a * 1000.0) / 1000.0 + " mm\u{2003}";
                                            }
                                        }
                                        
                                        HorizontalBox {
                                            width: 23%;
                                            spacing: 4px;
                                            Text { 
                                                text: "B:"; 
                                                width: 20px;
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.position-b * 1000.0) / 1000.0 + " mm\u{2003}";
                                            }
                                        }
                                        
                                        HorizontalBox {
                                            width: 23%;
                                            spacing: 4px;
                                            Text { 
                                                text: "C:"; 
                                                width: 20px;
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.position-c * 1000.0) / 1000.0 + " mm\u{2003}";
                                            }
                                        }
                                        
                                        HorizontalBox {
                                            width: 24.8%;
                                            spacing: 4px;
                                            Text { 
                                                text: "Speed:"; 
                                                vertical-alignment: center;
                                            }
                                            LineEdit {
                                                read-only: true;
                                                text: round(root.spindle-speed) + " rpm\u{2003}\u{2003}";
                                            }
                                        }
                                    }
                                }
                            }
                            
                            // Step Size Dropdown and Status Line
                            HorizontalBox {
                                spacing: 6px;
                                alignment: start;
                                
                                Text {
                                    text: "Step Size (mm):";
                                    vertical-alignment: center;
                                    font-size: 12px;
                                }
                                
                                step-combo := ComboBox {
                                    model: ["0.1", "1.0", "10", "50"];
                                    current-index: step-index;
                                    enabled: true;
                                    selected => {
                                        step-index = step-combo.current-index;
                                        step-size = [0.1, 1.0, 10.0, 50.0][step-combo.current-index];
                                    }
                                }
                                
                                Text {
                                    text: "mm";
                                    vertical-alignment: center;
                                    font-size: 12px;
                                }
                            }
                            
                            // Main controls area with buttons
                            VerticalBox {
                                spacing: 6px;
                                
                                // Row 1-3: Jog Buttons Grid
                                HorizontalBox {
                                    spacing: 6px;
                                    
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "⟲"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "▲"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "⟳"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "▲"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                }
                                
                                HorizontalBox {
                                    spacing: 6px;
                                    
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "◀"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "⌂"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "▶"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #c0392b : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text {
                                            text: "⊘";
                                            font-size: 61px;
                                            color: root.connected ? #c0392b : #bdc3c7;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                                
                                HorizontalBox {
                                    spacing: 6px;
                                    
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "⟲"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "▼"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "⟳"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 65px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "▼"; font-size: 36px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                }
                                
                                // Row 4: Axis Controls
                                HorizontalBox {
                                    spacing: 6px;
                                    
                                    Rectangle {
                                        width: 10%;
                                        height: 58px;
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 58px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "X⊙"; font-size: 28px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 58px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "Y⊙"; font-size: 28px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 58px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "Z⊙"; font-size: 28px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                }
                                
                                // Row 5: G-Code Commands
                                HorizontalBox {
                                    spacing: 6px;
                                    
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "G54"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "G55"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "G56"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "G57"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                }
                                
                                // Row 6: Additional Controls
                                HorizontalBox {
                                    spacing: 6px;
                                    
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "NA"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "NA"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "NA"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                    Rectangle {
                                        width: 10%;
                                        height: 52px;
                                        background: #ecf0f1;
                                        border-width: 2px;
                                        border-color: root.connected ? #34495e : #bdc3c7;
                                        border-radius: 5px;
                                        opacity: root.connected ? 1.0 : 0.5;
                                        Text { text: "NA"; font-size: 26px; horizontal-alignment: center; vertical-alignment: center; }
                                    }
                                }
                            }
                            

                        }
                    }
                }
            }
            
            // Right panel - Placeholder
            VerticalBox {
                width: 250px;
                spacing: 10px;
                
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 10px;
                        spacing: 8px;
                        alignment: center;
                        
                        Text {
                            text: "Placeholder";
                            font-weight: 700;
                            font-size: 14px;
                            horizontal-alignment: center;
                        }
                    }
                }
            }
        }
        
        // Status Panel - Compact Single Line
        Rectangle {
            height: 30px;
            background: #2c3e50;
            
            HorizontalBox {
                padding-top: 4px;
                padding-bottom: 4px;
                padding-left: 10px;
                padding-right: 10px;
                spacing: 0px;
                alignment: start;
                
                // Connection Status Indicator (colored square)
                Rectangle {
                    width: 16px;
                    height: 16px;
                    background: root.connected ? #2ecc71 : #e74c3c;
                    border-radius: 2px;
                }
                
                // Separator 1
                Text {
                    text: " \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                }
                
                // Port Display
                Text {
                    text: root.connected ? root.selected-port : "Disconnected";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
                
                // Separator between Port and Version
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }
                
                // Version Label and Device Info
                Text {
                    text: root.connected ? "Version: " + root.device-version : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
                
                // Separator 2 - Visual separator with EM spaces
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }
                
                // Position Label
                Text {
                    text: "Position:";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
                
                // Position Display (X, Y, Z) - shown only when connected
                Text {
                    text: root.connected ? "\u{2003}X: " + round(root.position-x * 1000.0) / 1000.0 + "  Y: " + round(root.position-y * 1000.0) / 1000.0 + "  Z: " + round(root.position-z * 1000.0) / 1000.0 : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
            }
        }
    }
    
    // File Menu Dropdown
    if file-menu-open : Rectangle {
        y: 40px;
        x: 8px;
        width: 120px;
        height: 70px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-file-open-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Open File";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-file-open-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        file-menu-open = false;
                        root.menu-file-open();
                    }
                }
            }
            
            Rectangle {
                height: 28px;
                background: mi-file-exit-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Exit";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-file-exit-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        file-menu-open = false;
                        root.menu-file-exit();
                    }
                }
            }
        }
    }
    
    // Edit Menu Dropdown
    if edit-menu-open : Rectangle {
        y: 40px;
        x: 78px;
        width: 140px;
        height: 40px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-edit-prefs-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "Preferences";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-edit-prefs-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        edit-menu-open = false;
                        settings-dialog-visible = true;
                        root.menu-edit-preferences();
                    }
                }
            }
        }
    }
    
    // View Menu Dropdown
    if view-menu-open : Rectangle {
        y: 40px;
        x: 156px;
        width: 200px;
        height: 160px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-view-fullscreen-area.has-hover ? #455a64 : transparent;
                
                HorizontalBox {
                    alignment: start;
                    padding-left: 8px;
                    spacing: 8px;
                    
                    Text {
                        text: "Fullscreen";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                }
                
                mi-view-fullscreen-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        view-menu-open = false;
                        root.menu-view-fullscreen();
                    }
                }
            }
            
            // Separator line
            Rectangle {
                height: 1px;
                background: #455a64;
            }
            
            Rectangle {
                height: 28px;
                background: mi-view-gcode-area.has-hover ? #455a64 : transparent;
                
                HorizontalBox {
                    alignment: start;
                    padding-left: 8px;
                    spacing: 8px;
                    
                    Text {
                        text: current-view == "gcode-editor" ? "✓ G-Code Editor" : "  G-Code Editor";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                }
                
                mi-view-gcode-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        view-menu-open = false;
                        current-view = "gcode-editor";
                        root.menu-view-gcode-editor();
                    }
                }
            }
            
            Rectangle {
                height: 28px;
                background: mi-view-machine-area.has-hover ? #455a64 : transparent;
                
                HorizontalBox {
                    alignment: start;
                    padding-left: 8px;
                    spacing: 8px;
                    
                    Text {
                        text: current-view == "machine" ? "✓ Machine Control" : "  Machine Control";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                }
                
                mi-view-machine-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        view-menu-open = false;
                        current-view = "machine";
                        root.menu-view-machine();
                    }
                }
            }
            
            Rectangle {
                height: 28px;
                background: mi-view-console-area.has-hover ? #455a64 : transparent;
                
                HorizontalBox {
                    alignment: start;
                    padding-left: 8px;
                    spacing: 8px;
                    
                    Text {
                        text: current-view == "device-console" ? "✓ Device Console" : "  Device Console";
                        color: white;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                }
                
                mi-view-console-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        view-menu-open = false;
                        current-view = "device-console";
                        root.menu-view-device-console();
                    }
                }
            }
        }
    }
    
    // Help Menu Dropdown
    if help-menu-open : Rectangle {
        y: 40px;
        x: 234px;
        width: 120px;
        height: 40px;
        background: #34495e;
        z: 1001;
        
        VerticalBox {
            padding: 4px;
            spacing: 2px;
            
            Rectangle {
                height: 28px;
                background: mi-help-about-area.has-hover ? #455a64 : transparent;
                
                Text {
                    text: "About";
                    color: white;
                    font-size: 12px;
                    vertical-alignment: center;
                    padding-left: 12px;
                }
                
                mi-help-about-area := TouchArea {
                    mouse-cursor: pointer;
                    clicked => {
                        help-menu-open = false;
                        about-dialog-visible = true;
                    }
                }
            }
        }
    }
    
    // About Dialog
    if about-dialog-visible : Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z: 2000;
        
        TouchArea {
            // Close dialog on background click
            clicked => {
                about-dialog-visible = false;
            }
        }
        
        Rectangle {
            x: (parent.width - 400px) / 2;
            y: (parent.height - 300px) / 2;
            width: 400px;
            height: 300px;
            background: #ecf0f1;
            border-radius: 5px;
            z: 2001;
            
            VerticalBox {
                padding: 20px;
                spacing: 15px;
                
                // Program Name - Triple Size
                Text {
                    text: "GCodeKit4";
                    font-size: 42px;
                    font-weight: 700;
                    color: #2c3e50;
                    horizontal-alignment: center;
                }
                
                // Version
                Text {
                    text: "Version: " + root.app-version;
                    font-size: 13px;
                    color: #34495e;
                    horizontal-alignment: center;
                }
                
                // Build Date
                Text {
                    text: "Built: " + root.app-build-date;
                    font-size: 13px;
                    color: #34495e;
                    horizontal-alignment: center;
                }
                
                // Spacer
                Rectangle {
                    height: 30px;
                }
                
                // OK Button - Lower Right
                HorizontalBox {
                    alignment: end;
                    
                    Button {
                        text: "Ok";
                        width: 80px;
                        height: 35px;
                        clicked => {
                            about-dialog-visible = false;
                        }
                    }
                }
            }
        }
    }
    
    // Settings Dialog
    if settings-dialog-visible : Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z: 2000;
        
        TouchArea {
            // Close dialog on background click (disabled to prevent accidental close)
        }
        
        Rectangle {
            x: (parent.width - 700px) / 2;
            y: (parent.height - 550px) / 2;
            width: 700px;
            height: 550px;
            background: #ecf0f1;
            border-radius: 5px;
            z: 2001;
            
            VerticalBox {
                padding: 0px;
                spacing: 0px;
                
                // Header with title
                Rectangle {
                    height: 50px;
                    background: #2c3e50;
                    
                    Text {
                        text: "Preferences";
                        font-size: 18px;
                        font-weight: 700;
                        color: white;
                        vertical-alignment: center;
                        padding-left: 20px;
                    }
                }
                
                // Main content area with category sidebar and settings panel
                HorizontalBox {
                    spacing: 0px;
                    
                    // Category sidebar
                    Rectangle {
                        width: 150px;
                        background: #34495e;
                        
                        VerticalBox {
                            padding: 10px;
                            spacing: 2px;
                            
                            // Controller category
                            Rectangle {
                                height: 35px;
                                background: settings-category == "controller" ? #3d5470 : transparent;
                                
                                Text {
                                    text: "Controller";
                                    color: white;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                    padding-left: 10px;
                                }
                                
                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        settings-category = "controller";
                                    }
                                }
                            }
                            
                            // UI category
                            Rectangle {
                                height: 35px;
                                background: settings-category == "ui" ? #3d5470 : transparent;
                                
                                Text {
                                    text: "User Interface";
                                    color: white;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                    padding-left: 10px;
                                }
                                
                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        settings-category = "ui";
                                    }
                                }
                            }
                            
                            // File Processing category
                            Rectangle {
                                height: 35px;
                                background: settings-category == "file" ? #3d5470 : transparent;
                                
                                Text {
                                    text: "File Processing";
                                    color: white;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                    padding-left: 10px;
                                }
                                
                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        settings-category = "file";
                                    }
                                }
                            }
                            
                            // Keyboard Shortcuts category
                            Rectangle {
                                height: 35px;
                                background: settings-category == "shortcuts" ? #3d5470 : transparent;
                                
                                Text {
                                    text: "Keyboard";
                                    color: white;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                    padding-left: 10px;
                                }
                                
                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        settings-category = "shortcuts";
                                    }
                                }
                            }
                            
                            // Advanced category
                            Rectangle {
                                height: 35px;
                                background: settings-category == "advanced" ? #3d5470 : transparent;
                                
                                Text {
                                    text: "Advanced";
                                    color: white;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                    padding-left: 10px;
                                }
                                
                                TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => {
                                        settings-category = "advanced";
                                    }
                                }
                            }
                        }
                    }
                    
                    // Settings content panel
                    Rectangle {
                        background: #ecf0f1;
                        
                        VerticalBox {
                            padding: 20px;
                            spacing: 12px;
                            
                            // Category title
                            Text {
                                text: settings-category == "controller" ? "Controller Settings" :
                                      settings-category == "ui" ? "User Interface" :
                                      settings-category == "file" ? "File Processing" :
                                      settings-category == "shortcuts" ? "Keyboard Shortcuts" :
                                      "Advanced Settings";
                                font-size: 14px;
                                font-weight: 700;
                                color: #2c3e50;
                            }
                            
                            // Divider
                            Rectangle {
                                height: 1px;
                                background: #bdc3c7;
                            }
                            
                            // Settings content - scrollable area
                            ScrollView {
                                VerticalBox {
                                    spacing: 15px;
                                    padding: 10px;
                                    
                                    // Example settings for each category
                                    if settings-category == "controller" : VerticalBox {
                                        spacing: 10px;
                                        
                                        Text {
                                            text: "Port Settings";
                                            font-size: 12px;
                                            font-weight: 700;
                                            color: #34495e;
                                        }
                                        
                                        Rectangle {
                                            height: 30px;
                                            
                                            HorizontalBox {
                                                Text {
                                                    text: "Connection Type:";
                                                    width: 120px;
                                                    vertical-alignment: center;
                                                    font-size: 11px;
                                                }
                                                ComboBox {
                                                    model: ["Serial", "TCP/IP", "WebSocket"];
                                                }
                                            }
                                        }
                                        
                                        Rectangle {
                                            height: 30px;
                                            
                                            HorizontalBox {
                                                Text {
                                                    text: "Baud Rate:";
                                                    width: 120px;
                                                    vertical-alignment: center;
                                                    font-size: 11px;
                                                }
                                                ComboBox {
                                                    model: ["9600", "19200", "38400", "115200"];
                                                }
                                            }
                                        }
                                    }
                                    
                                    if settings-category == "ui" : VerticalBox {
                                        spacing: 10px;
                                        
                                        Text {
                                            text: "Appearance";
                                            font-size: 12px;
                                            font-weight: 700;
                                            color: #34495e;
                                        }
                                        
                                        Rectangle {
                                            height: 30px;
                                            
                                            HorizontalBox {
                                                Text {
                                                    text: "Theme:";
                                                    width: 120px;
                                                    vertical-alignment: center;
                                                    font-size: 11px;
                                                }
                                                ComboBox {
                                                    model: ["Dark", "Light"];
                                                }
                                            }
                                        }
                                        
                                        Rectangle {
                                            height: 25px;
                                            
                                            HorizontalBox {
                                                CheckBox {
                                                    text: "Show toolbar";
                                                    checked: true;
                                                }
                                            }
                                        }
                                        
                                        Rectangle {
                                            height: 25px;
                                            
                                            HorizontalBox {
                                                CheckBox {
                                                    text: "Show status bar";
                                                    checked: true;
                                                }
                                            }
                                        }
                                    }
                                    
                                    if settings-category == "file" : VerticalBox {
                                        spacing: 10px;
                                        
                                        Text {
                                            text: "Processing Options";
                                            font-size: 12px;
                                            font-weight: 700;
                                            color: #34495e;
                                        }
                                        
                                        Rectangle {
                                            height: 25px;
                                            
                                            HorizontalBox {
                                                CheckBox {
                                                    text: "Remove comments";
                                                    checked: false;
                                                }
                                            }
                                        }
                                        
                                        Rectangle {
                                            height: 25px;
                                            
                                            HorizontalBox {
                                                CheckBox {
                                                    text: "Remove empty lines";
                                                    checked: false;
                                                }
                                            }
                                        }
                                    }
                                    
                                    if settings-category == "shortcuts" : VerticalBox {
                                        spacing: 10px;
                                        
                                        Text {
                                            text: "Keyboard Shortcuts";
                                            font-size: 12px;
                                            font-weight: 700;
                                            color: #34495e;
                                        }
                                        
                                        Text {
                                            text: "Customize keyboard shortcuts for common actions";
                                            font-size: 11px;
                                            color: #7f8c8d;
                                        }
                                    }
                                    
                                    if settings-category == "advanced" : VerticalBox {
                                        spacing: 10px;
                                        
                                        Text {
                                            text: "Advanced Options & Firmware Settings";
                                            font-size: 12px;
                                            font-weight: 700;
                                            color: #34495e;
                                        }
                                        
                                        // Dynamically render firmware settings from dialog
                                        VerticalBox {
                                            spacing: 2px;
                                            for setting[idx] in all-settings : Rectangle {
                                                height: 24px;
                                                
                                                if setting.category == "Advanced" : HorizontalBox {
                                                    alignment: start;
                                                    spacing: 8px;
                                                    
                                                    Text {
                                                        text: setting.name;
                                                        font-size: 10px;
                                                        color: #2c3e50;
                                                        width: 45%;
                                                    }
                                                    
                                                    // Display based on setting type
                                                    if setting.value-type == "Boolean" : CheckBox {
                                                        checked: setting.value == "true" || setting.value == "1";
                                                        toggled => {
                                                            root.update-setting(setting.id, self.checked ? "true" : "false");
                                                        }
                                                    }
                                                    
                                                    if setting.value-type != "Boolean" : LineEdit {
                                                        text: setting.value;
                                                        edited => {
                                                            root.update-setting(setting.id, self.text);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Button bar
                Rectangle {
                    height: 50px;
                    background: #ecf0f1;
                    border-width: 1px;
                    border-color: #bdc3c7;
                    
                    HorizontalBox {
                        padding: 10px;
                        spacing: 10px;
                        alignment: end;
                        
                        Button {
                            text: "Restore Defaults";
                            width: 120px;
                            height: 35px;
                            clicked => {
                                root.menu-settings-restore-defaults();
                            }
                        }
                        
                        Button {
                            text: "Cancel";
                            width: 80px;
                            height: 35px;
                            clicked => {
                                settings-dialog-visible = false;
                                root.menu-settings-cancel();
                            }
                        }
                        
                        Button {
                            text: "OK";
                            width: 80px;
                            height: 35px;
                            clicked => {
                                settings-dialog-visible = false;
                                root.menu-settings-save();
                            }
                        }
                    }
                }
            }
        }
    }
}
