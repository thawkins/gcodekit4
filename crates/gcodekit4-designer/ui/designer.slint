//! Designer Tool UI Panel  
//! Provides 2D CAD drawing interface with vertical toolbox and canvas interaction

import { Button, VerticalBox, HorizontalBox, ScrollView, CheckBox } from "std-widgets.slint";

component CompactSpinBox inherits Rectangle {
    in-out property <float> value;
    in property <float> minimum: 0;
    in property <float> maximum: 100;
    in property <float> step: 1.0;
    
    callback value-changed(float);
    
    background: white;
    border-width: 1px;
    border-color: #ccc;
    border-radius: 2px;
    
    HorizontalLayout {
        padding: 0px;
        spacing: 0px;
        
        Rectangle {
            horizontal-stretch: 1;
            
            text-input := TextInput {
                text: value;
                horizontal-alignment: center;
                vertical-alignment: center;
                font-size: 13px;
                
                edited => {
                    if (self.text != "") {
                        value = max(minimum, min(maximum, self.text.to-float()));
                        value-changed(value);
                    }
                }
            }
        }
        
        VerticalLayout {
            padding: 0px;
            spacing: 0px;
            width: 15px;
            
            Rectangle {
                height: 11px;
                background: up-touch.has-hover ? #e0e0e0 : #f5f5f5;
                border-width: 1px;
                border-color: #ccc;
                
                Text {
                    text: "▲";
                    font-size: 8px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                
                up-touch := TouchArea {
                    clicked => {
                        if (value < maximum) {
                            value = min(maximum, value + step);
                            value-changed(value);
                        }
                    }
                }
            }
            
            Rectangle {
                height: 11px;
                background: down-touch.has-hover ? #e0e0e0 : #f5f5f5;
                border-width: 1px;
                border-color: #ccc;
                
                Text {
                    text: "▼";
                    font-size: 8px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                
                down-touch := TouchArea {
                    clicked => {
                        if (value > minimum) {
                            value = max(minimum, value - step);
                            value-changed(value);
                        }
                    }
                }
            }
        }
    }
}

export struct DesignerShape {
    id: int,
    x: float,
    y: float,
    width: float,
    height: float,
    radius: float,
    x2: float,
    y2: float,
    shape_type: int,
    selected: bool,
    step_down: float,
    step_in: float,
}

export struct DesignerState {
    mode: int,
    zoom: float,
    pan_x: float,
    pan_y: float,
    selected_id: int,
}

component ToolButton inherits Rectangle {
    in property <int> tool_id;
    in property <int> current_mode;
    in property <string> icon_text;
    in property <string> tooltip;
    
    callback clicked;
    
    width: 48px;
    height: 48px;
    background: current_mode == tool_id ? #3498db : #2c3e50;
    border-width: 2px;
    border-color: current_mode == tool_id ? white : transparent;
    
    VerticalBox {
        alignment: center;
        Text {
            text: icon_text;
            font-size: 24px;
            horizontal-alignment: center;
            color: current_mode == tool_id ? white : #95a5a6;
        }
    }
    
    TouchArea {
        mouse-cursor: pointer;
        clicked => {
            root.clicked();
        }
    }
}

// Shape Properties Dialog
component ShapePropertiesDialog inherits Dialog {
    in-out property <bool> show: false;
    in property <int> shape_type: 0;
    in-out property <float> corner_radius: 5.0;
    in-out property <float> shape_x: 0.0;
    in-out property <float> shape_y: 0.0;
    in-out property <float> shape_w: 0.0;
    in-out property <float> shape_h: 0.0;
    in-out property <bool> is_pocket: false;
    in-out property <float> pocket_depth: 0.0;
    in-out property <float> step_down: 0.0;
    in-out property <float> step_in: 0.0;
    in-out property <string> text_content: "";
    in-out property <float> font_size: 12.0;
    
    callback save_properties();
    callback cancel_properties();
    
    width: 390px;
    height: shape_type == 5 ? 520px : 455px;
    
    VerticalBox {
        padding: 8px;
        spacing: 8px;
        
        Text {
            text: "Shape Properties";
            font-size: 16px;
            font-weight: 700;
        }
        
        ScrollView {
            vertical-stretch: 1;
            viewport-width: self.width;
            
            VerticalBox {
                padding: 0px;
                spacing: 8px;
                alignment: start;
                
                // Position controls
                HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    
                    Text {
                        text: "X Position (mm):";
                        vertical-alignment: center;
                        width: 120px;
                    }
                    
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        
                        CompactSpinBox {
                            width: 100%;
                            height: 100%;
                            value <=> shape_x;
                            minimum: -1000.0;
                            maximum: 1000.0;
                            step: 0.1;
                            
                            value-changed(val) => {
                                shape_x = val;
                            }
                        }
                    }
                }
                
                HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    
                    Text {
                        text: "Y Position (mm):";
                        vertical-alignment: center;
                        width: 120px;
                    }
                    
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        
                        CompactSpinBox {
                            width: 100%;
                            height: 100%;
                            value <=> shape_y;
                            minimum: -1000.0;
                            maximum: 1000.0;
                            step: 0.1;
                            
                            value-changed(val) => {
                                shape_y = val;
                            }
                        }
                    }
                }
                
                // Size controls
                HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    
                    Text {
                        text: "Width (mm):";
                        vertical-alignment: center;
                        width: 120px;
                    }
                    
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        
                        CompactSpinBox {
                            width: 100%;
                            height: 100%;
                            value <=> shape_w;
                            minimum: 0.1;
                            maximum: 1000.0;
                            step: 0.1;
                            
                            value-changed(val) => {
                                shape_w = val;
                            }
                        }
                    }
                }
                
                HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    
                    Text {
                        text: "Height (mm):";
                        vertical-alignment: center;
                        width: 120px;
                    }
                    
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        
                        CompactSpinBox {
                            width: 100%;
                            height: 100%;
                            value <=> shape_h;
                            minimum: 0.1;
                            maximum: 1000.0;
                            step: 0.1;
                            
                            value-changed(val) => {
                                shape_h = val;
                            }
                        }
                    }
                }
                
                // Only show corner radius for RoundRectangle (shape_type == 5) - REMOVED
                
                if shape_type == 6: VerticalBox {
                    spacing: 8px;
                    HorizontalBox {
                        spacing: 8px;
                        alignment: start;
                        Text { text: "Content:"; vertical-alignment: center; width: 120px; }
                        Rectangle {
                            width: 100px;
                            height: 30px;
                            border-width: 1px;
                            border-color: #ccc;
                            TextInput { 
                                width: 100%;
                                height: 100%;
                                text <=> text_content; 
                                vertical-alignment: center;
                            }
                        }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        alignment: start;
                        Text { text: "Font Size:"; vertical-alignment: center; width: 120px; }
                        Rectangle {
                            width: 100px;
                            height: 30px;
                            CompactSpinBox { 
                                width: 100%;
                                height: 100%;
                                value <=> font_size; 
                                minimum: 1.0; 
                                maximum: 1000.0; 
                            }
                        }
                    }
                }

                // Operation properties
                HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    CheckBox { text: "Pocket Operation"; checked <=> is_pocket; }
                }
                
                if is_pocket: HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    Text { text: "Pocket Depth:"; vertical-alignment: center; width: 120px; }
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        CompactSpinBox { 
                            width: 100%;
                            height: 100%;
                            value <=> pocket_depth; 
                            minimum: -100.0; 
                            maximum: 0.0; 
                        }
                    }
                }

                if is_pocket: HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    Text { text: "Step Down:"; vertical-alignment: center; width: 120px; }
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        CompactSpinBox { 
                            width: 100%;
                            height: 100%;
                            value <=> step_down; 
                            minimum: 0.1; 
                            maximum: 100.0; 
                        }
                    }
                }

                if is_pocket: HorizontalBox {
                    spacing: 8px;
                    alignment: start;
                    Text { text: "Step In:"; vertical-alignment: center; width: 120px; }
                    Rectangle {
                        width: 100px;
                        height: 30px;
                        CompactSpinBox { 
                            width: 100%;
                            height: 100%;
                            value <=> step_in; 
                            minimum: 0.1; 
                            maximum: 100.0; 
                        }
                    }
                }
            }
        }
        
        HorizontalBox {
            spacing: 8px;
            alignment: end;
            
            Button {
                text: "Save";
                clicked => {
                    root.save_properties();
                }
            }
            
            Button {
                text: "Cancel";
                clicked => {
                    root.cancel_properties();
                }
            }
        }
    }
}

// Context Menu for shapes
component ContextMenu inherits Rectangle {
    in-out property <bool> show: false;
    in-out property <float> menu_x: 0;
    in-out property <float> menu_y: 0;
    
    callback menu_delete();
    callback menu_properties();
    
    width: 150px;
    height: 60px;
    x: root.menu_x * 1px;
    y: root.menu_y * 1px;
    background: white;
    border-width: 1px;
    border-color: #ccc;
    drop-shadow-blur: 4px;
    drop-shadow-color: #00000040;
    
    VerticalBox {
        padding: 2px;
        spacing: 0px;
        
        Rectangle {
            height: 28px;
            background: menu-item-1.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Delete";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-1 := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_delete();
                }
            }
        }
        
        Rectangle {
            height: 28px;
            background: menu-item-2.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Properties...";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-2 := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_properties();
                }
            }
        }
    }
}

export component DesignerPanel inherits VerticalBox {
    spacing: 0px;
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    
    in property <[DesignerShape]> shapes: [];
    in property <DesignerState> designer_state;
    in-out property <float> feed_rate;
    in-out property <float> spindle_speed;
    in-out property <float> tool_diameter;
    in-out property <float> cut_depth;
    in-out property <float> step_in;
    in property <string> generated_gcode: "";
    in property <bool> gcode_generated: false;
    in property <float> zoom_scale: 1.0;
    in property <float> x_offset: 0.0;
    in property <float> y_offset: 0.0;
    in property <string> canvas_crosshair_data: "";
    in property <string> canvas_shapes_data: "";
    in property <string> canvas_selected_shapes_data: "";
    in property <string> canvas_handles_data: "";
    out property <float> canvas-width: canvas-rect.width / 1px;
    out property <float> canvas-height: canvas-rect.height / 1px;
    in property <float> selected_shape_x: 0.0;
    in property <float> selected_shape_y: 0.0;
    in property <float> selected_shape_w: 0.0;
    in property <float> selected_shape_h: 0.0;
    in property <int> selected_shape_type: 0;
    in property <float> selected_shape_radius: 5.0;
    in property <bool> selected_shape_is_pocket: false;
    in property <float> selected_shape_pocket_depth: 0.0;
    in property <float> selected_shape_step_down: 0.0;
    in property <float> selected_shape_step_in: 0.0;
    in property <string> selected_shape_text_content: "";
    in property <float> selected_shape_font_size: 12.0;
    
    callback set_mode(int);
    callback zoom_in();
    callback zoom_out();
    callback zoom_fit();
    callback reset_view();
    callback delete_selected();
    callback clear_canvas();
    callback generate_toolpath();
    callback update_feed_rate(float);
    callback update_spindle_speed(float);
    callback update_tool_diameter(float);
    callback update_cut_depth(float);
    callback update_step_in(float);
    callback import_dxf();
    callback import_svg();
    callback export_design();
    callback canvas_click(float, float);
    callback detect_handle(float, float) -> int;  // x, y - returns handle index (-1 if not on handle)
    callback shape_drag(int, float, float);        // shape_id, dx, dy
    callback handle_drag(int, int, float, float);  // shape_id, handle_index, dx, dy
    callback canvas_pan(float, float);             // dx, dy - pan the viewport
    callback deselect_all();
    callback set_shift_pressed(bool);              // Notify backend of Shift key state
    callback show_context_menu(float, float);      // x, y - show context menu
    callback save_shape_properties();              // Save all properties from current dialog values
    callback update_shape_property(int, float);    // property_id, value (0=x, 1=y, 2=w, 3=h, 4=radius, 5=pocket_depth, 6=font_size, 7=step_down)
    callback update_shape_property_bool(int, bool); // property_id, value (0=is_pocket)
    callback update_shape_property_string(int, string); // property_id, value (0=text_content)
    
    // File operation callbacks
    callback file_new();
    callback file_open();
    callback file_save();
    callback file_save_as();
    
    // Context menu and dialog state
    private property <bool> context_menu_visible: false;
    private property <float> context_menu_x: 0;
    private property <float> context_menu_y: 0;
    private property <bool> properties_dialog_visible: false;
    private property <float> current_corner_radius: 5.0;
    private property <float> current_shape_x: 0.0;
    private property <float> current_shape_y: 0.0;
    private property <float> current_shape_w: 0.0;
    private property <float> current_shape_h: 0.0;
    private property <bool> is_pocket: false;
    private property <float> pocket_depth: 0.0;
    private property <float> step_down: 0.0;
    private property <string> text_content: "";
    private property <float> font_size: 12.0;
    
    // Track last delta sent to backend (per shape) to compute incremental changes
    private property <float> drag_start_x: 0.0;
    private property <float> drag_start_y: 0.0;
    private property <float> drag_last_dx: 0.0;
    private property <float> drag_last_dy: 0.0;
    private property <int> dragging_shape_id: -1;
    private property <int> dragging_handle: -1;
    private property <bool> drag_occurred: false;
    private property <int> hovered_handle: -1;  // Track which handle we're hovering over
    private property <bool> drag_start_initialized: false;  // Track if drag_start has been set for current press
    private property <bool> shift_pressed: false;  // Track if Shift key is held
    
    // Main layout: vertical toolbox on left, canvas and properties on right
    FocusScope {
        width: 100%;
        height: 100%;
        
        key-pressed(event) => {
            if event.text == Key.Escape {
                deselect_all();
                accept
            } else if event.text == Key.Delete {
                delete_selected();
                accept
            } else if event.text == Key.Shift {
                root.shift_pressed = true;
                set_shift_pressed(true);
                accept
            } else {
                reject
            }
        }
        
        key-released(event) => {
            if event.text == Key.Shift {
                root.shift_pressed = false;
                set_shift_pressed(false);
                accept
            } else {
                reject
            }
        }
        
        HorizontalBox {
            spacing: 2px;
        
        // ═════════════════════════════════════════════
        // LEFT SIDEBAR: Tool Icons in 2-Column Grid
        // ═════════════════════════════════════════════
        VerticalBox {
            preferred-width: 110px;
            horizontal-stretch: 0;
            spacing: 0px;
            alignment: start;
            
            // File Operations Section (4 buttons in 2x2 grid)
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                Button {
                    text: "New";
                    width: 50px;
                    height: 40px;
                    clicked => { file_new(); }
                }
                Button {
                    text: "Open";
                    width: 50px;
                    height: 40px;
                    clicked => { file_open(); }
                }
            }
            
            HorizontalBox {
                spacing: 2px;
                padding-left: 2px;
                padding-right: 2px;
                padding-bottom: 2px;
                
                Button {
                    text: "Save";
                    width: 50px;
                    height: 40px;
                    clicked => { file_save(); }
                }
                Button {
                    text: "Save As";
                    width: 50px;
                    height: 40px;
                    clicked => { file_save_as(); }
                }
            }
            
            // Separator
            Rectangle {
                height: 1px;
                background: #cccccc;
            }
            
            // Drawing Tools Section (6 buttons in 2x3 grid)
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                ToolButton {
                    tool_id: 0;
                    current_mode: designer_state.mode;
                    icon_text: "➜";
                    tooltip: "Select (S)";
                    clicked => { set_mode(0); }
                }
                ToolButton {
                    tool_id: 1;
                    current_mode: designer_state.mode;
                    icon_text: "▭";
                    tooltip: "Rectangle (R)";
                    clicked => { set_mode(1); }
                }
            }
            
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                ToolButton {
                    tool_id: 2;
                    current_mode: designer_state.mode;
                    icon_text: "●";
                    tooltip: "Circle (C)";
                    clicked => { set_mode(2); }
                }
                ToolButton {
                    tool_id: 3;
                    current_mode: designer_state.mode;
                    icon_text: "/";
                    tooltip: "Line (L)";
                    clicked => { set_mode(3); }
                }
            }
            
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                ToolButton {
                    tool_id: 4;
                    current_mode: designer_state.mode;
                    icon_text: "◯";
                    tooltip: "Ellipse (E)";
                    clicked => { set_mode(4); }
                }
                ToolButton {
                    tool_id: 5;
                    current_mode: designer_state.mode;
                    icon_text: "⬠";
                    tooltip: "Polygon (P)";
                    clicked => { set_mode(5); }
                }
            }
            
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                ToolButton {
                    tool_id: 6;
                    current_mode: designer_state.mode;
                    icon_text: "T";
                    tooltip: "Text (T)";
                    clicked => { set_mode(6); }
                }
                Rectangle { width: 48px; height: 48px; } // Placeholder for removed tool
            }
            
            // Separator
            Rectangle {
                height: 1px;
                background: #cccccc;
            }
            
            // View Controls (4 buttons in 2x2 grid)
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                Button {
                    text: "+";
                    width: 50px;
                    height: 40px;
                    clicked => { zoom_in(); }
                }
                Button {
                    text: "-";
                    width: 50px;
                    height: 40px;
                    clicked => { zoom_out(); }
                }
            }
            
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                Button {
                    text: "⊡";
                    width: 50px;
                    height: 40px;
                    clicked => { zoom_fit(); }
                }
                Button {
                    text: "⌂";
                    width: 50px;
                    height: 40px;
                    clicked => { reset_view(); }
                }
            }
            
            // Separator
            Rectangle {
                height: 1px;
                background: #cccccc;
            }
            
            // Edit Controls (2 buttons in 2x1 grid)
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                Button {
                    text: "✗";
                    width: 50px;
                    height: 40px;
                    clicked => { delete_selected(); }
                }
                Button {
                    text: "⊕";
                    width: 50px;
                    height: 40px;
                    clicked => { clear_canvas(); }
                }
            }
            
            // Separator
            Rectangle {
                height: 1px;
                background: #cccccc;
            }
            
            // Import/Export Controls (3 buttons in 2x2 grid, last empty)
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                Button {
                    text: "DXF";
                    width: 50px;
                    height: 40px;
                    clicked => { import_dxf(); }
                }
                Button {
                    text: "SVG";
                    width: 50px;
                    height: 40px;
                    clicked => { import_svg(); }
                }
            }
            
            HorizontalBox {
                spacing: 2px;
                padding: 2px;
                
                Button {
                    text: "⇩";
                    width: 50px;
                    height: 40px;
                    clicked => { export_design(); }
                }
                Rectangle { }
            }
            
            // Spacer to push content to top
            VerticalBox { }
        }
        
        // ═════════════════════════════════════════════
        // CENTER: Canvas Area
        // ═════════════════════════════════════════════
        VerticalBox {
            horizontal-stretch: 1;
            
            // Canvas Info Indicator
            Rectangle {
                height: 25px;
                background: white;
                border-width: 1px;
                border-color: #cccccc;
                
                HorizontalBox {
                    padding-left: 8px;
                    padding-right: 8px;
                    padding-top: 4px;
                    padding-bottom: 4px;
                    spacing: 0px;
                    alignment: start;
                    
                    // Zoom Scale
                    Text {
                        text: "Scale: " + Math.round(zoom_scale * 1000.0) / 10.0 + "%";
                        font-size: 13px;
                        font-weight: 700;
                        color: black;
                    }
                    
                    // Spacer
                    Rectangle { width: 20px; }
                    
                    // X Offset
                    Text {
                        text: "X: " + Math.round(x_offset * 10.0) / 10.0;
                        font-size: 13px;
                        color: black;
                    }
                    
                    // Spacer
                    Rectangle { width: 20px; }
                    
                    // Y Offset
                    Text {
                        text: "Y: " + Math.round(y_offset * 10.0) / 10.0;
                        font-size: 13px;
                        color: black;
                    }
                    
                    // Spacer before shape indicator
                    if designer_state.selected_id > 0 : Rectangle {
                        width: 20px;
                    }
                    
                    // Shape Indicator (X, Y, W, H) - shown only when shape is selected
                    if designer_state.selected_id > 0 : Text {
                        text: "| Shape: X=" + Math.round(root.selected_shape_x * 10.0) / 10.0 + 
                              " Y=" + Math.round(root.selected_shape_y * 10.0) / 10.0 +
                              " W=" + Math.round(root.selected_shape_w * 10.0) / 10.0 +
                              " H=" + Math.round(root.selected_shape_h * 10.0) / 10.0;
                        font-size: 13px;
                        color: #2980b9;
                        font-weight: 700;
                    }
                }
            }
            
            // Canvas with interactive area
            Rectangle {
                background: #2c3e50;
                vertical-stretch: 1;
                
                VerticalBox {
                    Rectangle {
                        vertical-stretch: 1;
                        background: #34495e;
                        
                        // Wrap canvas in FocusScope to enable mouse wheel handling
                        canvas_focus := FocusScope {
                            key-pressed(event) => {
                                if event.text == "+" || event.text == "=" {
                                    zoom_in();
                                    return accept;
                                } else if event.text == "-" {
                                    zoom_out();
                                    return accept;
                                } else if event.text == Key.Shift {
                                    root.shift_pressed = true;
                                    set_shift_pressed(true);
                                    return accept;
                                }
                                reject
                            }
                            
                            key-released(event) => {
                                if event.text == Key.Shift {
                                    root.shift_pressed = false;
                                    set_shift_pressed(false);
                                    return accept;
                                }
                                reject
                            }
                            
                            // Display rendered canvas using SVG paths
                            canvas-rect := Rectangle {
                                width: 100%;
                                height: 100%;
                                clip: true;
                                background: #34495e;
                            
                            Rectangle {
                                width: 100%;
                                height: 100%;
                                
                                // Crosshair layer (yellow)
                                if root.canvas_crosshair_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: yellow;
                                    stroke-width: 2px;
                                    commands: root.canvas_crosshair_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Normal shapes layer (blue)
                                if root.canvas_shapes_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #3498db;
                                    stroke-width: 2px;
                                    commands: root.canvas_shapes_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Selected shapes layer (yellow)
                                if root.canvas_selected_shapes_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #ffeb3b;
                                    stroke-width: 3px;
                                    commands: root.canvas_selected_shapes_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Selection handles layer (yellow filled squares)
                                if root.canvas_handles_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: #ffeb3b;
                                    stroke: black;
                                    stroke-width: 1px;
                                    commands: root.canvas_handles_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Interactive layer on top of canvas
                                TouchArea {
                                    width: 100%;
                                    height: 100%;
                                    mouse-cursor: 
                                        designer_state.mode == 0 ? (
                                            root.hovered_handle == 0 || root.hovered_handle == 2 ? ns-resize :
                                            root.hovered_handle == 1 || root.hovered_handle == 3 ? ew-resize :
                                            root.dragging_shape_id >= 0 || (root.hovered_handle == 4 && designer_state.selected_id > 0) ? move :
                                            default
                                        ) :
                                        designer_state.mode == 1 ? crosshair :
                                        designer_state.mode == 2 ? crosshair :
                                        designer_state.mode == 3 ? crosshair :
                                        designer_state.mode == 4 ? crosshair :
                                        designer_state.mode == 5 ? crosshair :
                                        designer_state.mode == 6 ? crosshair :
                                        default;
                                    
                                    clicked => {
                                        // Don't handle click if a drag just occurred
                                        if !root.drag_occurred {
                                            // Direct mouse coordinates (no scroll offset)
                                            let adjusted_x = self.mouse-x / 1px;
                                            let adjusted_y = self.mouse-y / 1px;
                                            canvas_click(adjusted_x, adjusted_y);
                                        }
                                        root.drag_occurred = false;
                                    }
                                    
                                    // Detect handle on press down
                                    pointer-event(event) => {
                                        if event.kind == PointerEventKind.down {
                                            // Handle right-click for context menu
                                            if event.button == PointerEventButton.right {
                                                if designer_state.selected_id > 0 {
                                                    root.context_menu_x = self.mouse-x / 1px;
                                                    root.context_menu_y = self.mouse-y / 1px;
                                                    root.context_menu_visible = true;
                                                }
                                                return;
                                            }
                                            
                                            // Hide context menu on left click
                                            root.context_menu_visible = false;
                                            
                                            // Ensure FocusScope has focus so key events are captured
                                            canvas_focus.focus();
                                            if designer_state.mode == 0 {
                                                // Ask backend to detect which handle (if any) we're on
                                                let adjusted_x = self.pressed-x / 1px;
                                                let adjusted_y = self.pressed-y / 1px;
                                                root.dragging_handle = detect_handle(adjusted_x, adjusted_y);
                                                // Reset drag tracking for new press
                                                root.drag_start_initialized = false;
                                            }
                                        }
                                    }
                                    
                                    // Track mouse movement - detect dragging and hover
                                    moved => {
                                        if designer_state.mode == 0 {
                                            // Check which handle we're hovering over
                                            let adjusted_x = self.mouse-x / 1px;
                                            let adjusted_y = self.mouse-y / 1px;
                                            root.hovered_handle = detect_handle(adjusted_x, adjusted_y);
                                        }
                                        
                                        if designer_state.mode == 0 && self.pressed {
                                            // Initialize drag start on first move while pressed
                                            if !root.drag_start_initialized {
                                                root.drag_start_x = self.pressed-x / 1px;
                                                root.drag_start_y = self.pressed-y / 1px;
                                                root.drag_start_initialized = true;
                                                root.drag_last_dx = 0.0;
                                                root.drag_last_dy = 0.0;
                                            }
                                            
                                            let total_dx = (self.mouse-x / 1px - root.drag_start_x);
                                            let total_dy = (self.mouse-y / 1px - root.drag_start_y);
                                            let inc_dx = total_dx - root.drag_last_dx;
                                            let inc_dy = total_dy - root.drag_last_dy;
                                            
                                            if abs(inc_dx) > 0.5 || abs(inc_dy) > 0.5 {
                                                if root.dragging_handle >= 0 && root.dragging_handle <= 3 {
                                                    // Dragging a resize handle (0-3)
                                                    // Use current selected_id, not cached dragging_shape_id
                                                    handle_drag(designer_state.selected_id, root.dragging_handle, inc_dx, inc_dy);
                                                    root.drag_occurred = true;
                                                } else if root.dragging_handle == 4 || (root.dragging_handle == -1 && designer_state.selected_id > 0) {
                                                    // Dragging the shape itself (move) - handle is -1 or 4 (center)
                                                    handle_drag(designer_state.selected_id, root.dragging_handle, inc_dx, inc_dy);
                                                    root.drag_occurred = true;
                                                } else if root.dragging_handle == -1 && designer_state.selected_id == 0 {
                                                    // No shape selected - pan the canvas
                                                    canvas_pan(inc_dx, inc_dy);
                                                    root.drag_occurred = true;
                                                }
                                                root.drag_last_dx = total_dx;
                                                root.drag_last_dy = total_dy;
                                            }
                                        } else if !self.pressed {
                                            // Reset when not pressed
                                            root.drag_last_dx = 0.0;
                                            root.drag_last_dy = 0.0;
                                            root.drag_start_initialized = false;
                                            root.dragging_handle = -1;
                                            root.dragging_shape_id = -1;
                                        }
                                    }
                                }
                            }
                        }
                        }
                    }
                }
            }
        }
        
        // ═════════════════════════════════════════════
        // RIGHT SIDEBAR: Properties Panel (Scrollable)
        // ═════════════════════════════════════════════
        ScrollView {
            preferred-width: 160px;
            max-width: 160px;
            horizontal-stretch: 0;
            
            Rectangle {
                background: #ecf0f1;
                width: 160px;
                
                VerticalBox {
                    spacing: 6px;
                    padding: 6px;
                    width: 100%;
                    
                    Text {
                        text: "Tool Setup";
                        font-weight: 700;
                        font-size: 11px;
                    }
                    
                    HorizontalBox {
                        spacing: 2px;
                        width: 100%;
                        Text { 
                            text: "Feed:"; 
                            font-size: 11px;
                            width: 50px;
                            vertical-alignment: center;
                        }
                        CompactSpinBox { 
                            value: root.feed_rate; 
                            minimum: 0;
                            maximum: 10000;
                            step: 10;
                            horizontal-stretch: 1;
                            height: 22px;
                            value-changed(v) => {
                                root.feed_rate = v;
                                root.update_feed_rate(v);
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 2px;
                        width: 100%;
                        Text { 
                            text: "Speed:"; 
                            font-size: 11px;
                            width: 50px;
                            vertical-alignment: center;
                        }
                        CompactSpinBox { 
                            value: root.spindle_speed;
                            minimum: 0;
                            maximum: 30000;
                            step: 100;
                            horizontal-stretch: 1;
                            height: 22px;
                            value-changed(v) => {
                                root.spindle_speed = v;
                                root.update_spindle_speed(v);
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 2px;
                        width: 100%;
                        Text { 
                            text: "Tool:"; 
                            font-size: 11px;
                            width: 50px;
                            vertical-alignment: center;
                        }
                        CompactSpinBox { 
                            value: root.tool_diameter;
                            minimum: 0;
                            maximum: 50;
                            step: 0.1;
                            horizontal-stretch: 1;
                            height: 22px;
                            value-changed(v) => {
                                root.tool_diameter = v;
                                root.update_tool_diameter(v);
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 2px;
                        width: 100%;
                        Text { 
                            text: "Depth:"; 
                            font-size: 11px;
                            width: 50px;
                            vertical-alignment: center;
                        }
                        CompactSpinBox { 
                            value: root.cut_depth;
                            minimum: -100;
                            maximum: 0;
                            step: 0.1;
                            horizontal-stretch: 1;
                            height: 22px;
                            value-changed(v) => {
                                root.cut_depth = v;
                                root.update_cut_depth(v);
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 2px;
                        width: 100%;
                        Text { 
                            text: "Step In:"; 
                            font-size: 11px;
                            width: 50px;
                            vertical-alignment: center;
                        }
                        CompactSpinBox { 
                            value: root.step_in;
                            minimum: 0.1;
                            maximum: 50;
                            step: 0.1;
                            horizontal-stretch: 1;
                            height: 22px;
                            value-changed(v) => {
                                root.step_in = v;
                                root.update_step_in(v);
                            }
                        }
                    }
                    
                    Rectangle { height: 2px; }
                    
                    Text {
                        text: "G-Code";
                        font-weight: 700;
                        font-size: 11px;
                    }
                    
                    Button {
                        text: "Generate";
                        width: 100%;
                        clicked => { generate_toolpath(); }
                    }
                    
                    Text {
                        text: gcode_generated ? "✓ Ready" : "⊘ None";
                        font-size: 8px;
                        color: gcode_generated ? #2ecc71 : #e74c3c;
                        horizontal-alignment: center;
                    }
                    
                    VerticalBox { }
                }
            }
        }
    }
    
    // Context menu overlay (on top of everything)
    if root.context_menu_visible: ContextMenu {
        show <=> root.context_menu_visible;
        menu_x: root.context_menu_x;
        menu_y: root.context_menu_y;
        
        menu_delete => {
            delete_selected();
        }
        
        menu_properties => {
            root.properties_dialog_visible = true;
            root.current_corner_radius = root.selected_shape_radius;
            root.current_shape_x = root.selected_shape_x;
            root.current_shape_y = root.selected_shape_y;
            root.current_shape_w = root.selected_shape_w;
            root.current_shape_h = root.selected_shape_h;
            root.is_pocket = root.selected_shape_is_pocket;
            root.pocket_depth = root.selected_shape_pocket_depth;
            root.step_down = root.selected_shape_step_down;
            root.step_in = root.selected_shape_step_in;
            root.text_content = root.selected_shape_text_content;
            root.font_size = root.selected_shape_font_size;
        }
    }
    
    // Properties dialog overlay
    if root.properties_dialog_visible: Rectangle {
        width: 100%;
        height: 100%;
        background: #00000080;
        
        TouchArea {
            clicked => {
                root.properties_dialog_visible = false;
            }
        }
        
        ShapePropertiesDialog {
            show <=> root.properties_dialog_visible;
            shape_type: root.selected_shape_type;
            corner_radius <=> root.current_corner_radius;
            shape_x <=> root.current_shape_x;
            shape_y <=> root.current_shape_y;
            shape_w <=> root.current_shape_w;
            shape_h <=> root.current_shape_h;
            is_pocket <=> root.is_pocket;
            pocket_depth <=> root.pocket_depth;
            step_down <=> root.step_down;
            text_content <=> root.text_content;
            font_size <=> root.font_size;
            
            save_properties => {
                update_shape_property(0, root.current_shape_x);
                update_shape_property(1, root.current_shape_y);
                update_shape_property(2, root.current_shape_w);
                update_shape_property(3, root.current_shape_h);
                update_shape_property(4, root.current_corner_radius);
                update_shape_property_bool(0, root.is_pocket);
                update_shape_property(5, root.pocket_depth);
                update_shape_property(7, root.step_down);
                update_shape_property(8, root.step_in);
                update_shape_property_string(0, root.text_content);
                update_shape_property(6, root.font_size);
                save_shape_properties();
                root.properties_dialog_visible = false;
            }
            
            cancel_properties => {
                root.properties_dialog_visible = false;
            }
        }
    }
    }
}
