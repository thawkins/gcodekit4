//! Designer Tool UI Panel  
//! Provides 2D CAD drawing interface with vertical toolbox and canvas interaction

import { Button, VerticalBox, HorizontalBox, ScrollView, CheckBox, ComboBox } from "std-widgets.slint";
import { StandardButton, StandardTooltip } from "../../gcodekit4-ui/ui/ui_components/shared.slint";
import { Theme } from "../../gcodekit4-ui/ui/theme.slint";

component DarkCheckBox inherits HorizontalLayout {
    in-out property <bool> checked;
    in property <string> text;
    callback toggled;
    
    spacing: 4px;
    
    Rectangle {
        width: 16px; height: 16px;
        border-width: 1px;
        border-color: #bdc3c7;
        background: root.checked ? #3498db : transparent;
        y: (parent.height - self.height) / 2;
        
        if root.checked : Text {
            text: "✓";
            color: white;
            font-size: 12px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
        
        TouchArea { clicked => { root.checked = !root.checked; root.toggled(); } }
    }
    
    Text {
        text: root.text;
        color: #ecf0f1;
        vertical-alignment: center;
    }
    
    TouchArea { clicked => { root.checked = !root.checked; root.toggled(); } }
}

component CompactSpinBox inherits Rectangle {
    in-out property <float> value;
    in property <float> minimum: 0;
    in property <float> maximum: 100;
    in property <float> step: 1.0;
    in property <bool> enabled: true;
    
    callback value-changed(float);
    
    background: enabled ? #34495e : #2c3e50;
    border-width: 1px;
    border-color: #555;
    border-radius: 2px;
    
    HorizontalLayout {
        padding: 0px;
        spacing: 0px;
        
        Rectangle {
            horizontal-stretch: 1;
            
            text-input := TextInput {
                text: Math.round(value * 100.0) / 100.0;
                horizontal-alignment: center;
                vertical-alignment: center;
                font-size: 13px;
                enabled: root.enabled;
                color: root.enabled ? #ecf0f1 : #7f8c8d;
                
                edited => {
                    if (self.text != "") {
                        value = max(minimum, min(maximum, self.text.to-float()));
                        value-changed(value);
                    }
                }
            }
        }
        
        VerticalLayout {
            padding: 0px;
            spacing: 0px;
            width: 15px;
            
            Rectangle {
                height: 11px;
                background: up-touch.has-hover && root.enabled ? #465c71 : #2c3e50;
                border-width: 1px;
                border-color: #555;
                
                Text {
                    text: "▲";
                    font-size: 8px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    color: root.enabled ? #bdc3c7 : #555;
                }
                
                up-touch := TouchArea {
                    enabled: root.enabled;
                    clicked => {
                        if (value < maximum) {
                            value = min(maximum, value + step);
                            value-changed(value);
                        }
                    }
                }
            }
            
            Rectangle {
                height: 11px;
                background: down-touch.has-hover && root.enabled ? #465c71 : #2c3e50;
                border-width: 1px;
                border-color: #555;
                
                Text {
                    text: "▼";
                    font-size: 8px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    color: root.enabled ? #bdc3c7 : #555;
                }
                
                down-touch := TouchArea {
                    enabled: root.enabled;
                    clicked => {
                        if (value > minimum) {
                            value = max(minimum, value - step);
                            value-changed(value);
                        }
                    }
                }
            }
        }
    }
}

export struct DesignerShape {
    id: int,
    group_id: int,
    name: string,
    x: float,
    y: float,
    width: float,
    height: float,
    radius: float,
    corner_radius: float,
    is_slot: bool,
    x2: float,
    y2: float,
    shape_type: int,
    selected: bool,
    step_down: float,
    step_in: float,
    pocket_strategy: int,
    raster_angle: float,
    bidirectional: bool,
    use_custom_values: bool,
}

export struct DesignerState {
    mode: int,
    zoom: float,
    pan_x: float,
    pan_y: float,
    selected_id: int,
    can_undo: bool,
    can_redo: bool,
    can_group: bool,
    can_ungroup: bool,
}

component ToolButton inherits Rectangle {
    in property <int> tool_id;
    in property <int> current_mode;
    in property <image> icon;
    in property <string> tooltip;
    
    callback clicked;
    
    width: 48px;
    height: 48px;
    background: current_mode == tool_id ? #3498db : #2c3e50;
    border-width: 2px;
    border-color: current_mode == tool_id ? white : transparent;
    
    Image {
        source: icon;
        width: 24px;
        height: 24px;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        colorize: current_mode == tool_id ? white : #95a5a6;
    }
    
    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => {
            root.clicked();
        }
    }
    
    StandardTooltip {
        text: root.tooltip;
        show: touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2;
    }
}

// Shape Properties Dialog
component DeleteConfirmationDialog inherits Dialog {
    in property <int> count: 0;
    callback confirm();
    callback cancel();
    
    width: 300px;
    height: 150px;
    
    VerticalBox {
        padding: 20px;
        spacing: 20px;
        alignment: center;
        
        Text {
            text: "Delete " + count + " selected shapes?";
            font-size: 16px;
            horizontal-alignment: center;
            wrap: word-wrap;
        }
        
        HorizontalBox {
            alignment: center;
            spacing: 20px;
            
            StandardButton {
                text: "Continue";
                width: 100px;
                primary: true;
                tooltip: "Confirm Deletion";
                clicked => { root.confirm(); }
            }
            StandardButton {
                text: "Cancel";
                width: 100px;
                tooltip: "Cancel Deletion";
                clicked => { root.cancel(); }
            }
        }
    }
}


// Context Menu for shapes
component ContextMenu inherits Rectangle {
    in-out property <bool> show: false;
    in-out property <float> menu_x: 0;
    in-out property <float> menu_y: 0;
    in property <bool> align-enabled: false;
    in property <bool> has-selection: false;
    in property <bool> can-group: false;
    in property <bool> can-ungroup: false;
    
    callback menu_delete();

    callback menu_copy();
    callback menu_paste();
    callback menu_group();
    callback menu_ungroup();
    callback align_horizontal_left();
    callback align_horizontal_center();
    callback align_horizontal_right();
    callback align_vertical_top();
    callback align_vertical_center();
    callback align_vertical_bottom();
    
    private property <bool> align_submenu_visible: false;
    private property <bool> horizontal_submenu_visible: false;
    private property <bool> vertical_submenu_visible: false;
    private property <length> item_height: 28px;
    private property <length> align_item_y: root.item_height * 4;
    
    width: 150px;
    height: (1 + (root.has-selection ? 4 : 0) + (root.can-group ? 1 : 0) + (root.can-ungroup ? 1 : 0)) * root.item_height + 4px;
    x: root.menu_x * 1px;
    y: root.menu_y * 1px;
    background: white;
    border-width: 1px;
    border-color: #ccc;
    drop-shadow-blur: 4px;
    drop-shadow-color: #00000040;
    
    changed show => {
        if (!root.show) {
            root.align_submenu_visible = false;
            root.horizontal_submenu_visible = false;
            root.vertical_submenu_visible = false;
        }
    }
    
    VerticalBox {
        padding: 2px;
        spacing: 0px;
        
        if root.has-selection : Rectangle {
            height: root.item_height;
            background: menu-item-copy.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Copy";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-copy := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_copy();
                }
            }
        }

        Rectangle {
            height: root.item_height;
            background: menu-item-paste.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Paste";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-paste := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_paste();
                }
            }
        }
        
        if root.can-group : Rectangle {
            height: root.item_height;
            background: menu-item-group.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Group";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-group := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_group();
                }
            }
        }

        if root.can-ungroup : Rectangle {
            height: root.item_height;
            background: menu-item-ungroup.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Ungroup";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-ungroup := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_ungroup();
                }
            }
        }

        if root.has-selection : Rectangle {
            height: root.item_height;
            background: menu-item-1.has-hover ? #e0e0e0 : transparent;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                
                Text {
                    text: "Delete";
                    vertical-alignment: center;
                    font-size: 13px;
                }
            }
            
            menu-item-1 := TouchArea {
                clicked => {
                    root.show = false;
                    root.menu_delete();
                }
            }
        }
        

        
        if root.has-selection : Rectangle {
            height: root.item_height;
            background: menu-item-3.has-hover && root.align-enabled ? #e0e0e0 : transparent;
            opacity: root.align-enabled ? 1.0 : 0.4;
            
            HorizontalBox {
                padding-left: 10px;
                padding-right: 10px;
                spacing: 6px;
                
                Text {
                    text: "Align";
                    vertical-alignment: center;
                    font-size: 13px;
                    color: root.align-enabled ? #000 : #888;
                }
                Text {
                    text: "▸";
                    vertical-alignment: center;
                    font-size: 12px;
                    color: root.align-enabled ? #000 : #888;
                }
            }
            
            menu-item-3 := TouchArea {
                enabled: root.align-enabled;
                clicked => {
                    root.align_submenu_visible = !root.align_submenu_visible;
                    if (!root.align_submenu_visible) {
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
        }
    }
    
    if root.align_submenu_visible: Rectangle {
        width: 140px;
        height: root.item_height * 2;
        x: root.width - 2px;
        y: root.align_item_y;
        background: white;
        border-width: 1px;
        border-color: #ccc;
        drop-shadow-blur: 4px;
        drop-shadow-color: #00000040;
        
        VerticalBox {
            spacing: 0px;
            padding: 0px;
            
            Rectangle {
                height: root.item_height;
                background: horizontal-item.has-hover ? #e0e0e0 : transparent;
                
                HorizontalBox {
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 6px;
                    
                    Text {
                        text: "Horizontal";
                        vertical-alignment: center;
                        font-size: 13px;
                    }
                    Text {
                        text: "▸";
                        vertical-alignment: center;
                        font-size: 12px;
                    }
                }
                
                horizontal-item := TouchArea {
                    clicked => {
                        root.horizontal_submenu_visible = true;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
            
            Rectangle {
                height: root.item_height;
                background: vertical-item.has-hover ? #e0e0e0 : transparent;
                
                HorizontalBox {
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 6px;
                    
                    Text {
                        text: "Verticle";
                        vertical-alignment: center;
                        font-size: 13px;
                    }
                    Text {
                        text: "▸";
                        vertical-alignment: center;
                        font-size: 12px;
                    }
                }
                
                vertical-item := TouchArea {
                    clicked => {
                        root.vertical_submenu_visible = true;
                        root.horizontal_submenu_visible = false;
                    }
                }
            }
        }
    }
    
    if root.horizontal_submenu_visible: Rectangle {
        width: 140px;
        height: root.item_height * 3;
        x: root.width + 138px;
        y: root.align_item_y;
        background: white;
        border-width: 1px;
        border-color: #ccc;
        drop-shadow-blur: 4px;
        drop-shadow-color: #00000040;
        
        VerticalBox {
            spacing: 0px;
            padding: 0px;
            
            Rectangle {
                height: root.item_height;
                background: horiz-left.has-hover ? #e0e0e0 : transparent;
                HorizontalBox {
                    padding-left: 10px;
                    Text { text: "Left"; vertical-alignment: center; font-size: 13px; }
                }
                horiz-left := TouchArea {
                    clicked => {
                        root.align_horizontal_left();
                        root.show = false;
                        root.align_submenu_visible = false;
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
            Rectangle {
                height: root.item_height;
                background: horiz-center.has-hover ? #e0e0e0 : transparent;
                HorizontalBox {
                    padding-left: 10px;
                    Text { text: "Center"; vertical-alignment: center; font-size: 13px; }
                }
                horiz-center := TouchArea {
                    clicked => {
                        root.align_horizontal_center();
                        root.show = false;
                        root.align_submenu_visible = false;
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
            Rectangle {
                height: root.item_height;
                background: horiz-right.has-hover ? #e0e0e0 : transparent;
                HorizontalBox {
                    padding-left: 10px;
                    Text { text: "Right"; vertical-alignment: center; font-size: 13px; }
                }
                horiz-right := TouchArea {
                    clicked => {
                        root.align_horizontal_right();
                        root.show = false;
                        root.align_submenu_visible = false;
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
        }
    }
    
    if root.vertical_submenu_visible: Rectangle {
        width: 140px;
        height: root.item_height * 3;
        x: root.width + 138px;
        y: root.align_item_y + root.item_height;
        background: white;
        border-width: 1px;
        border-color: #ccc;
        drop-shadow-blur: 4px;
        drop-shadow-color: #00000040;
        
        VerticalBox {
            spacing: 0px;
            padding: 0px;
            
            Rectangle {
                height: root.item_height;
                background: vert-top.has-hover ? #e0e0e0 : transparent;
                HorizontalBox {
                    padding-left: 10px;
                    Text { text: "Top"; vertical-alignment: center; font-size: 13px; }
                }
                vert-top := TouchArea {
                    clicked => {
                        root.align_vertical_top();
                        root.show = false;
                        root.align_submenu_visible = false;
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
            Rectangle {
                height: root.item_height;
                background: vert-center.has-hover ? #e0e0e0 : transparent;
                HorizontalBox {
                    padding-left: 10px;
                    Text { text: "Center"; vertical-alignment: center; font-size: 13px; }
                }
                vert-center := TouchArea {
                    clicked => {
                        root.align_vertical_center();
                        root.show = false;
                        root.align_submenu_visible = false;
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
            Rectangle {
                height: root.item_height;
                background: vert-bottom.has-hover ? #e0e0e0 : transparent;
                HorizontalBox {
                    padding-left: 10px;
                    Text { text: "Bottom"; vertical-alignment: center; font-size: 13px; }
                }
                vert-bottom := TouchArea {
                    clicked => {
                        root.align_vertical_bottom();
                        root.show = false;
                        root.align_submenu_visible = false;
                        root.horizontal_submenu_visible = false;
                        root.vertical_submenu_visible = false;
                    }
                }
            }
        }
    }
}

export component DesignerPanel inherits Rectangle {
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    
    in property <[DesignerShape]> shapes: [];
    in property <DesignerState> designer_state;
    in-out property <float> feed_rate;
    in-out property <float> spindle_speed;
    in-out property <float> tool_diameter;
    in-out property <float> cut_depth;
    in-out property <float> step_in;
    in property <string> generated_gcode: "";
    in property <bool> gcode_generated: false;
    in property <float> zoom_scale: 1.0;
    in property <float> x_offset: 0.0;
    in property <float> y_offset: 0.0;
    in property <string> canvas_crosshair_data: ""; // Deprecated, kept for compatibility if needed
    in property <string> canvas_shapes_data: "";
    in property <string> canvas_grouped_shapes_data: "";
    in property <string> canvas_group_bounding_box_data: "";
    in property <string> canvas_selected_shapes_data: "";
    in property <string> canvas_handles_data: "";
    in property <string> canvas_grid_data: "";
    in property <string> canvas_origin_data: "";
    in-out property <bool> show_grid: true;
    in property <string> grid_size: "10mm";
    in property <int> selected_count: 0;
    out property <float> canvas-width: canvas-rect.width / 1px;
    out property <float> canvas-height: canvas-rect.height / 1px;
    in property <float> selected_shape_x: 0.0;
    in property <float> selected_shape_y: 0.0;
    in property <float> selected_shape_w: 0.0;
    in property <float> selected_shape_h: 0.0;
    in property <int> selected_shape_type: 0;
    in property <float> selected_shape_radius: 5.0;
    in property <bool> selected_shape_is_pocket: false;
    in property <float> selected_shape_pocket_depth: 0.0;
    in property <float> selected_shape_step_down: 0.0;
    in property <float> selected_shape_step_in: 0.0;
    in property <int> selected_shape_pocket_strategy: 1;
    in property <float> selected_shape_raster_angle: 0.0;
    in property <bool> selected_shape_bidirectional: true;
    in property <bool> selected_shape_use_custom_values: false;
    in property <string> selected_shape_text_content: "";
    in property <float> selected_shape_font_size: 12.0;
    in property <string> selected_shape_name: "";
    in property <float> selected_shape_corner_radius: 0.0;
    in property <bool> selected_shape_is_slot: false;
    in property <int> delete_confirmation_trigger: 0;
    in property <int> delete_confirmation_count: 0;
    
    private property <bool> properties_multiple_selection: false;
    in-out property <bool> is_editing_defaults: false;
    private property <float> original_shape_x: 0.0;
    private property <float> original_shape_y: 0.0;
    private property <float> original_shape_w: 0.0;
    private property <float> original_shape_h: 0.0;
    private property <float> original_corner_radius: 0.0;
    private property <bool> original_is_pocket: false;
    private property <float> original_pocket_depth: 0.0;
    private property <float> original_step_down: 0.0;
    private property <float> original_step_in: 0.0;
    private property <int> original_pocket_strategy: 1;
    private property <float> original_raster_angle: 0.0;
    private property <bool> original_bidirectional: true;
    private property <bool> original_use_custom_values: false;
    private property <string> original_text_content: "";
    private property <float> original_font_size: 12.0;
    
    private property <bool> rubber_band_active: false;
    private property <float> rubber_band_start_x: 0.0;
    private property <float> rubber_band_start_y: 0.0;
    private property <float> rubber_band_current_x: 0.0;
    private property <float> rubber_band_current_y: 0.0;

    callback select_in_rect(float, float, float, float, bool);
    callback select_shape(int, bool);

    callback set_mode(int);
    callback zoom_in();
    callback zoom_out();
    callback zoom_fit();
    callback reset_view();
    callback delete_selected();
    callback group_selected();
    callback ungroup_selected();
    callback clear_canvas();
    callback generate_toolpath();
    callback update_feed_rate(float);
    callback update_spindle_speed(float);
    callback update_tool_diameter(float);
    callback update_cut_depth(float);
    callback update_step_in(float);
    callback import_dxf();
    callback import_svg();
    callback export_design();
    callback canvas_click(float, float);
    callback detect_handle(float, float) -> int;  // x, y - returns handle index (-1 if not on handle)
    callback shape_drag(int, float, float);        // shape_id, dx, dy
    callback handle_drag(int, int, float, float);  // shape_id, handle_index, dx, dy
    callback canvas_pan(float, float);             // dx, dy - pan the viewport
    callback deselect_all();
    callback set_shift_pressed(bool);              // Notify backend of Shift key state
    callback show_context_menu(float, float);      // x, y - show context menu
    callback save_shape_properties();              // Save all properties from current dialog values
    callback update_shape_property(int, float);    // property_id, value (0=x, 1=y, 2=w, 3=h, 4=radius, 5=pocket_depth, 6=font_size, 7=step_down)
    callback update_shape_property_bool(int, bool); // property_id, value (0=is_pocket, 1=bidirectional, 2=use_custom_values, 3=is_slot)
    callback update_shape_property_string(int, string); // property_id, value (0=text_content, 1=name)
    callback select_next_shape();
    callback select_previous_shape();
    callback toggle_grid();
    callback show_delete_confirmation(int);
    callback confirm_delete();
    callback align_horizontal_left();
    callback align_horizontal_center();
    callback align_horizontal_right();
    callback align_vertical_top();
    callback align_vertical_center();
    callback align_vertical_bottom();
    callback copy_selected();
    callback paste_at_location(float, float);
    callback undo();
    callback redo();
    callback edit_default_properties();
    callback designer-interaction-start();
    
    // File operation callbacks
    callback file_new();
    callback file_open();
    callback file_save();
    callback file_save_as();
    
    // Context menu and dialog state
    private property <bool> context_menu_visible: false;
    private property <float> context_menu_x: 0;
    private property <float> context_menu_y: 0;
    private property <bool> properties_dialog_visible: false;
    private property <bool> delete_confirmation_visible: false;
    private property <int> delete_count: 0;
    private property <int> last_delete_confirmation_trigger: -1;
    private property <float> current_corner_radius: 5.0;
    private property <float> current_shape_x: 0.0;
    private property <float> current_shape_y: 0.0;
    private property <float> current_shape_w: 0.0;
    private property <float> current_shape_h: 0.0;
    private property <bool> is_pocket: false;
    private property <float> pocket_depth: 0.0;
    private property <float> step_down: 0.0;
    private property <float> dialog_step_in: 0.0;
    private property <int> dialog_pocket_strategy: 1;
    private property <float> dialog_raster_angle: 0.0;
    private property <bool> dialog_bidirectional: true;
    private property <bool> dialog_use_custom_values: false;
    private property <string> text_content: "";
    private property <float> font_size: 12.0;
    
    changed delete_confirmation_trigger => {
        if delete_confirmation_trigger != last_delete_confirmation_trigger {
            delete_count = delete_confirmation_count;
            delete_confirmation_visible = true;
            last_delete_confirmation_trigger = delete_confirmation_trigger;
        }
    }

    // Track last delta sent to backend (per shape) to compute incremental changes
    private property <float> drag_start_x: 0.0;
    private property <float> drag_start_y: 0.0;
    private property <float> drag_last_dx: 0.0;
    private property <float> drag_last_dy: 0.0;
    private property <int> dragging_shape_id: -1;
    private property <int> dragging_handle: -1;
    private property <bool> drag_occurred: false;
    private property <int> hovered_handle: -1;  // Track which handle we're hovering over
    private property <bool> drag_start_initialized: false;  // Track if drag_start has been set for current press
    private property <bool> shift_pressed: false;  // Track if Shift key is held
    private property <bool> space_pressed: false;  // Track if Space key is held
    private property <int> current_tab: 0; // 0=Properties, 1=Layers
    
    // Main layout: vertical toolbox on left, canvas and properties on right
    show_delete_confirmation(count) => {
        root.delete_count = count;
        root.delete_confirmation_visible = true;
    }

    FocusScope {
        width: 100%;
        height: 100%;
        
        key-pressed(event) => {
            if event.text == Key.Escape {
                deselect_all();
                accept
            } else if event.text == Key.Delete {
                delete_selected();
                accept
            } else if event.text == Key.Shift {
                root.shift_pressed = true;
                set_shift_pressed(true);
                accept
            } else if event.text == " " {
                root.space_pressed = true;
                accept
            } else if event.text == "z" && event.modifiers.control {
                if (event.modifiers.shift) {
                    if (designer_state.can_redo) { root.redo(); }
                } else {
                    if (designer_state.can_undo) { root.undo(); }
                }
                accept
            } else if event.text == "y" && event.modifiers.control {
                if (designer_state.can_redo) { root.redo(); }
                accept
            } else {
                reject
            }
        }
        
        key-released(event) => {
            if event.text == Key.Shift {
                root.shift_pressed = false;
                set_shift_pressed(false);
                accept
            } else if event.text == " " {
                root.space_pressed = false;
                accept
            } else {
                reject
            }
        }
        
        HorizontalLayout {
            spacing: 0px;
            padding: 0px;
            width: 100%;
            height: 100%;
        
        // ═════════════════════════════════════════════
        // LEFT SIDEBAR: Tool Icons in 4-Column Grid
        // ═════════════════════════════════════════════
        Rectangle {
            width: 250px;
            horizontal-stretch: 0;
            background: #2c3e50;
            
            VerticalLayout {
                width: 100%;
                height: 100%;
                spacing: 0px;
                alignment: start;
            
            // File Operations Section - REMOVED
            
            // Spacer above tool icons
            Rectangle { height: 8px; }
            
            // Drawing Tools Section (7 buttons in 4-column grid)
            HorizontalLayout {
                spacing: 2px;
                padding-left: 6px;
                padding-right: 2px;
                padding-top: 2px;
                padding-bottom: 2px;
                
                ToolButton {
                    tool_id: 0;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/select.svg");
                    tooltip: "Select (S)";
                    clicked => { set_mode(0); }
                }
                ToolButton {
                    tool_id: 1;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/rectangle.svg");
                    tooltip: "Rectangle (R)";
                    clicked => { set_mode(1); }
                }
                ToolButton {
                    tool_id: 2;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/circle.svg");
                    tooltip: "Circle (C)";
                    clicked => { set_mode(2); }
                }
                ToolButton {
                    tool_id: 3;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/line.svg");
                    tooltip: "Line (L)";
                    clicked => { set_mode(3); }
                }
            }
            
            HorizontalLayout {
                spacing: 2px;
                padding-left: 6px;
                padding-right: 2px;
                padding-top: 2px;
                padding-bottom: 2px;
                
                ToolButton {
                    tool_id: 4;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/ellipse.svg");
                    tooltip: "Ellipse (E)";
                    clicked => { set_mode(4); }
                }
                ToolButton {
                    tool_id: 5;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/polyline.svg");
                    tooltip: "Polyline (P)";
                    clicked => { set_mode(5); }
                }
                ToolButton {
                    tool_id: 6;
                    current_mode: designer_state.mode;
                    icon: @image-url("../../../assets/icons/text.svg");
                    tooltip: "Text (T)";
                    clicked => { set_mode(6); }
                }
                Rectangle { width: 48px; height: 48px; } // Placeholder
            }
            
            // Spacer below tool icons
            Rectangle { height: 8px; }
            
            // Separator
            Rectangle {
                height: 1px;
                background: #cccccc;
            }
            
            // Spacer below separator
            Rectangle { height: 8px; }
            
            // Tool Setup Controls (Copy)
            VerticalLayout {
                spacing: 10px;
                padding: 6px;
                
                Text {
                    text: "Tool Setup";
                    font-weight: 700;
                    font-size: 12px;
                    color: #ecf0f1;
                }
                
                HorizontalLayout {
                    spacing: 2px;
                    Text { 
                        text: "Feed:"; 
                        width: 40px;
                        vertical-alignment: center;
                        color: #bdc3c7;
                    }
                    CompactSpinBox { 
                        value: root.feed_rate; 
                        minimum: 0;
                        maximum: 10000;
                        step: 10;
                        horizontal-stretch: 1;
                        value-changed(v) => {
                            root.feed_rate = v;
                            root.update_feed_rate(v);
                        }
                    }
                }
                
                HorizontalLayout {
                    spacing: 2px;
                    Text { 
                        text: "Speed:"; 
                        width: 40px;
                        vertical-alignment: center;
                        color: #bdc3c7;
                    }
                    CompactSpinBox { 
                        value: root.spindle_speed;
                        minimum: 0;
                        maximum: 30000;
                        step: 100;
                        horizontal-stretch: 1;
                        value-changed(v) => {
                            root.spindle_speed = v;
                            root.update_spindle_speed(v);
                        }
                    }
                }
                
                HorizontalLayout {
                    spacing: 2px;
                    Text { 
                        text: "Tool:"; 
                        width: 40px;
                        vertical-alignment: center;
                        color: #bdc3c7;
                    }
                    CompactSpinBox { 
                        value: root.tool_diameter;
                        minimum: 0.1;
                        maximum: 50;
                        step: 0.1;
                        horizontal-stretch: 1;
                        value-changed(v) => {
                            root.tool_diameter = v;
                            root.update_tool_diameter(v);
                        }
                    }
                }
                
                HorizontalLayout {
                    spacing: 2px;
                    Text { 
                        text: "Depth:"; 
                        width: 40px;
                        vertical-alignment: center;
                        color: #bdc3c7;
                    }
                    CompactSpinBox { 
                        value: root.cut_depth;
                        minimum: -50;
                        maximum: 0;
                        step: 0.1;
                        horizontal-stretch: 1;
                        value-changed(v) => {
                            root.cut_depth = v;
                            root.update_cut_depth(v);
                        }
                    }
                }
                
                HorizontalLayout {
                    spacing: 2px;
                    Text { 
                        text: "Step:"; 
                        width: 40px;
                        vertical-alignment: center;
                        color: #bdc3c7;
                    }
                    CompactSpinBox { 
                        value: root.step_in;
                        minimum: 0.1;
                        maximum: 50;
                        step: 0.1;
                        horizontal-stretch: 1;
                        value-changed(v) => {
                            root.step_in = v;
                            root.update_step_in(v);
                        }
                    }
                }
                
                DarkCheckBox {
                    text: "Grid";
                    checked <=> root.show_grid;
                    toggled => { root.toggle_grid(); }
                }
            }
            
            // Spacer to push content to top
            VerticalBox { }
        }
        }
        
        // ═════════════════════════════════════════════
        // CENTER: Canvas Area
        // ═════════════════════════════════════════════
        Rectangle {
            horizontal-stretch: 1;
            
            VerticalLayout {
                width: 100%;
                height: 100%;
            
            // Canvas with interactive area
            Rectangle {
                background: #2c3e50;
                vertical-stretch: 1;
                
                VerticalLayout {
                    Rectangle {
                        vertical-stretch: 1;
                        background: #34495e;
                        
                        // Wrap canvas in FocusScope to enable mouse wheel handling
                        canvas_focus := FocusScope {
                            key-pressed(event) => {
                                if event.text == "+" || event.text == "=" {
                                    zoom_in();
                                    return accept;
                                } else if event.text == "-" {
                                    zoom_out();
                                    return accept;
                                } else if event.text == Key.Shift {
                                    root.shift_pressed = true;
                                    set_shift_pressed(true);
                                    return accept;
                                }
                                reject
                            }
                            
                            key-released(event) => {
                                if event.text == Key.Shift {
                                    root.shift_pressed = false;
                                    set_shift_pressed(false);
                                    return accept;
                                }
                                reject
                            }
                            
                            // Display rendered canvas using SVG paths
                            canvas-rect := Rectangle {
                                width: 100%;
                                height: 100%;
                                clip: true;
                                background: #34495e;
                            
                            Rectangle {
                                width: 100%;
                                height: 100%;
                                
                                // Grid layer
                                if root.show_grid && root.canvas_grid_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #808080;
                                    stroke-width: 1px;
                                    commands: root.canvas_grid_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }

                                // Origin marker layer (yellow cross at 0,0)
                                if root.canvas_origin_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: yellow;
                                    stroke-width: 2px;
                                    commands: root.canvas_origin_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Normal shapes layer (blue)
                                if root.canvas_shapes_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #3498db;
                                    stroke-width: 2px;
                                    commands: root.canvas_shapes_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Grouped shapes layer (green)
                                if root.canvas_grouped_shapes_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #2ecc71;
                                    stroke-width: 2px;
                                    commands: root.canvas_grouped_shapes_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }

                                // Group bounding box layer (green dotted)
                                if root.canvas_group_bounding_box_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #2ecc71;
                                    stroke-width: 1px;
                                    commands: root.canvas_group_bounding_box_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }

                                // Selected shapes layer (yellow)
                                if root.canvas_selected_shapes_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: transparent;
                                    stroke: #ffeb3b;
                                    stroke-width: 3px;
                                    commands: root.canvas_selected_shapes_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }
                                
                                // Selection handles layer (yellow filled squares)
                                if root.canvas_handles_data != "" : Path {
                                    width: 100%;
                                    height: 100%;
                                    fill: #ffeb3b;
                                    stroke: black;
                                    stroke-width: 1px;
                                    commands: root.canvas_handles_data;
                                    viewbox-width: canvas-rect.width / 1px;
                                    viewbox-height: canvas-rect.height / 1px;
                                }

                                // Rubber band selection rectangle
                                if root.rubber_band_active : Rectangle {
                                    x: min(root.rubber_band_start_x, root.rubber_band_current_x) * 1px;
                                    y: min(root.rubber_band_start_y, root.rubber_band_current_y) * 1px;
                                    width: abs(root.rubber_band_current_x - root.rubber_band_start_x) * 1px;
                                    height: abs(root.rubber_band_current_y - root.rubber_band_start_y) * 1px;
                                    border-width: 1px;
                                    border-color: #ffeb3b;
                                    background: #ffeb3b30;
                                }
                                
                                // Interactive layer on top of canvas
                                TouchArea {
                                    width: 100%;
                                    height: 100%;
                                    mouse-cursor: 
                                        designer_state.mode == 0 ? (
                                            root.hovered_handle == 0 || root.hovered_handle == 2 ? ns-resize :
                                            root.hovered_handle == 1 || root.hovered_handle == 3 ? ew-resize :
                                            root.dragging_shape_id >= 0 || ((root.hovered_handle == 4 || root.hovered_handle == 5) && designer_state.selected_id > 0) ? move :
                                            default
                                        ) :
                                        designer_state.mode == 1 ? crosshair :
                                        designer_state.mode == 2 ? crosshair :
                                        designer_state.mode == 3 ? crosshair :
                                        designer_state.mode == 4 ? crosshair :
                                        designer_state.mode == 5 ? crosshair :
                                        designer_state.mode == 6 ? crosshair :
                                        default;
                                    
                                    clicked => {
                                        // Don't handle click if a drag just occurred
                                        if !root.drag_occurred {
                                            // Direct mouse coordinates (no scroll offset)
                                            let adjusted_x = self.mouse-x / 1px;
                                            let adjusted_y = self.mouse-y / 1px;
                                            canvas_click(adjusted_x, adjusted_y);
                                        }
                                        root.drag_occurred = false;
                                    }

                                    scroll-event(event) => {
                                        if (event.delta-y > 0) {
                                            zoom_in();
                                        } else {
                                            zoom_out();
                                        }
                                        accept
                                    }
                                    
                                    // Detect handle on press down
                                    pointer-event(event) => {
                                        if event.kind == PointerEventKind.down {
                                            // Save history state at start of interaction
                                            if event.button == PointerEventButton.left {
                                                root.designer-interaction-start();
                                            }

                                            // Handle right-click for context menu
                                            if event.button == PointerEventButton.right {
                                                root.context_menu_x = self.mouse-x / 1px;
                                                root.context_menu_y = self.mouse-y / 1px;
                                                root.context_menu_visible = true;
                                                return;
                                            }
                                            
                                            // Hide context menu on left click
                                            root.context_menu_visible = false;
                                            
                                            // Ensure FocusScope has focus so key events are captured
                                            canvas_focus.focus();
                                            if designer_state.mode == 0 {
                                                // Ask backend to detect which handle (if any) we're on
                                                let adjusted_x = self.pressed-x / 1px;
                                                let adjusted_y = self.pressed-y / 1px;
                                                root.dragging_handle = detect_handle(adjusted_x, adjusted_y);
                                                // Reset drag tracking for new press
                                                root.drag_start_initialized = false;
                                            }
                                        } else if event.kind == PointerEventKind.up {
                                            // Handle release
                                            if root.rubber_band_active {
                                                let x1 = root.rubber_band_start_x;
                                                let y1 = root.rubber_band_start_y;
                                                let x2 = root.rubber_band_current_x;
                                                let y2 = root.rubber_band_current_y;
                                                
                                                // Pass pixel coordinates to backend
                                                root.select_in_rect(x1, y1, x2, y2, false);
                                                root.rubber_band_active = false;
                                            }

                                            root.drag_last_dx = 0.0;
                                            root.drag_last_dy = 0.0;
                                            root.drag_start_initialized = false;
                                            root.dragging_handle = -1;
                                            root.dragging_shape_id = -1;
                                            root.drag_occurred = false;
                                        }
                                    }
                                    
                                    // Track mouse movement - detect dragging and hover
                                    moved => {
                                        if designer_state.mode == 0 {
                                            // Check which handle we're hovering over
                                            let adjusted_x = self.mouse-x / 1px;
                                            let adjusted_y = self.mouse-y / 1px;
                                            root.hovered_handle = detect_handle(adjusted_x, adjusted_y);
                                        }
                                        
                                        if designer_state.mode == 0 && self.pressed {
                                            // Initialize drag start on first move while pressed
                                            if !root.drag_start_initialized {
                                                root.drag_start_x = self.pressed-x / 1px;
                                                root.drag_start_y = self.pressed-y / 1px;
                                                root.drag_start_initialized = true;
                                                root.drag_last_dx = 0.0;
                                                root.drag_last_dy = 0.0;

                                    // Check if we should start rubber band
                                    if root.dragging_handle == -1 {
                                        if !root.space_pressed {
                                            root.rubber_band_active = true;
                                            root.rubber_band_start_x = root.drag_start_x;
                                            root.rubber_band_start_y = root.drag_start_y;
                                            root.rubber_band_current_x = root.drag_start_x;
                                            root.rubber_band_current_y = root.drag_start_y;
                                        }
                                    }
                                            }
                                            
                                            if root.rubber_band_active {
                                                root.rubber_band_current_x = self.mouse-x / 1px;
                                                root.rubber_band_current_y = self.mouse-y / 1px;
                                                root.drag_occurred = true;
                                            } else {
                                                let total_dx = (self.mouse-x / 1px - root.drag_start_x);
                                                let total_dy = (self.mouse-y / 1px - root.drag_start_y);
                                                let inc_dx = total_dx - root.drag_last_dx;
                                                let inc_dy = total_dy - root.drag_last_dy;
                                                
                                                if abs(inc_dx) > 0.5 || abs(inc_dy) > 0.5 {
                                                    if root.dragging_handle >= 0 && root.dragging_handle <= 3 {
                                                        // Dragging a resize handle (0-3)
                                                        // Use current selected_id, not cached dragging_shape_id
                                                        handle_drag(designer_state.selected_id, root.dragging_handle, inc_dx, inc_dy);
                                                        root.drag_occurred = true;
                                                    } else if root.dragging_handle == 4 || root.dragging_handle == 5 {
                                                        // Dragging the shape itself (move) - handle is 4 (center) or 5 (body)
                                                        handle_drag(designer_state.selected_id, root.dragging_handle, inc_dx, inc_dy);
                                                        root.drag_occurred = true;
                                                    } else if root.dragging_handle == -1 {
                                                        // No shape selected - pan the canvas
                                                        if root.space_pressed {
                                                            canvas_pan(inc_dx, -inc_dy);
                                                            root.drag_occurred = true;
                                                        }
                                                    }
                                                    root.drag_last_dx = total_dx;
                                                    root.drag_last_dy = total_dy;
                                                }
                                            }
                                        }
                                    }
                                }

                                // Floating Status Bar (Bottom Left)
                                Rectangle {
                                    x: 10px;
                                    y: parent.height - 40px;
                                    height: 30px;
                                    width: status-layout.preferred-width + 20px;
                                    background: #2c3e50;
                                    border-radius: 15px;
                                    opacity: 0.9;
                                    border-width: 1px;
                                    border-color: #34495e;
                                    
                                    status-layout := HorizontalLayout {
                                        padding-left: 10px;
                                        padding-right: 10px;
                                        spacing: 15px;
                                        
                                        Text {
                                            text: Math.round(zoom_scale * 100.0) + "%";
                                            color: #ecf0f1;
                                            font-size: 12px;
                                            font-weight: 700;
                                            vertical-alignment: center;
                                        }
                                        
                                        Text {
                                            text: "X: " + Math.round(x_offset);
                                            color: #bdc3c7;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                        
                                        Text {
                                            text: "Y: " + Math.round(y_offset);
                                            color: #bdc3c7;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                        
                                        if root.show_grid : Text {
                                            text: root.grid_size;
                                            color: #bdc3c7;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                                
                                // Floating Zoom Controls (Bottom Right)
                                Rectangle {
                                    x: parent.width - 100px;
                                    y: parent.height - 40px;
                                    height: 30px;
                                    width: 90px;
                                    background: #2c3e50;
                                    border-radius: 15px;
                                    opacity: 0.9;
                                    border-width: 1px;
                                    border-color: #34495e;
                                    
                                    HorizontalLayout {
                                        alignment: center;
                                        spacing: 5px;
                                        
                                        Rectangle {
                                            width: 24px;
                                            height: 24px;
                                            background: transparent;
                                            Text { text: "-"; color: #ecf0f1; font-size: 16px; vertical-alignment: center; horizontal-alignment: center; }
                                            zoom-out-touch := TouchArea { clicked => { zoom_out(); } }
                                            StandardTooltip { text: "Zoom Out"; show: zoom-out-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2; }
                                        }
                                        }
                                        Rectangle {
                                            width: 24px;
                                            height: 24px;
                                            background: transparent;
                                            Text { text: "Fit"; color: #ecf0f1; font-size: 11px; vertical-alignment: center; horizontal-alignment: center; }
                                            fit-touch := TouchArea { clicked => { zoom_fit(); } }
                                            StandardTooltip { text: "Fit to View"; show: fit-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2; }
                                        }
                                        
                                        Rectangle {
                                            width: 24px;
                                            height: 24px;
                                            background: transparent;
                                            Text { text: "+"; color: #ecf0f1; font-size: 16px; vertical-alignment: center; horizontal-alignment: center; }
                                            zoom-in-touch := TouchArea { width: 100%; height: 100%; clicked => { root.zoom-in(); } }
                                            StandardTooltip { text: "Zoom In"; show: zoom-in-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2; }
                                        }
                                    }
                                }
                            }
                        }
                        }
                    }
                }
                    }
        }
        }

        // ═════════════════════════════════════════════
        // RIGHT SIDEBAR: Properties Panel
        // ═════════════════════════════════════════════
        Rectangle {
            width: 270px;
            horizontal-stretch: 0;
            background: #2c3e50;
            border-width: 1px;
            border-color: #34495e;
            
            VerticalBox {
                padding: 0px;
                spacing: 0px;
                
                // Tabs
                HorizontalBox {
                    height: 30px;
                    spacing: 0px;
                    padding: 0px;
                    
                    Rectangle {
                        horizontal-stretch: 1;
                        background: root.current_tab == 0 ? #2c3e50 : #34495e;
                        border-width: 1px;
                        border-color: #34495e;
                        
                        Text { 
                            text: "Properties"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center; 
                            font-weight: root.current_tab == 0 ? 700 : 400;
                            font-size: 12px;
                            color: #ecf0f1;
                        }
                        
                        TouchArea { clicked => { root.current_tab = 0; } }
                    }
                    
                    Rectangle {
                        horizontal-stretch: 1;
                        background: root.current_tab == 1 ? #2c3e50 : #34495e;
                        border-width: 1px;
                        border-color: #34495e;
                        
                        Text { 
                            text: "Layers"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center; 
                            font-weight: root.current_tab == 1 ? 700 : 400;
                            font-size: 12px;
                            color: #ecf0f1;
                        }
                        
                        TouchArea { clicked => { root.current_tab = 1; } }
                    }
                }
                
                // Content Area
                Rectangle {
                    vertical-stretch: 1;
                    background: #2c3e50;
                    
                    // Properties Tab
                    if root.current_tab == 0 : ScrollView {
                        VerticalBox {
                            alignment: start;
                            spacing: 10px;
                            padding: 10px;
                            
                            Text { 
                                text: root.selected_count > 0 ? 
                                      (root.selected_shape_type == 0 ? "Rectangle Properties" : 
                                       root.selected_shape_type == 1 ? "Circle Properties" : 
                                       root.selected_shape_type == 2 ? "Line Properties" : 
                                       root.selected_shape_type == 3 ? "Ellipse Properties" : 
                                       root.selected_shape_type == 4 ? "Path Properties" : 
                                       root.selected_shape_type == 6 ? "Text Properties" : "Shape Properties") 
                                      : "Design Properties"; 
                                font-weight: 700; 
                                font-size: 14px; 
                                color: #ecf0f1;
                            }
                            
                            if root.selected_count > 0 : VerticalBox {
                                spacing: 10px;
                                padding: 0px;
                                
                                // Name Property (only if single selection)
                                if root.selected_count == 1 : VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Name"; font-weight: 700; font-size: 12px; color: #ecf0f1; }
                                    Rectangle {
                                        height: 30px;
                                        border-width: 1px;
                                        border-color: #555;
                                        background: #34495e;
                                        TextInput {
                                            text: root.selected_shape_name;
                                            width: 100%;
                                            height: 100%;
                                            vertical-alignment: center;
                                            color: #ecf0f1;
                                            edited => { root.update_shape_property_string(1, self.text); }
                                        }
                                    }
                                }

                                // Position & Size
                                Text { text: "Transform"; font-weight: 700; font-size: 12px; color: #ecf0f1; }
                                
                                HorizontalBox {
                                    spacing: 5px;
                                    Text { text: "X:"; vertical-alignment: center; width: 20px; color: #bdc3c7; }
                                    CompactSpinBox { 
                                        value: root.selected_shape_x;
                                        minimum: -1000.0; maximum: 1000.0; step: 0.1;
                                        value-changed(v) => { root.update_shape_property(0, v); }
                                    }
                                    Text { text: "Y:"; vertical-alignment: center; width: 20px; color: #bdc3c7; }
                                    CompactSpinBox { 
                                        value: root.selected_shape_y;
                                        minimum: -1000.0; maximum: 1000.0; step: 0.1;
                                        value-changed(v) => { root.update_shape_property(1, v); }
                                    }
                                }
                                
                                HorizontalBox {
                                    spacing: 5px;
                                    Text { text: "W:"; vertical-alignment: center; width: 20px; color: #bdc3c7; }
                                    CompactSpinBox { 
                                        value: root.selected_shape_w;
                                        minimum: 0.1; maximum: 1000.0; step: 0.1;
                                        value-changed(v) => { root.update_shape_property(2, v); }
                                    }
                                    Text { text: "H:"; vertical-alignment: center; width: 20px; color: #bdc3c7; }
                                    CompactSpinBox { 
                                        value: root.selected_shape_h;
                                        minimum: 0.1; maximum: 1000.0; step: 0.1;
                                        value-changed(v) => { root.update_shape_property(3, v); }
                                    }
                                }
                                
                                // Rectangle Properties
                                if root.selected_shape_type == 0 : VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Rectangle Options"; font-weight: 700; font-size: 12px; color: #ecf0f1; }
                                    
                                    HorizontalBox {
                                        spacing: 5px;
                                        Text { text: "Radius:"; vertical-alignment: center; width: 45px; color: #bdc3c7; }
                                        CompactSpinBox { 
                                            value: root.selected_shape_corner_radius;
                                            minimum: 0.0; 
                                            maximum: min(root.selected_shape_w, root.selected_shape_h) / 2.0;
                                            step: 0.5;
                                            enabled: !root.selected_shape_is_slot;
                                            value-changed(v) => { root.update_shape_property(4, v); }
                                        }
                                    }
                                    
                                    DarkCheckBox { 
                                        text: "Slot (Auto Radius)"; 
                                        checked: root.selected_shape_is_slot;
                                        toggled => { root.update_shape_property_bool(3, self.checked); }
                                    }
                                }

                                // Text Properties
                                if root.selected_shape_type == 6 : VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Text Content"; font-weight: 700; font-size: 12px; color: #ecf0f1; }
                                    Rectangle {
                                        height: 30px;
                                        border-width: 1px;
                                        border-color: #555;
                                        background: #34495e;
                                        TextInput {
                                            text: root.selected_shape_text_content;
                                            width: 100%;
                                            height: 100%;
                                            vertical-alignment: center;
                                            color: #ecf0f1;
                                            edited => { root.update_shape_property_string(0, self.text); }
                                        }
                                    }
                                    
                                    HorizontalBox {
                                        spacing: 5px;
                                        Text { text: "Size:"; vertical-alignment: center; color: #bdc3c7; }
                                        CompactSpinBox { 
                                            value: root.selected_shape_font_size;
                                            minimum: 1.0; maximum: 1000.0;
                                            value-changed(v) => { root.update_shape_property(6, v); }
                                        }
                                    }
                                }
                            }
                                
                            // CAM Operations
                            Text { text: "CAM Operations"; font-weight: 700; font-size: 12px; color: #ecf0f1; }
                            
                            if root.selected_count > 0 : DarkCheckBox { 
                                text: "Use Custom Values"; 
                                checked: root.selected_shape_use_custom_values;
                                toggled => { root.update_shape_property_bool(2, self.checked); }
                            }
                            
                            DarkCheckBox { 
                                text: "Pocket Operation"; 
                                checked: root.selected_shape_is_pocket;
                                toggled => { root.update_shape_property_bool(0, self.checked); }
                            }
                            
                            if root.selected_shape_is_pocket : VerticalBox {
                                    spacing: 5px;
                                    
                                    HorizontalBox {
                                        Text { text: "Depth:"; vertical-alignment: center; width: 60px; color: #bdc3c7; }
                                        CompactSpinBox { 
                                            value: root.selected_shape_pocket_depth;
                                            minimum: -100.0; maximum: 100.0;
                                            value-changed(v) => { root.update_shape_property(5, v); }
                                        }
                                    }
                                    
                                    HorizontalBox {
                                        Text { text: "Step Down:"; vertical-alignment: center; width: 60px; color: #bdc3c7; }
                                        CompactSpinBox { 
                                            value: root.selected_shape_step_down;
                                            minimum: 0.1; maximum: 100.0;
                                            value-changed(v) => { root.update_shape_property(7, v); }
                                        }
                                    }
                                    
                                    HorizontalBox {
                                        Text { text: "Step In:"; vertical-alignment: center; width: 60px; color: #bdc3c7; }
                                        CompactSpinBox { 
                                            value: root.selected_shape_step_in;
                                            minimum: 0.1; maximum: 100.0;
                                            value-changed(v) => { root.update_shape_property(8, v); }
                                        }
                                    }
                                    
                                    HorizontalBox {
                                        Text { text: "Strategy:"; vertical-alignment: center; width: 60px; color: #bdc3c7; }
                                        ComboBox {
                                            model: ["Raster", "Contour", "Adaptive"];
                                            current-index: root.selected_shape_pocket_strategy;
                                            selected(val) => { 
                                                if (val == "Raster") { root.update_shape_property(9, 0.0); }
                                                if (val == "Contour") { root.update_shape_property(9, 1.0); }
                                                if (val == "Adaptive") { root.update_shape_property(9, 2.0); }
                                            }
                                        }
                                    }
                                    
                                    HorizontalBox {
                                        Text { text: "Angle:"; vertical-alignment: center; width: 60px; color: #bdc3c7; }
                                        CompactSpinBox { 
                                            value: root.selected_shape_raster_angle;
                                            minimum: -360.0; maximum: 360.0;
                                            value-changed(v) => { root.update_shape_property(10, v); }
                                        }
                                    }
                                    
                                    DarkCheckBox { 
                                        text: "Bidirectional"; 
                                        checked: root.selected_shape_bidirectional;
                                        toggled => { root.update_shape_property_bool(1, self.checked); }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Layers Tab
                    if root.current_tab == 1 : VerticalLayout {
                        spacing: 0px;
                        padding: 0px;
                        
                        // Column Headers
                        Rectangle {
                            height: 24px;
                            background: #34495e;
                            border-width: 0px;
                            
                            HorizontalLayout {
                                padding-left: 5px;
                                padding-right: 5px;
                                spacing: 5px;
                                
                                Text { 
                                    text: "Type"; 
                                    width: 30px; 
                                    font-weight: 700; 
                                    font-size: 11px; 
                                    vertical-alignment: center; 
                                    color: #ecf0f1;
                                }
                                Text { 
                                    text: "Name"; 
                                    horizontal-stretch: 1; 
                                    font-weight: 700; 
                                    font-size: 11px; 
                                    vertical-alignment: center; 
                                    color: #ecf0f1;
                                }
                                Text { 
                                    text: "Group"; 
                                    width: 40px; 
                                    font-weight: 700; 
                                    font-size: 11px; 
                                    vertical-alignment: center; 
                                    color: #ecf0f1;
                                }
                            }
                            
                            // Bottom border
                            Rectangle {
                                y: parent.height - 1px;
                                height: 1px;
                                background: #2c3e50;
                            }
                        }

                        layers-focus := FocusScope {
                            vertical-stretch: 1;
                            key-pressed(event) => {
                                if (event.text == Key.UpArrow) {
                                    root.select_previous_shape();
                                    return accept;
                                }
                                if (event.text == Key.DownArrow) {
                                    root.select_next_shape();
                                    return accept;
                                }
                                reject
                            }

                            ScrollView {
                                VerticalLayout {
                                    alignment: start;
                                    spacing: 2px;
                                    padding: 5px;
                                    
                                    for shape[index] in root.shapes : Rectangle {
                                    height: 28px;
                                    background: shape.selected ? #3498db : (layer-touch.has-hover ? #3d566e : transparent);
                                    border-radius: 2px;
                                    
                                    HorizontalLayout {
                                        padding-left: 5px;
                                        padding-right: 5px;
                                        spacing: 5px;
                                        
                                        Text {
                                            text: shape.shape_type == 0 ? "▭" : 
                                                  shape.shape_type == 1 ? "●" : 
                                                  shape.shape_type == 2 ? "/" : 
                                                  shape.shape_type == 3 ? "◯" : 
                                                  shape.shape_type == 4 ? "⬠" : 
                                                  shape.shape_type == 6 ? "T" : "?";
                                            color: shape.selected ? white : #ecf0f1;
                                            vertical-alignment: center;
                                            font-size: 14px;
                                            width: 30px;
                                        }
                                        
                                        Text {
                                            text: shape.name;
                                            color: shape.selected ? white : #ecf0f1;
                                            vertical-alignment: center;
                                            font-size: 12px;
                                            horizontal-stretch: 1;
                                        }
    
                                        if shape.group_id > 0 : Text {
                                            text: "Grp " + shape.group_id;
                                            color: shape.selected ? #eee : #95a5a6;
                                            vertical-alignment: center;
                                            font-size: 11px;
                                            width: 40px;
                                        }
                                    }
                                    
                                    layer-touch := TouchArea {
                                        clicked => {
                                            layers-focus.focus();
                                            root.select_shape(shape.id, root.shift_pressed);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                }
            }
        }
        

    
    // Context menu overlay (on top of everything)
    if root.context_menu_visible: ContextMenu {
        show <=> root.context_menu_visible;
        menu_x: root.context_menu_x;
        menu_y: root.context_menu_y;
        align-enabled: root.selected_count >= 2;
        has-selection: root.selected_count > 0;
        can-group: designer_state.can_group;
        can-ungroup: designer_state.can_ungroup;
        
        menu_delete => {
            delete_selected();
        }

        menu_copy => {
            root.copy_selected();
        }

        menu_paste => {
            root.paste_at_location(root.context_menu_x, root.context_menu_y);
        }

        menu_group => {
            root.group_selected();
        }

        menu_ungroup => {
            root.ungroup_selected();
        }
        

        align_horizontal_left => {
            root.align_horizontal_left();
        }
        align_horizontal_center => {
            root.align_horizontal_center();
        }
        align_horizontal_right => {
            root.align_horizontal_right();
        }
        align_vertical_top => {
            root.align_vertical_top();
        }
        align_vertical_center => {
            root.align_vertical_center();
        }
        align_vertical_bottom => {
            root.align_vertical_bottom();
        }
    }
    
    // Delete confirmation dialog overlay
    if root.delete_confirmation_visible: Rectangle {
        width: 100%;
        height: 100%;
        background: #00000080;
        
        TouchArea {
            clicked => {
                root.delete_confirmation_visible = false;
            }
        }
        
        DeleteConfirmationDialog {
            count: root.delete_count;
            confirm => {
                root.delete_confirmation_visible = false;
                root.confirm_delete();
            }
            cancel => {
                root.delete_confirmation_visible = false;
            }
        }
    }
}
