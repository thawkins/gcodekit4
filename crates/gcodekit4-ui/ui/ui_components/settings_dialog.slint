//! Settings Dialog Component
//! Preferences/settings dialog UI with category sidebar and dynamic settings rendering.

import { Button, CheckBox, ComboBox, LineEdit, ScrollView, VerticalBox, HorizontalBox } from "std-widgets.slint";

export struct SettingItem {
    id: string,
    name: string,
    value: string,
    value-type: string,
    category: string,
    description: string,
    options: [string],
    current-index: int,
}

export component SettingsDialog inherits Rectangle {
    in-out property<bool> dialog-visible;
    in-out property<string> settings-category: "general";
    in property<[SettingItem]> all-settings;
    
    callback menu-settings-save();
    callback menu-settings-cancel();
    callback menu-settings-restore-defaults();
    callback update-setting(string, string);
    
    x: 0;
    y: 0;
    width: 100%;
    height: 100%;
    background: root.dialog-visible ? rgba(0, 0, 0, 0.5) : transparent;
    z: 2000;
    
    if root.dialog-visible : Rectangle {
        x: (parent.width - 700px) / 2;
        y: (parent.height - 550px) / 2;
        width: 700px;
        height: 550px;
        background: #ecf0f1;
        border-radius: 5px;
        z: 2001;
        
        VerticalBox {
            padding: 0px;
            spacing: 0px;
            
            // Header
            Rectangle {
                height: 50px;
                background: #2c3e50;
                VerticalBox {
                    padding-left: 20px;
                    alignment: center;
                    Text {
                        text: "Preferences";
                        font-size: 18px;
                        font-weight: 700;
                        color: white;
                    }
                }
            }
            
            // Content
            HorizontalBox {
                spacing: 0px;
                
                // Sidebar
                Rectangle {
                    width: 150px;
                    background: #34495e;
                    VerticalBox {
                        padding: 10px;
                        spacing: 2px;
                        
                        Rectangle {
                            height: 35px;
                            background: root.settings-category == "controller" ? #3d5470 : transparent;
                            HorizontalBox {
                                padding-left: 10px;
                                alignment: center;
                                Text { text: "Controller"; color: white; font-size: 12px; }
                            }
                            TouchArea { clicked => { root.settings-category = "controller"; } }
                        }
                        
                        Rectangle {
                            height: 35px;
                            background: root.settings-category == "ui" ? #3d5470 : transparent;
                            HorizontalBox {
                                padding-left: 10px;
                                alignment: center;
                                Text { text: "User Interface"; color: white; font-size: 12px; }
                            }
                            TouchArea { clicked => { root.settings-category = "ui"; } }
                        }
                        
                        Rectangle {
                            height: 35px;
                            background: root.settings-category == "file" ? #3d5470 : transparent;
                            HorizontalBox {
                                padding-left: 10px;
                                alignment: center;
                                Text { text: "File Processing"; color: white; font-size: 12px; }
                            }
                            TouchArea { clicked => { root.settings-category = "file"; } }
                        }
                        
                        Rectangle {
                            height: 35px;
                            background: root.settings-category == "shortcuts" ? #3d5470 : transparent;
                            HorizontalBox {
                                padding-left: 10px;
                                alignment: center;
                                Text { text: "Keyboard"; color: white; font-size: 12px; }
                            }
                            TouchArea { clicked => { root.settings-category = "shortcuts"; } }
                        }
                        
                        Rectangle {
                            height: 35px;
                            background: root.settings-category == "advanced" ? #3d5470 : transparent;
                            HorizontalBox {
                                padding-left: 10px;
                                alignment: center;
                                Text { text: "Advanced"; color: white; font-size: 12px; }
                            }
                            TouchArea { clicked => { root.settings-category = "advanced"; } }
                        }
                    }
                }
                
                // Settings Panel
                Rectangle {
                    background: #ecf0f1;
                    VerticalBox {
                        padding: 20px;
                        spacing: 12px;
                        
                        Text {
                            text: root.settings-category == "controller" ? "Controller Settings" :
                                  root.settings-category == "ui" ? "User Interface" :
                                  root.settings-category == "file" ? "File Processing" :
                                  root.settings-category == "shortcuts" ? "Keyboard Shortcuts" :
                                  "Advanced Settings";
                            font-size: 14px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        
                        Rectangle {
                            height: 1px;
                            background: #bdc3c7;
                        }
                        
                        ScrollView {
                            VerticalBox {
                                spacing: 0px;
                                padding: 0px;
                                
                                if root.settings-category == "controller" : VerticalBox {
                                    spacing: 0px;
                                    padding: 2px;
                                    for setting[idx] in root.all-settings : HorizontalBox {
                                        if setting.category == "Controller" : HorizontalBox {
                                            alignment: start;
                                            spacing: 4px;
                                            Text {
                                                text: setting.name + ":";
                                                font-size: 10px;
                                                color: #34495e;
                                                width: 110px;
                                            }
                                            if setting.value-type == "Boolean" : CheckBox {
                                                checked: setting.value == "true" || setting.value == "1";
                                                toggled => { root.update-setting(setting.id, self.checked ? "true" : "false"); }
                                            }
                                            if setting.value-type == "Enum" && setting.options.length > 0 : ComboBox {
                                                model: setting.options;
                                                current-index: setting.current-index;
                                                selected => { root.update-setting(setting.id, self.current-value); }
                                            }
                                            if setting.value-type != "Boolean" && setting.value-type != "Enum" : LineEdit {
                                                text: setting.value;
                                                edited => { root.update-setting(setting.id, self.text); }
                                            }
                                        }
                                    }
                                }
                                
                                if root.settings-category == "ui" : VerticalBox {
                                    spacing: 0px;
                                    padding: 2px;
                                    for setting[idx] in root.all-settings : HorizontalBox {
                                        if setting.category == "User Interface" : HorizontalBox {
                                            alignment: start;
                                            spacing: 4px;
                                            Text {
                                                text: setting.name + ":";
                                                font-size: 10px;
                                                color: #34495e;
                                                width: 110px;
                                            }
                                            if setting.value-type == "Boolean" : CheckBox {
                                                checked: setting.value == "true" || setting.value == "1";
                                                toggled => { root.update-setting(setting.id, self.checked ? "true" : "false"); }
                                            }
                                            if setting.value-type == "Enum" && setting.options.length > 0 : ComboBox {
                                                model: setting.options;
                                                current-index: setting.current-index;
                                                selected => { root.update-setting(setting.id, self.current-value); }
                                            }
                                            if setting.value-type != "Boolean" && setting.value-type != "Enum" : LineEdit {
                                                text: setting.value;
                                                edited => { root.update-setting(setting.id, self.text); }
                                            }
                                        }
                                    }
                                }
                                
                                if root.settings-category == "file" : VerticalBox {
                                    spacing: 0px;
                                    padding: 2px;
                                    for setting[idx] in root.all-settings : HorizontalBox {
                                        if setting.category == "File Processing" : HorizontalBox {
                                            alignment: start;
                                            spacing: 4px;
                                            Text {
                                                text: setting.name + ":";
                                                font-size: 10px;
                                                color: #34495e;
                                                width: 110px;
                                            }
                                            if setting.value-type == "Boolean" : CheckBox {
                                                checked: setting.value == "true" || setting.value == "1";
                                                toggled => { root.update-setting(setting.id, self.checked ? "true" : "false"); }
                                            }
                                            if setting.value-type == "Enum" && setting.options.length > 0 : ComboBox {
                                                model: setting.options;
                                                current-index: setting.current-index;
                                                selected => { root.update-setting(setting.id, self.current-value); }
                                            }
                                            if setting.value-type != "Boolean" && setting.value-type != "Enum" : LineEdit {
                                                text: setting.value;
                                                edited => { root.update-setting(setting.id, self.text); }
                                            }
                                        }
                                    }
                                }
                                
                                if root.settings-category == "advanced" : VerticalBox {
                                    spacing: 2px;
                                    for setting[idx] in root.all-settings : Rectangle {
                                        height: 24px;
                                        if setting.category == "Advanced" : HorizontalBox {
                                            alignment: start;
                                            spacing: 8px;
                                            Text {
                                                text: setting.name;
                                                font-size: 10px;
                                                color: #2c3e50;
                                                width: 45%;
                                            }
                                            if setting.value-type == "Boolean" : CheckBox {
                                                checked: setting.value == "true" || setting.value == "1";
                                                toggled => { root.update-setting(setting.id, self.checked ? "true" : "false"); }
                                            }
                                            if setting.value-type == "Enum" && setting.options.length > 0 : ComboBox {
                                                model: setting.options;
                                                current-index: setting.current-index;
                                                selected => { root.update-setting(setting.id, self.current-value); }
                                            }
                                            if setting.value-type != "Boolean" && setting.value-type != "Enum" : LineEdit {
                                                text: setting.value;
                                                edited => { root.update-setting(setting.id, self.text); }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Buttons
            Rectangle {
                height: 50px;
                background: #ecf0f1;
                border-width: 1px;
                border-color: #bdc3c7;
                HorizontalBox {
                    padding: 10px;
                    spacing: 10px;
                    alignment: end;
                    
                    Button {
                        text: "Restore Defaults";
                        width: 120px;
                        height: 35px;
                        clicked => { root.menu-settings-restore-defaults(); }
                    }
                    
                    Button {
                        text: "Cancel";
                        width: 80px;
                        height: 35px;
                        clicked => {
                            root.dialog-visible = false;
                            root.menu-settings-cancel();
                        }
                    }
                    
                    Button {
                        text: "OK";
                        width: 80px;
                        height: 35px;
                        clicked => {
                            root.dialog-visible = false;
                            root.menu-settings-save();
                        }
                    }
                }
            }
        }
    }
}
