// CNC Tools Manager UI Panel
// Provides CRUD interface for managing CNC tools database

import { Button, VerticalBox, HorizontalBox, ListView, LineEdit, ComboBox, TextEdit, 
         ScrollView, GroupBox, TabWidget, CheckBox, SpinBox } from "std-widgets.slint";

// Tool data structure for UI
export struct ToolData {
    id: string,
    number: int,
    name: string,
    tool_type: string,
    material: string,
    diameter: float,
    length: float,
    flute_length: float,
    shaft_diameter: float,
    flutes: int,
    coating: string,
    manufacturer: string,
    part_number: string,
    description: string,
    custom: bool,
    notes: string,
}

component TMButton inherits Rectangle {
    in property <string> text;
    in property <bool> enabled: true;
    in property <brush> base-color: #404040;
    in property <brush> hover-color: #505050;
    in property <brush> pressed-color: #2980b9;
    in property <bool> primary: false;
    in property <bool> destructive: false;
    
    callback clicked;
    
    height: 35px;
    border-radius: 4px;
    
    background: !root.enabled ? #2c3e50 : 
                (touch.pressed ? root.pressed-color : 
                (touch.has-hover ? (root.destructive ? #e74c3c : (root.primary ? #357abd : root.hover-color)) : 
                (root.destructive ? #c0392b : (root.primary ? #4a90e2 : root.base-color))));

    opacity: root.enabled ? 1.0 : 0.5;
    
    Text {
        text: root.text;
        color: #ecf0f1;
        font-size: 13px;
        vertical-alignment: center;
        horizontal-alignment: center;
    }
    
    touch := TouchArea {
        enabled: root.enabled;
        clicked => { root.clicked(); }
    }
}

component TMInput inherits Rectangle {
    in-out property <string> text <=> input.text;
    in property <string> placeholder-text <=> input.placeholder-text;
    in property <bool> enabled <=> input.enabled;
    callback edited(string);
    
    height: 30px;
    background: #3e3e3e;
    border-radius: 4px;
    border-width: 1px;
    border-color: input.has-focus ? #4a90e2 : #555555;
    
    input := LineEdit {
        width: 100%;
        height: 100%;
        font-size: 13px;
        edited(s) => { root.edited(s); }
    }
}

component TMSpinBox inherits Rectangle {
    in-out property <int> value <=> spin.value;
    in property <int> minimum <=> spin.minimum;
    in property <int> maximum <=> spin.maximum;
    
    height: 30px;
    background: #3e3e3e;
    border-radius: 4px;
    border-width: 1px;
    border-color: #555555;
    
    spin := SpinBox {
        width: 100%;
        height: 100%;
    }
}

component TMSectionHeader inherits Text {
    color: #e0e0e0;
    font-size: 14px;
    font-weight: 700;
}

export component ToolsManager inherits Rectangle {
    // Callbacks for CRUD operations
    callback load_tools();
    callback create_tool(ToolData);
    callback update_tool(ToolData);
    callback delete_tool(string /* id */);
    callback select_tool(string /* id */);
    callback search_tools(string /* query */);
    callback filter_by_type(string /* tool_type */);
    callback import_gtc_package(string /* file_path */);
    
    // Tool list data
    in-out property <[ToolData]> tools: [];
    in-out property <ToolData> selected_tool;
    in-out property <string> search_query: "";
    in-out property <bool> is_editing: false;
    in-out property <bool> is_creating: false;
    
    // Editable properties
    in-out property <string> edit_id: "";
    in-out property <int> edit_number: 1;
    in-out property <string> edit_name: "";
    in-out property <string> edit_tool_type: "Flat End Mill";
    in-out property <string> edit_material: "Carbide";
    in-out property <float> edit_diameter: 6.35;
    in-out property <float> edit_length: 50.0;
    in-out property <float> edit_flute_length: 20.0;
    in-out property <float> edit_shaft_diameter: 6.35;
    in-out property <int> edit_flutes: 2;
    in-out property <string> edit_coating: "None";
    in-out property <string> edit_manufacturer: "";
    in-out property <string> edit_part_number: "";
    in-out property <string> edit_description: "";
    in-out property <string> edit_notes: "";
    
    // Categories for ComboBox
    property <[string]> tool_types: [
        "Flat End Mill",
        "Ball End Mill",
        "Corner Radius End Mill",
        "V-Bit",
        "Drill Bit",
        "Spot Drill",
        "Engraving Bit",
        "Chamfer Tool",
        "Specialty"
    ];
    
    property <[string]> materials: ["HSS", "Carbide", "Coated Carbide", "Diamond"];
    property <[string]> coatings: ["None", "TiN", "TiAlN", "DLC", "AlOx"];
    
    background: #1e1e1e;
    
    VerticalBox {
        padding: 10px;
        spacing: 10px;
        
        // Header with search and actions
        HorizontalBox {
            spacing: 10px;
            height: 40px;
            
            Text {
                text: "CNC Tools Manager";
                font-size: 20px;
                font-weight: 700;
                color: #e0e0e0;
                vertical-alignment: center;
            }
            
            Rectangle {
                horizontal-stretch: 1;
            }
            
            TMInput {
                width: 250px;
                placeholder-text: "Search tools...";
                text <=> search_query;
                edited => {
                    root.search_tools(search_query);
                }
            }
            
            TMButton {
                text: "âž• New Tool";
                primary: true;
                width: 100px;
                clicked => {
                    is_creating = true;
                    is_editing = false;
                    edit_id = "";
                    edit_number = 1;
                    edit_name = "";
                    edit_tool_type = "Flat End Mill";
                    edit_material = "Carbide";
                    edit_diameter = 6.35;
                    edit_length = 50.0;
                    edit_flute_length = 20.0;
                    edit_shaft_diameter = 6.35;
                    edit_flutes = 2;
                    edit_coating = "None";
                    edit_manufacturer = "";
                    edit_part_number = "";
                    edit_description = "";
                    edit_notes = "";
                }
            }
            
            TMButton {
                text: "ðŸ“¦ Import GTC";
                width: 100px;
                clicked => {
                    root.import_gtc_package("");
                }
            }
        }
        
        // Filter by type
        HorizontalBox {
            spacing: 10px;
            height: 30px;
            
            Text {
                text: "Filter by Type:";
                vertical-alignment: center;
                color: #aaaaaa;
            }
            
            ComboBox {
                model: ["All Types", "Flat End Mill", "Ball End Mill", "Corner Radius End Mill", 
                        "V-Bit", "Drill Bit", "Spot Drill", "Engraving Bit", "Chamfer Tool", "Specialty"];
                current-value: "All Types";
                width: 200px;
                selected => {
                    if (self.current-value == "All Types") {
                        root.load_tools();
                    } else {
                        root.filter_by_type(self.current-value);
                    }
                }
            }
        }
        
        // Main content area
        HorizontalBox {
            spacing: 10px;
            
            // Left panel - Tool list
            Rectangle {
                width: 350px;
                background: #2d2d2d;
                border-radius: 5px;
                
                VerticalBox {
                    padding: 10px;
                    spacing: 10px;
                    
                    Text {
                        text: "Tools (" + tools.length + ")";
                        font-size: 14px;
                        font-weight: 600;
                        color: #e0e0e0;
                    }
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 5px;
                            
                            for tool[index] in tools: Rectangle {
                                height: 80px;
                                background: tool.id == selected_tool.id ? #34495e : (touch.has-hover ? #3e3e3e : #252525);
                                border-radius: 5px;
                                border-width: 1px;
                                border-color: tool.id == selected_tool.id ? #4a90e2 : #404040;
                                
                                touch := TouchArea {
                                    clicked => {
                                        selected_tool = tool;
                                        root.select_tool(tool.id);
                                    }
                                    double-clicked => {
                                        selected_tool = tool;
                                        is_editing = true;
                                        is_creating = false;
                                        edit_id = tool.id;
                                        edit_number = tool.number;
                                        edit_name = tool.name;
                                        edit_tool_type = tool.tool_type;
                                        edit_material = tool.material;
                                        edit_diameter = tool.diameter;
                                        edit_length = tool.length;
                                        edit_flute_length = tool.flute_length;
                                        edit_shaft_diameter = tool.shaft_diameter;
                                        edit_flutes = tool.flutes;
                                        edit_coating = tool.coating;
                                        edit_manufacturer = tool.manufacturer;
                                        edit_part_number = tool.part_number;
                                        edit_description = tool.description;
                                        edit_notes = tool.notes;
                                    }
                                }
                                
                                HorizontalBox {
                                    padding: 10px;
                                    spacing: 10px;
                                    
                                    VerticalBox {
                                        spacing: 2px;
                                        
                                        HorizontalBox {
                                            spacing: 5px;
                                            
                                            Text {
                                                text: "T" + tool.number;
                                                font-size: 12px;
                                                font-weight: 700;
                                                color: tool.id == selected_tool.id ? white : #4a90e2;
                                            }
                                            
                                            Text {
                                                text: tool.name;
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: tool.id == selected_tool.id ? white : #e0e0e0;
                                            }
                                        }
                                        
                                        Text {
                                            text: tool.tool_type;
                                            font-size: 10px;
                                            color: tool.id == selected_tool.id ? #ecf0f1 : #aaaaaa;
                                        }
                                        
                                        Text {
                                            text: "Ã˜" + tool.diameter + "mm Ã— " + tool.length + "mm";
                                            font-size: 10px;
                                            color: tool.id == selected_tool.id ? #ecf0f1 : #aaaaaa;
                                        }
                                        
                                        Text {
                                            text: tool.material + (tool.coating != "None" ? " (" + tool.coating + ")" : "");
                                            font-size: 9px;
                                            color: tool.id == selected_tool.id ? #ecf0f1 : #7f8c8d;
                                        }
                                    }
                                    
                                    Rectangle {
                                        horizontal-stretch: 1;
                                    }
                                    
                                    if tool.custom: Rectangle {
                                        width: 50px;
                                        Text {
                                            text: "Custom";
                                            font-size: 9px;
                                            color: tool.id == selected_tool.id ? white : #4a90e2;
                                            font-weight: 600;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Right panel - Details or Edit form
            Rectangle {
                background: #2d2d2d;
                border-radius: 5px;
                
                if !is_editing && !is_creating: VerticalBox {
                    alignment: center;
                    Text {
                        text: "Select a tool to view details\nor create a new tool";
                        font-size: 16px;
                        color: #7f8c8d;
                        horizontal-alignment: center;
                    }
                }
                
                if is_editing || is_creating: ScrollView {
                    VerticalBox {
                        spacing: 15px;
                        padding: 20px;
                        
                        // Header
                        HorizontalBox {
                            spacing: 10px;
                            
                            Text {
                                text: is_creating ? "Create New Tool" : "Edit Tool";
                                font-size: 18px;
                                font-weight: 700;
                                color: #e0e0e0;
                                horizontal-alignment: left;
                            }
                            
                            Rectangle {
                                horizontal-stretch: 1;
                            }
                            
                            TMButton {
                                text: "ðŸ’¾ Save";
                                primary: true;
                                width: 80px;
                                clicked => {
                                    selected_tool = {
                                        id: edit_id,
                                        number: edit_number,
                                        name: edit_name,
                                        tool_type: edit_tool_type,
                                        material: edit_material,
                                        diameter: edit_diameter,
                                        length: edit_length,
                                        flute_length: edit_flute_length,
                                        shaft_diameter: edit_shaft_diameter,
                                        flutes: edit_flutes,
                                        coating: edit_coating,
                                        manufacturer: edit_manufacturer,
                                        part_number: edit_part_number,
                                        description: edit_description,
                                        custom: true,
                                        notes: edit_notes,
                                    };
                                    if (is_creating) {
                                        root.create_tool(selected_tool);
                                    } else {
                                        root.update_tool(selected_tool);
                                    }
                                    is_editing = false;
                                    is_creating = false;
                                }
                            }
                            
                            TMButton {
                                text: "âŒ Cancel";
                                width: 80px;
                                clicked => {
                                    is_editing = false;
                                    is_creating = false;
                                }
                            }
                            
                            if !is_creating && selected_tool.custom: TMButton {
                                text: "ðŸ—‘ï¸ Delete";
                                destructive: true;
                                width: 80px;
                                clicked => {
                                    root.delete_tool(selected_tool.id);
                                    is_editing = false;
                                    is_creating = false;
                                }
                            }
                        }
                        
                        // Basic Information
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Basic Information"; }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Tool Number:"; color: #aaaaaa; }
                                    TMSpinBox {
                                        value <=> edit_number;
                                        minimum: 1;
                                        maximum: 9999;
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    horizontal-stretch: 1;
                                    Text { text: "Tool Name:"; color: #aaaaaa; }
                                    TMInput {
                                        text <=> edit_name;
                                        placeholder-text: "e.g., 6mm Carbide End Mill";
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Tool Type:"; color: #aaaaaa; }
                                    ComboBox {
                                        model: tool_types;
                                        current-value <=> edit_tool_type;
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Material:"; color: #aaaaaa; }
                                    ComboBox {
                                        model: materials;
                                        current-value <=> edit_material;
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Coating:"; color: #aaaaaa; }
                                    ComboBox {
                                        model: coatings;
                                        current-value <=> edit_coating;
                                    }
                                }
                            }
                        }
                        
                        Rectangle { height: 1px; background: #404040; }
                        
                        // Geometry
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Tool Geometry"; }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Diameter (mm):"; color: #aaaaaa; }
                                    TMInput {
                                        text: edit_diameter;
                                        edited(val) => {
                                            edit_diameter = val.to-float();
                                        }
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Overall Length (mm):"; color: #aaaaaa; }
                                    TMInput {
                                        text: edit_length;
                                        edited(val) => {
                                            edit_length = val.to-float();
                                        }
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Flute Length (mm):"; color: #aaaaaa; }
                                    TMInput {
                                        text: edit_flute_length;
                                        edited(val) => {
                                            edit_flute_length = val.to-float();
                                        }
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Shaft Diameter (mm):"; color: #aaaaaa; }
                                    TMInput {
                                        text: edit_shaft_diameter;
                                        edited(val) => {
                                            edit_shaft_diameter = val.to-float();
                                        }
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Number of Flutes:"; color: #aaaaaa; }
                                    TMSpinBox {
                                        value <=> edit_flutes;
                                        minimum: 1;
                                        maximum: 12;
                                    }
                                }
                                
                                Rectangle {
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                        
                        Rectangle { height: 1px; background: #404040; }
                        
                        // Manufacturer Info
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Manufacturer Information"; }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    horizontal-stretch: 1;
                                    Text { text: "Manufacturer:"; color: #aaaaaa; }
                                    TMInput {
                                        text <=> edit_manufacturer;
                                        placeholder-text: "e.g., Harvey Tool";
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    horizontal-stretch: 1;
                                    Text { text: "Part Number:"; color: #aaaaaa; }
                                    TMInput {
                                        text <=> edit_part_number;
                                        placeholder-text: "e.g., EM-6-2F";
                                    }
                                }
                            }
                            
                            VerticalBox {
                                spacing: 5px;
                                Text { text: "Description:"; color: #aaaaaa; }
                                TextEdit {
                                    text <=> edit_description;
                                    height: 60px;
                                }
                            }
                        }
                        
                        Rectangle { height: 1px; background: #404040; }
                        
                        // Notes
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Notes"; }
                            
                            VerticalBox {
                                spacing: 5px;
                                TextEdit {
                                    text <=> edit_notes;
                                    height: 100px;
                                    placeholder-text: "Add any additional notes about this tool...";
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
