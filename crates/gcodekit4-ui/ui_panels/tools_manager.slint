// CNC Tools Manager UI Panel
// Provides CRUD interface for managing CNC tools database

import { Button, VerticalBox, HorizontalBox, ListView, LineEdit, ComboBox, TextEdit, 
         ScrollView, GroupBox, TabWidget, CheckBox, SpinBox } from "std-widgets.slint";
import { Theme } from "../ui/theme.slint";
import { StandardButton, StandardInput, StandardSpinBox, StandardSidebar } from "../ui/ui_components/shared.slint";

// Tool data structure for UI
export struct ToolData {
    id: string,
    number: int,
    name: string,
    tool_type: string,
    material: string,
    diameter: float,
    length: float,
    flute_length: float,
    shaft_diameter: float,
    flutes: int,
    coating: string,
    manufacturer: string,
    part_number: string,
    description: string,
    custom: bool,
    notes: string,
}

component TMSectionHeader inherits Text {
    color: Theme.text-primary;
    font-size: 14px;
    font-weight: 700;
}

export component ToolsManager inherits Rectangle {
    // Callbacks for CRUD operations
    callback load_tools();
    callback create_tool(ToolData);
    callback update_tool(ToolData);
    callback delete_tool(string /* id */);
    callback select_tool(string /* id */);
    callback search_tools(string /* query */);
    callback filter_by_type(string /* tool_type */);
    callback import_gtc_package(string /* file_path */);
    
    // Tool list data
    in-out property <[ToolData]> tools: [];
    in-out property <ToolData> selected_tool;
    in-out property <string> search_query: "";
    in-out property <bool> is_editing: false;
    in-out property <bool> is_creating: false;
    
    // Editable properties
    in-out property <string> edit_id: "";
    in-out property <int> edit_number: 1;
    in-out property <string> edit_name: "";
    in-out property <string> edit_tool_type: "Flat End Mill";
    in-out property <string> edit_material: "Carbide";
    in-out property <float> edit_diameter: 6.35;
    in-out property <float> edit_length: 50.0;
    in-out property <float> edit_flute_length: 20.0;
    in-out property <float> edit_shaft_diameter: 6.35;
    in-out property <int> edit_flutes: 2;
    in-out property <string> edit_coating: "None";
    in-out property <string> edit_manufacturer: "";
    in-out property <string> edit_part_number: "";
    in-out property <string> edit_description: "";
    in-out property <string> edit_notes: "";
    
    // Categories for ComboBox
    property <[string]> tool_types: [
        "Flat End Mill",
        "Ball End Mill",
        "Corner Radius End Mill",
        "V-Bit",
        "Drill Bit",
        "Spot Drill",
        "Engraving Bit",
        "Chamfer Tool",
        "Specialty"
    ];
    
    property <[string]> materials: ["HSS", "Carbide", "Coated Carbide", "Diamond"];
    property <[string]> coatings: ["None", "TiN", "TiAlN", "DLC", "AlOx"];
    
    background: Theme.background;
    
    VerticalBox {
        padding: 10px;
        spacing: 10px;
        
        // Header with search and actions
        HorizontalBox {
            spacing: 10px;
            height: 40px;
            
            Text {
                text: "CNC Tools Manager";
                font-size: 20px;
                font-weight: 700;
                color: Theme.text-primary;
                vertical-alignment: center;
            }
            
            Rectangle {
                horizontal-stretch: 1;
            }
            
            StandardInput {
                width: 250px;
                placeholder-text: "Search tools...";
                text <=> search_query;
                edited => {
                    root.search_tools(search_query);
                }
            }
            
            StandardButton {
                text: "âž• New Tool";
                primary: true;
                width: 100px;
                tooltip: "Create New Tool";
                clicked => {
                    is_creating = true;
                    is_editing = false;
                    edit_id = "";
                    edit_number = 1;
                    edit_name = "";
                    edit_tool_type = "Flat End Mill";
                    edit_material = "Carbide";
                    edit_diameter = 6.35;
                    edit_length = 50.0;
                    edit_flute_length = 20.0;
                    edit_shaft_diameter = 6.35;
                    edit_flutes = 2;
                    edit_coating = "None";
                    edit_manufacturer = "";
                    edit_part_number = "";
                    edit_description = "";
                    edit_notes = "";
                }
            }
            
            StandardButton {
                text: "ðŸ“¦ Import GTC";
                width: 100px;
                tooltip: "Import Tool Library (.gtc)";
                clicked => {
                    root.import_gtc_package("");
                }
            }
        }
        
        // Filter by type
        HorizontalBox {
            spacing: 10px;
            height: 30px;
            
            Text {
                text: "Filter by Type:";
                vertical-alignment: center;
                color: Theme.text-secondary;
            }
            
            ComboBox {
                model: ["All Types", "Flat End Mill", "Ball End Mill", "Corner Radius End Mill", 
                        "V-Bit", "Drill Bit", "Spot Drill", "Engraving Bit", "Chamfer Tool", "Specialty"];
                current-value: "All Types";
                width: 200px;
                selected => {
                    if (self.current-value == "All Types") {
                        root.load_tools();
                    } else {
                        root.filter_by_type(self.current-value);
                    }
                }
            }
        }
        
        // Main content area
        HorizontalBox {
            spacing: 10px;
            
            // Left panel - Tool list
            StandardSidebar {
                width: 350px; // Override width to match original design if needed
                
                VerticalBox {
                    padding: 10px;
                    spacing: 10px;
                    
                    Text {
                        text: "Tools (" + tools.length + ")";
                        font-size: 14px;
                        font-weight: 600;
                        color: Theme.text-primary;
                    }
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 5px;
                            
                            for tool[index] in tools: Rectangle {
                                height: 80px;
                                background: tool.id == selected_tool.id ? Theme.sidebar-item-selected : (touch.has-hover ? Theme.sidebar-item-hover : Theme.panel-background);
                                border-radius: 5px;
                                border-width: 1px;
                                border-color: tool.id == selected_tool.id ? Theme.primary : Theme.border;
                                
                                touch := TouchArea {
                                    clicked => {
                                        selected_tool = tool;
                                        root.select_tool(tool.id);
                                    }
                                    double-clicked => {
                                        selected_tool = tool;
                                        is_editing = true;
                                        is_creating = false;
                                        edit_id = tool.id;
                                        edit_number = tool.number;
                                        edit_name = tool.name;
                                        edit_tool_type = tool.tool_type;
                                        edit_material = tool.material;
                                        edit_diameter = tool.diameter;
                                        edit_length = tool.length;
                                        edit_flute_length = tool.flute_length;
                                        edit_shaft_diameter = tool.shaft_diameter;
                                        edit_flutes = tool.flutes;
                                        edit_coating = tool.coating;
                                        edit_manufacturer = tool.manufacturer;
                                        edit_part_number = tool.part_number;
                                        edit_description = tool.description;
                                        edit_notes = tool.notes;
                                    }
                                }
                                
                                HorizontalBox {
                                    padding: 10px;
                                    spacing: 10px;
                                    
                                    VerticalBox {
                                        spacing: 2px;
                                        
                                        HorizontalBox {
                                            spacing: 5px;
                                            
                                            Text {
                                                text: "T" + tool.number;
                                                font-size: 12px;
                                                font-weight: 700;
                                                color: tool.id == selected_tool.id ? white : Theme.primary;
                                            }
                                            
                                            Text {
                                                text: tool.name;
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: tool.id == selected_tool.id ? white : Theme.text-primary;
                                            }
                                        }
                                        
                                        Text {
                                            text: tool.tool_type;
                                            font-size: 10px;
                                            color: tool.id == selected_tool.id ? Theme.text-primary : Theme.text-secondary;
                                        }
                                        
                                        Text {
                                            text: "Ã˜" + tool.diameter + "mm Ã— " + tool.length + "mm";
                                            font-size: 10px;
                                            color: tool.id == selected_tool.id ? Theme.text-primary : Theme.text-secondary;
                                        }
                                        
                                        Text {
                                            text: tool.material + (tool.coating != "None" ? " (" + tool.coating + ")" : "");
                                            font-size: 9px;
                                            color: tool.id == selected_tool.id ? Theme.text-primary : Theme.text-muted;
                                        }
                                    }
                                    
                                    Rectangle {
                                        horizontal-stretch: 1;
                                    }
                                    
                                    if tool.custom: Rectangle {
                                        width: 50px;
                                        Text {
                                            text: "Custom";
                                            font-size: 9px;
                                            color: tool.id == selected_tool.id ? white : Theme.primary;
                                            font-weight: 600;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Right panel - Details or Edit form
            Rectangle {
                background: Theme.panel-background;
                border-radius: 5px;
                
                if !is_editing && !is_creating: VerticalBox {
                    alignment: center;
                    Text {
                        text: "Select a tool to view details\nor create a new tool";
                        font-size: 16px;
                        color: Theme.text-muted;
                        horizontal-alignment: center;
                    }
                }
                
                if is_editing || is_creating: ScrollView {
                    VerticalBox {
                        spacing: 15px;
                        padding: 20px;
                        
                        // Header
                        HorizontalBox {
                            spacing: 10px;
                            
                            Text {
                                text: is_creating ? "Create New Tool" : "Edit Tool";
                                font-size: 18px;
                                font-weight: 700;
                                color: Theme.text-primary;
                                horizontal-alignment: left;
                            }
                            
                            Rectangle {
                                horizontal-stretch: 1;
                            }
                            
                            StandardButton {
                                text: "ðŸ’¾ Save";
                                primary: true;
                                width: 80px;
                                tooltip: "Save Tool Changes";
                                clicked => {
                                    selected_tool = {
                                        id: edit_id,
                                        number: edit_number,
                                        name: edit_name,
                                        tool_type: edit_tool_type,
                                        material: edit_material,
                                        diameter: edit_diameter,
                                        length: edit_length,
                                        flute_length: edit_flute_length,
                                        shaft_diameter: edit_shaft_diameter,
                                        flutes: edit_flutes,
                                        coating: edit_coating,
                                        manufacturer: edit_manufacturer,
                                        part_number: edit_part_number,
                                        description: edit_description,
                                        custom: true,
                                        notes: edit_notes,
                                    };
                                    if (is_creating) {
                                        root.create_tool(selected_tool);
                                    } else {
                                        root.update_tool(selected_tool);
                                    }
                                    is_editing = false;
                                    is_creating = false;
                                }
                            }
                            
                            StandardButton {
                                text: "âŒ Cancel";
                                width: 80px;
                                tooltip: "Cancel Editing";
                                clicked => {
                                    is_editing = false;
                                    is_creating = false;
                                }
                            }
                            
                            if !is_creating && selected_tool.custom: StandardButton {
                                text: "ðŸ—‘ï¸ Delete";
                                destructive: true;
                                width: 80px;
                                tooltip: "Delete Tool";
                                clicked => {
                                    root.delete_tool(selected_tool.id);
                                    is_editing = false;
                                    is_creating = false;
                                }
                            }
                        }
                        
                        // Basic Information
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Basic Information"; }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Tool Number:"; color: Theme.text-secondary; }
                                    StandardSpinBox {
                                        value <=> edit_number;
                                        minimum: 1;
                                        maximum: 9999;
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    horizontal-stretch: 1;
                                    Text { text: "Tool Name:"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text <=> edit_name;
                                        placeholder-text: "e.g., 6mm Carbide End Mill";
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Tool Type:"; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: tool_types;
                                        current-value <=> edit_tool_type;
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Material:"; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: materials;
                                        current-value <=> edit_material;
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Coating:"; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: coatings;
                                        current-value <=> edit_coating;
                                    }
                                }
                            }
                        }
                        
                        Rectangle { height: 1px; background: Theme.border; }
                        
                        // Geometry
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Tool Geometry"; }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Diameter (mm):"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_diameter;
                                        edited(val) => {
                                            edit_diameter = val.to-float();
                                        }
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Overall Length (mm):"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_length;
                                        edited(val) => {
                                            edit_length = val.to-float();
                                        }
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Flute Length (mm):"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_flute_length;
                                        edited(val) => {
                                            edit_flute_length = val.to-float();
                                        }
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Shaft Diameter (mm):"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_shaft_diameter;
                                        edited(val) => {
                                            edit_shaft_diameter = val.to-float();
                                        }
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text { text: "Number of Flutes:"; color: Theme.text-secondary; }
                                    StandardSpinBox {
                                        value <=> edit_flutes;
                                        minimum: 1;
                                        maximum: 12;
                                    }
                                }
                                
                                Rectangle {
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                        
                        Rectangle { height: 1px; background: Theme.border; }
                        
                        // Manufacturer Info
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Manufacturer Information"; }
                            
                            HorizontalBox {
                                spacing: 10px;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    horizontal-stretch: 1;
                                    Text { text: "Manufacturer:"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text <=> edit_manufacturer;
                                        placeholder-text: "e.g., Harvey Tool";
                                    }
                                }
                                
                                VerticalBox {
                                    spacing: 5px;
                                    horizontal-stretch: 1;
                                    Text { text: "Part Number:"; color: Theme.text-secondary; }
                                    StandardInput {
                                        text <=> edit_part_number;
                                        placeholder-text: "e.g., EM-6-2F";
                                    }
                                }
                            }
                            
                            VerticalBox {
                                spacing: 5px;
                                Text { text: "Description:"; color: Theme.text-secondary; }
                                TextEdit {
                                    text <=> edit_description;
                                    height: 60px;
                                }
                            }
                        }
                        
                        Rectangle { height: 1px; background: Theme.border; }
                        
                        // Notes
                        VerticalBox {
                            spacing: 10px;
                            TMSectionHeader { text: "Notes"; }
                            
                            VerticalBox {
                                spacing: 5px;
                                TextEdit {
                                    text <=> edit_notes;
                                    height: 100px;
                                    placeholder-text: "Add any additional notes about this tool...";
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
