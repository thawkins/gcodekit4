/// Machine Control Panel Component
/// Displays position (DRO), jog controls, and coordinate system buttons

import { Button, ComboBox, LineEdit, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";

component MCToolButton inherits Rectangle {
    in property <string> text;
    in property <string> icon;
    in property <string> tooltip;
    in property <bool> checkable: false;
    in property <bool> checked: false;
    in property <bool> enabled: true;
    in property <brush> base-color: #34495e;
    in property <brush> hover-color: #3d566e;
    in property <brush> checked-color: #2980b9;
    
    callback clicked;
    
    height: 40px;
    background: !root.enabled ? #2c3e50 : (root.checked ? root.checked-color : (touch.has-hover ? root.hover-color : root.base-color));
    border-radius: 4px;
    opacity: root.enabled ? 1.0 : 0.5;
    
    HorizontalBox {
        padding: 5px;
        spacing: 8px;
        alignment: center;
        
        if (root.icon != "") : Text {
            text: root.icon;
            font-size: 18px;
            color: #ecf0f1;
            vertical-alignment: center;
        }
        
        if (root.text != "") : Text {
            text: root.text;
            font-size: 13px;
            color: #ecf0f1;
            vertical-alignment: center;
        }
    }
    
    touch := TouchArea {
        enabled: root.enabled;
        clicked => { root.clicked(); }
    }
    
    if (touch.has-hover && root.tooltip != "") : Rectangle {
        y: parent.height + 5px;
        x: (parent.width - self.width) / 2;
        width: tt-text.preferred-width + 10px;
        height: 24px;
        background: #222222;
        border-radius: 3px;
        border-width: 1px;
        border-color: #555555;
        z: 100;
        tt-text := Text {
            text: root.tooltip;
            color: white;
            font-size: 11px;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }
}

component DROAxis inherits Rectangle {
    in property <string> label;
    in property <string> value;
    in property <bool> active: false;
    callback zero-clicked;
    
    height: 60px;
    background: #252526;
    border-radius: 4px;
    border-width: 1px;
    border-color: #333;
    
    HorizontalBox {
        padding: 10px;
        spacing: 15px;
        alignment: center;
        
        // Axis Label
        Text {
            text: root.label;
            font-size: 32px;
            font-weight: 700;
            color: root.active ? #2ecc71 : #7f8c8d;
            width: 40px;
            vertical-alignment: center;
        }
        
        // Value
        Text {
            text: root.value;
            font-size: 32px;
            font-family: "Fira Code"; // Monospace if available
            color: #ecf0f1;
            horizontal-alignment: right;
            vertical-alignment: center;
            width: 200px;
        }
        
        // Zero Button
        Rectangle {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: zero-touch.has-hover ? #34495e : #2c3e50;
            border-width: 1px;
            border-color: #34495e;
            
            Text {
                text: "âŠ™";
                font-size: 20px;
                color: #ecf0f1;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
            
            zero-touch := TouchArea {
                clicked => { root.zero-clicked(); }
            }
        }
    }
}

component JogArrowButton inherits Rectangle {
    in property <string> text;
    callback clicked;
    
    width: 60px;
    height: 60px;
    background: touch.pressed ? #2980b9 : (touch.has-hover ? #34495e : #2c3e50);
    border-radius: 8px;
    border-width: 1px;
    border-color: #34495e;
    
    Text {
        text: root.text;
        font-size: 24px;
        color: #ecf0f1;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

component StepSizeButton inherits Rectangle {
    in property <string> text;
    in property <bool> selected: false;
    callback clicked;
    
    width: 50px;
    height: 30px;
    background: root.selected ? #2980b9 : (touch.has-hover ? #34495e : #2c3e50);
    border-radius: 4px;
    
    Text {
        text: root.text;
        font-size: 12px;
        color: #ecf0f1;
        horizontal-alignment: center;
        vertical-alignment: center;
        font-weight: root.selected ? 700 : 400;
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

export component MachineControlPanel inherits Rectangle {
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    background: #1e1e1e;
    
    in property <bool> connected: false;
    in property <float> position-x: 0.0;
    in property <float> position-y: 0.0;
    in property <float> position-z: 0.0;
    in property <float> position-a: 0.0;
    in property <float> position-b: 0.0;
    in property <float> position-c: 0.0;
    in property <float> feed-rate: 0.0;
    in property <float> spindle-speed: 0.0;
    in property <string> machine-state: "DISCONNECTED";
    
    callback jog-home-clicked();
    callback jog-x-positive(float);
    callback jog-x-negative(float);
    callback jog-y-positive(float);
    callback jog-y-negative(float);
    callback jog-z-positive(float);
    callback jog-z-negative(float);
    callback jog-a-positive(float);
    callback jog-a-negative(float);
    callback jog-b-positive(float);
    callback jog-b-negative(float);
    callback unlock-clicked();
    callback send-command(string);
    
    private property <float> step-size: 1.0;
    private property <int> step-index: 1;
    
    // Connection controls passed from parent
    in property <[string]> available-ports;
    in property <string> selected-port;
    callback port-selected(string);
    callback connect-clicked();
    callback disconnect-clicked();
    callback refresh-ports-clicked();
    
    HorizontalLayout {
        spacing: 0px;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEFT SIDEBAR: Controls
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        Rectangle {
            width: 250px;
            background: #2c3e50;
            
            VerticalLayout {
                padding: 15px;
                spacing: 20px;
                alignment: start;
                
                // Connection Section
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Connection"; color: #bdc3c7; font-size: 12px; font-weight: 700; }
                    
                    ComboBox {
                        model: root.available-ports;
                        current-value: root.selected-port;
                        height: 35px;
                        selected(value) => { root.port-selected(value); }
                    }
                    
                    HorizontalLayout {
                        spacing: 10px;
                        MCToolButton {
                            text: root.connected ? "Disconnect" : "Connect";
                            icon: root.connected ? "ðŸ”Œ" : "ðŸ”—";
                            base-color: root.connected ? #c0392b : #27ae60;
                            hover-color: root.connected ? #e74c3c : #2ecc71;
                            clicked => {
                                if (root.connected) { root.disconnect-clicked(); }
                                else { root.connect-clicked(); }
                            }
                        }
                        MCToolButton {
                            icon: "ðŸ”„";
                            width: 40px;
                            tooltip: "Refresh Ports";
                            clicked => { root.refresh-ports-clicked(); }
                        }
                    }
                }
                
                // Machine State Section
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Machine State"; color: #bdc3c7; font-size: 12px; font-weight: 700; }
                    
                    Rectangle {
                        height: 40px;
                        background: #34495e;
                        border-radius: 4px;
                        
                        Text {
                            text: root.machine-state;
                            color: root.machine-state == "ALARM" ? #e74c3c : 
                                   (root.machine-state == "Run" ? #2ecc71 : 
                                   (root.machine-state == "Idle" ? #f1c40f : #ecf0f1));
                            font-size: 16px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                    
                    HorizontalLayout {
                        spacing: 10px;
                        MCToolButton {
                            text: "Home";
                            icon: "âŒ‚";
                            enabled: root.connected && root.machine-state != "Run";
                            clicked => { root.jog-home-clicked(); }
                        }
                        MCToolButton {
                            text: "Unlock";
                            icon: "ðŸ”“";
                            enabled: root.connected && (root.machine-state == "ALARM" || root.machine-state == "Alarm");
                            clicked => { root.unlock-clicked(); }
                        }
                    }
                }
                
                // Work Coordinate Systems
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Work Coordinates"; color: #bdc3c7; font-size: 12px; font-weight: 700; }
                    
                    GridLayout {
                        spacing: 5px;
                        Row {
                            MCToolButton { text: "G54"; clicked => { root.send-command("G54"); } }
                            MCToolButton { text: "G55"; clicked => { root.send-command("G55"); } }
                            MCToolButton { text: "G56"; clicked => { root.send-command("G56"); } }
                        }
                        Row {
                            MCToolButton { text: "G57"; clicked => { root.send-command("G57"); } }
                            MCToolButton { text: "G58"; clicked => { root.send-command("G58"); } }
                            MCToolButton { text: "G59"; clicked => { root.send-command("G59"); } }
                        }
                    }
                }
            }
            
            // Right border separator
            Rectangle {
                width: 1px;
                height: 100%;
                x: parent.width - 1px;
                background: #34495e;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN AREA: DRO & Jog
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        VerticalLayout {
            padding: 30px;
            spacing: 40px;
            alignment: start;
            
            // Digital Readout (DRO)
            VerticalLayout {
                spacing: 10px;
                alignment: center;
                
                DROAxis {
                    label: "X";
                    value: round(root.position-x * 1000.0) / 1000.0;
                    active: true;
                    zero-clicked => { root.send-command("G92 X0"); }
                }
                DROAxis {
                    label: "Y";
                    value: round(root.position-y * 1000.0) / 1000.0;
                    active: true;
                    zero-clicked => { root.send-command("G92 Y0"); }
                }
                DROAxis {
                    label: "Z";
                    value: round(root.position-z * 1000.0) / 1000.0;
                    active: true;
                    zero-clicked => { root.send-command("G92 Z0"); }
                }
            }
            
            // Jog Controls
            VerticalLayout {
                spacing: 20px;
                alignment: center;
                
                // Step Size Selector
                HorizontalLayout {
                    alignment: center;
                    spacing: 5px;
                    Text { text: "Step (mm):"; color: #bdc3c7; vertical-alignment: center; font-size: 14px; }
                    Rectangle { width: 10px; }
                    
                    StepSizeButton { text: "0.1"; selected: root.step-index == 0; clicked => { root.step-index = 0; root.step-size = 0.1; } }
                    StepSizeButton { text: "1.0"; selected: root.step-index == 1; clicked => { root.step-index = 1; root.step-size = 1.0; } }
                    StepSizeButton { text: "10"; selected: root.step-index == 2; clicked => { root.step-index = 2; root.step-size = 10.0; } }
                    StepSizeButton { text: "50"; selected: root.step-index == 3; clicked => { root.step-index = 3; root.step-size = 50.0; } }
                }
                
                // Directional Pads
                HorizontalLayout {
                    alignment: center;
                    spacing: 60px;
                    
                    // XY Pad
                    GridLayout {
                        spacing: 5px;
                        Row {
                            Rectangle { width: 60px; height: 60px; } // Empty top-left
                            JogArrowButton { text: "â–²"; clicked => { root.jog-y-positive(root.step-size); } }
                            Rectangle { width: 60px; height: 60px; } // Empty top-right
                        }
                        Row {
                            JogArrowButton { text: "â—€"; clicked => { root.jog-x-negative(root.step-size); } }
                            Rectangle { // Center Home
                                width: 60px; height: 60px;
                                background: #2c3e50;
                                border-radius: 30px;
                                Text { text: "XY"; color: #7f8c8d; font-size: 14px; horizontal-alignment: center; vertical-alignment: center; }
                            }
                            JogArrowButton { text: "â–¶"; clicked => { root.jog-x-positive(root.step-size); } }
                        }
                        Row {
                            Rectangle { width: 60px; height: 60px; } // Empty bottom-left
                            JogArrowButton { text: "â–¼"; clicked => { root.jog-y-negative(root.step-size); } }
                            Rectangle { width: 60px; height: 60px; } // Empty bottom-right
                        }
                    }
                    
                    // Z Pad
                    VerticalLayout {
                        alignment: center;
                        spacing: 5px;
                        JogArrowButton { text: "â–²"; clicked => { root.jog-z-positive(root.step-size); } }
                        Rectangle { 
                            height: 60px; 
                            Text { text: "Z"; color: #7f8c8d; font-size: 18px; horizontal-alignment: center; vertical-alignment: center; }
                        }
                        JogArrowButton { text: "â–¼"; clicked => { root.jog-z-negative(root.step-size); } }
                    }
                }
            }
        }
    }
}
