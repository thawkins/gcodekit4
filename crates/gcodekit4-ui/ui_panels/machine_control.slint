/// Machine Control Panel Component
/// Displays position (DRO), jog controls, and coordinate system buttons

import { Button, ComboBox, LineEdit, VerticalBox, HorizontalBox, ScrollView, GridBox } from "std-widgets.slint";
import { Theme } from "../ui/theme.slint";
import { StandardButton, StandardSidebar, StandardTooltip } from "../ui/ui_components/shared.slint";

component DROAxis inherits Rectangle {
    in property <string> label;
    in property <string> value;
    in property <bool> active: false;
    callback zero-clicked;
    
    height: 60px;
    background: #252526;
    border-radius: 4px;
    border-width: 1px;
    border-color: #333;
    
    HorizontalBox {
        padding: 10px;
        spacing: 15px;
        alignment: center;
        
        // Axis Label
        Text {
            text: root.label;
            font-size: 32px;
            font-weight: 700;
            color: root.active ? Theme.success : Theme.text-muted;
            width: 40px;
            vertical-alignment: center;
        }
        
        // Value
        Text {
            text: root.value;
            font-size: 32px;
            font-family: "Fira Code"; // Monospace if available
            color: Theme.text-primary;
            horizontal-alignment: right;
            vertical-alignment: center;
            width: 200px;
        }
        
        // Zero Button
        Rectangle {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: zero-touch.has-hover ? Theme.sidebar-item-selected : Theme.sidebar-background;
            border-width: 1px;
            border-color: Theme.sidebar-item-selected;
            
            Text {
                text: "âŠ™";
                font-size: 20px;
                color: Theme.text-primary;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
            
            zero-touch := TouchArea {
                clicked => { root.zero-clicked(); }
            }
            
            StandardTooltip {
                text: "Zero " + root.label + " Axis";
                show: zero-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2;
            }
        }
    }
}

component JogArrowButton inherits Rectangle {
    in property <string> text;
    in property <string> tooltip;
    callback clicked;
    
    width: 60px;
    height: 60px;
    background: touch.pressed ? Theme.primary-pressed : (touch.has-hover ? Theme.sidebar-item-selected : Theme.sidebar-background);
    border-radius: 8px;
    border-width: 1px;
    border-color: Theme.sidebar-item-selected;
    
    Text {
        text: root.text;
        font-size: 24px;
        color: Theme.text-primary;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
    
    StandardTooltip {
        text: root.tooltip;
        show: touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2;
    }
}

component StepSizeButton inherits Rectangle {
    in property <string> text;
    in property <bool> selected: false;
    callback clicked;
    
    width: 50px;
    height: 30px;
    background: root.selected ? Theme.primary-pressed : (touch.has-hover ? Theme.sidebar-item-selected : Theme.sidebar-background);
    border-radius: 4px;
    
    Text {
        text: root.text;
        font-size: 12px;
        color: Theme.text-primary;
        horizontal-alignment: center;
        vertical-alignment: center;
        font-weight: root.selected ? 700 : 400;
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
    
    StandardTooltip {
        text: "Set Step to " + root.text + "mm";
        show: touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2;
    }
}

export component MachineControlPanel inherits Rectangle {
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    background: Theme.background;
    
    in property <bool> connected: false;
    in property <float> position-x: 0.0;
    in property <float> position-y: 0.0;
    in property <float> position-z: 0.0;
    in property <float> work-position-x: 0.0;
    in property <float> work-position-y: 0.0;
    in property <float> work-position-z: 0.0;
    in property <float> position-a: 0.0;
    in property <float> position-b: 0.0;
    in property <float> position-c: 0.0;
    in property <float> feed-rate: 0.0;
    in property <float> spindle-speed: 0.0;
    in property <string> machine-state: "DISCONNECTED";
    in property <string> raw-status-response: "";
    
    callback jog-home-clicked();
    callback jog-x-positive(float);
    callback jog-x-negative(float);
    callback jog-y-positive(float);
    callback jog-y-negative(float);
    callback jog-z-positive(float);
    callback jog-z-negative(float);
    callback jog-a-positive(float);
    callback jog-a-negative(float);
    callback jog-b-positive(float);
    callback jog-b-negative(float);
    callback unlock-clicked();
    callback zero-all-clicked();
    callback emergency-stop-clicked();
    callback send-command(string);
    
    // Transmission controls
    callback command-send();
    callback command-pause();
    callback command-resume();
    callback command-stop();
    
    private property <float> step-size: 1.0;
    private property <int> step-index: 1;
    
    // Connection controls passed from parent
    in property <[string]> available-ports;
    in property <string> selected-port;
    callback port-selected(string);
    callback connect-clicked();
    callback disconnect-clicked();
    callback refresh-ports-clicked();
    
    HorizontalLayout {
        spacing: 0px;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEFT SIDEBAR: Controls
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        StandardSidebar {
            VerticalLayout {
                padding: Theme.padding;
                spacing: Theme.spacing;
                alignment: start;
                
                // Connection Section
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Connection"; color: Theme.text-secondary; font-size: 12px; font-weight: 700; }
                    
                    ComboBox {
                        model: root.available-ports;
                        current-value: root.selected-port;
                        height: 35px;
                        selected(value) => { root.port-selected(value); }
                    }
                    
                    HorizontalLayout {
                        spacing: 10px;
                        StandardButton {
                            text: root.connected ? "Disconnect" : "Connect";
                            icon: root.connected ? "ðŸ”Œ" : "ðŸ”—";
                            primary: !root.connected;
                            destructive: root.connected;
                            tooltip: root.connected ? "Disconnect from Machine" : "Connect to Machine";
                            clicked => {
                                if (root.connected) { root.disconnect-clicked(); }
                                else { root.connect-clicked(); }
                            }
                        }
                        StandardButton {
                            icon: "ðŸ”„";
                            width: 40px;
                            tooltip: "Refresh Serial Ports";
                            clicked => { root.refresh-ports-clicked(); }
                        }
                    }
                }
                
                // Transmission Control Section
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Transmission"; color: Theme.text-secondary; font-size: 12px; font-weight: 700; }
                    
                    HorizontalLayout {
                        spacing: 10px;
                        StandardButton {
                            text: "Send";
                            icon: "â–¶";
                            primary: true;
                            tooltip: "Send G-Code to Device";
                            enabled: root.connected;
                            clicked => { root.command-send(); }
                        }
                        StandardButton {
                            text: "Stop";
                            icon: "â¹";
                            destructive: true;
                            tooltip: "Stop Transmission";
                            enabled: root.connected;
                            clicked => { root.command-stop(); }
                        }
                    }
                    
                    HorizontalLayout {
                        spacing: 10px;
                        StandardButton {
                            text: "Pause";
                            icon: "â¸";
                            tooltip: "Pause Transmission";
                            enabled: root.connected;
                            clicked => { root.command-pause(); }
                        }
                        StandardButton {
                            text: "Resume";
                            icon: "â¯";
                            tooltip: "Resume Transmission";
                            enabled: root.connected;
                            clicked => { root.command-resume(); }
                        }
                    }
                }
                
                // Machine State Section
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Machine State"; color: Theme.text-secondary; font-size: 12px; font-weight: 700; }
                    
                    Rectangle {
                        height: 40px;
                        background: Theme.sidebar-item-selected;
                        border-radius: 4px;
                        
                        Text {
                            text: root.machine-state;
                            color: root.machine-state == "ALARM" ? Theme.danger : 
                                   (root.machine-state == "Run" ? Theme.success : 
                                   (root.machine-state == "Idle" ? Theme.warning : Theme.text-primary));
                            font-size: 16px;
                            font-weight: 700;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                    
                    HorizontalLayout {
                        spacing: 10px;
                        StandardButton {
                            text: "Home";
                            icon: "âŒ‚";
                            tooltip: "Homing Cycle ($H)";
                            enabled: root.connected && root.machine-state != "Run";
                            clicked => { root.jog-home-clicked(); }
                        }
                        StandardButton {
                            text: "Unlock";
                            icon: "ðŸ”“";
                            tooltip: "Unlock Alarm ($X)";
                            enabled: root.connected && (root.machine-state == "ALARM" || root.machine-state == "Alarm");
                            clicked => { root.unlock-clicked(); }
                        }
                    }
                }
                
                // Work Coordinate Systems
                VerticalLayout {
                    spacing: 10px;
                    Text { text: "Work Coordinates"; color: Theme.text-secondary; font-size: 12px; font-weight: 700; }
                    
                    StandardButton { 
                        text: "Reset (G53)"; 
                        tooltip: "Reset to Machine Coordinates (G53)"; 
                        clicked => { root.send-command("G53"); } 
                    }
                    
                    GridLayout {
                        spacing: 5px;
                        Row {
                            StandardButton { text: "G54"; tooltip: "Select WCS G54"; clicked => { root.send-command("G54"); } }
                            StandardButton { text: "G55"; tooltip: "Select WCS G55"; clicked => { root.send-command("G55"); } }
                            StandardButton { text: "G56"; tooltip: "Select WCS G56"; clicked => { root.send-command("G56"); } }
                        }
                        Row {
                            StandardButton { text: "G57"; tooltip: "Select WCS G57"; clicked => { root.send-command("G57"); } }
                            StandardButton { text: "G58"; tooltip: "Select WCS G58"; clicked => { root.send-command("G58"); } }
                            StandardButton { text: "G59"; tooltip: "Select WCS G59"; clicked => { root.send-command("G59"); } }
                        }
                    }
                }
                
                // Status Message
                VerticalLayout {
                    spacing: 5px;
                    Text { text: "Status Message:"; color: Theme.text-secondary; font-size: 12px; font-weight: 700; }
                    
                    Rectangle {
                        background: Theme.sidebar-item-selected;
                        border-radius: 4px;
                        min-height: 60px;
                        
                        Text {
                            text: root.raw-status-response;
                            color: Theme.text-primary;
                            font-size: 11px;
                            font-family: "Fira Code";
                            wrap: word-wrap;
                            vertical-alignment: top;
                            x: 5px;
                            y: 5px;
                            width: parent.width - 10px;
                        }
                    }
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN AREA: DRO & Jog
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        VerticalLayout {
            padding: 30px;
            spacing: 40px;
            alignment: start;
            
            // Digital Readout (DRO)
            VerticalLayout {
                spacing: 10px;
                alignment: center;
                
                DROAxis {
                    label: "X";
                    value: round(root.work-position-x * 1000.0) / 1000.0;
                    active: true;
                    zero-clicked => { root.send-command("G92 X0"); }
                }
                DROAxis {
                    label: "Y";
                    value: round(root.work-position-y * 1000.0) / 1000.0;
                    active: true;
                    zero-clicked => { root.send-command("G92 Y0"); }
                }
                DROAxis {
                    label: "Z";
                    value: round(root.work-position-z * 1000.0) / 1000.0;
                    active: true;
                    zero-clicked => { root.send-command("G92 Z0"); }
                }

                Rectangle { height: 10px; }

                StandardButton {
                    text: "Zero All Axes";
                    icon: "âŠ™";
                    tooltip: "Zero X, Y, and Z Axes (G92 X0 Y0 Z0)";
                    clicked => { root.zero-all-clicked(); }
                }

                Rectangle { height: 20px; }

                // Machine Coordinates (World Coordinates)
                VerticalLayout {
                    spacing: 5px;
                    Text { 
                        text: "World Coordinates (G53)"; 
                        color: Theme.text-secondary; 
                        font-size: 12px; 
                        font-weight: 700; 
                        horizontal-alignment: center;
                    }
                    
                    HorizontalLayout {
                        spacing: 20px;
                        alignment: center;
                        
                        Text { 
                            text: "X: " + (round(root.position-x * 1000.0) / 1000.0); 
                            color: Theme.text-muted; 
                            font-family: "Fira Code";
                        }
                        Text { 
                            text: "Y: " + (round(root.position-y * 1000.0) / 1000.0); 
                            color: Theme.text-muted; 
                            font-family: "Fira Code";
                        }
                        Text { 
                            text: "Z: " + (round(root.position-z * 1000.0) / 1000.0); 
                            color: Theme.text-muted; 
                            font-family: "Fira Code";
                        }
                    }
                }
            }
            
            // Jog Controls
            VerticalLayout {
                spacing: 20px;
                alignment: center;
                
                // Step Size Selector
                HorizontalLayout {
                    alignment: center;
                    spacing: 5px;
                    Text { text: "Step (mm):"; color: Theme.text-secondary; vertical-alignment: center; font-size: 14px; }
                    Rectangle { width: 10px; }
                    
                    StepSizeButton { text: "0.1"; selected: root.step-index == 0; clicked => { root.step-index = 0; root.step-size = 0.1; } }
                    StepSizeButton { text: "1.0"; selected: root.step-index == 1; clicked => { root.step-index = 1; root.step-size = 1.0; } }
                    StepSizeButton { text: "10"; selected: root.step-index == 2; clicked => { root.step-index = 2; root.step-size = 10.0; } }
                    StepSizeButton { text: "50"; selected: root.step-index == 3; clicked => { root.step-index = 3; root.step-size = 50.0; } }
                }
                
                // Directional Pads
                HorizontalLayout {
                    alignment: center;
                    spacing: 60px;
                    
                    // XY Pad
                    GridLayout {
                        spacing: 5px;
                        Row {
                            Rectangle { width: 60px; height: 60px; } // Empty top-left
                            JogArrowButton { text: "â–²"; tooltip: "Jog Y+"; clicked => { root.jog-y-positive(root.step-size); } }
                            Rectangle { width: 60px; height: 60px; } // Empty top-right
                        }
                        Row {
                            JogArrowButton { text: "â—€"; tooltip: "Jog X-"; clicked => { root.jog-x-negative(root.step-size); } }
                            Rectangle { // Center Home
                                width: 60px; height: 60px;
                                background: Theme.sidebar-background;
                                border-radius: 30px;
                                Text { text: "XY"; color: Theme.text-muted; font-size: 14px; horizontal-alignment: center; vertical-alignment: center; }
                            }
                            JogArrowButton { text: "â–¶"; tooltip: "Jog X+"; clicked => { root.jog-x-positive(root.step-size); } }
                        }
                        Row {
                            Rectangle { width: 60px; height: 60px; } // Empty bottom-left
                            JogArrowButton { text: "â–¼"; tooltip: "Jog Y-"; clicked => { root.jog-y-negative(root.step-size); } }
                            Rectangle { width: 60px; height: 60px; } // Empty bottom-right
                        }
                    }
                    
                    // Z Pad and eStop
                    HorizontalLayout {
                        spacing: 20px;
                        alignment: center;
                        
                        // Z Pad
                        VerticalLayout {
                            alignment: center;
                            spacing: 5px;
                            JogArrowButton { text: "â–²"; tooltip: "Jog Z+"; clicked => { root.jog-z-positive(root.step-size); } }
                            Rectangle { 
                                height: 60px; 
                                Text { text: "Z"; color: Theme.text-muted; font-size: 18px; horizontal-alignment: center; vertical-alignment: center; }
                            }
                            JogArrowButton { text: "â–¼"; tooltip: "Jog Z-"; clicked => { root.jog-z-negative(root.step-size); } }
                        }
                        
                        // Emergency Stop Button
                        Rectangle {
                            width: 190px;
                            height: 190px;
                            background: transparent;
                            
                            Image {
                                source: @image-url("../../../assets/Pictures/eStop2.png");
                                width: 100%;
                                height: 100%;
                                image-fit: contain;
                            }
                            
                            estop-touch := TouchArea {
                                clicked => { root.emergency-stop-clicked(); }
                            }
                            
                            StandardTooltip {
                                text: "Emergency Stop";
                                show: estop-touch.has-hover; y: parent.height + 5px; x: (parent.width - self.width) / 2;
                            }
                        }
                    }
                }
            }
        }
    }
}
