/// G-Code Editor Panel Component
/// Displays the G-code text editor with file operations toolbar and undo/redo

import { Button, LineEdit, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { CustomTextEdit } from "../ui/ui_components/custom_text_edit.slint";

export struct TextLine {
    line_number: int,
    content: string,
    is_dirty: bool,
}

component EditorToolButton inherits Rectangle {
    in property <string> icon;
    in property <string> text;
    in property <string> tooltip;
    in property <bool> enabled: true;
    callback clicked;
    
    width: 40px;
    height: 40px;
    background: touch.has-hover ? #34495e : #2c3e50;
    border-radius: 4px;
    border-width: 1px;
    border-color: #34495e;
    opacity: root.enabled ? 1.0 : 0.5;
    
    Text {
        text: root.icon;
        font-size: 20px;
        color: #ecf0f1;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    touch := TouchArea { 
        mouse-cursor: root.enabled ? pointer : default;
        enabled: root.enabled;
        clicked => { root.clicked(); } 
    }
    
    if (touch.has-hover && root.tooltip != "") : Rectangle {
        y: parent.height + 5px;
        x: (parent.width - self.width) / 2;
        width: tt-text.preferred-width + 10px;
        height: 24px;
        background: #222222;
        border-radius: 3px;
        border-width: 1px;
        border-color: #555555;
        z: 100;
        tt-text := Text {
            text: root.tooltip;
            color: white;
            font-size: 11px;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }
}

export component GcodeEditorPanel inherits Rectangle {
    forward-focus: editor-focus;
   
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    background: #2c3e50;
    
    in-out property <string> gcode-content: "";
    in-out property <string> gcode-filename: "untitled.gcode";
    in-out property <int> focus-trigger: 0;  // Incrementing this triggers focus on editor
    
    // Custom editor properties
    in-out property <bool> can-undo: false;
    in-out property <bool> can-redo: false;
    in-out property <int> cursor-line: 1;
    in-out property <int> cursor-column: 1;
    in-out property <[TextLine]> visible-lines: [];
    in-out property <int> total-lines: 0;
    in-out property <int> visible-start-line: 0;
    in property <bool> cursor-blink-visible: true;
    
    // Focus when focus-trigger changes
    changed focus-trigger => {
        editor-focus.focus();
    }
    
    
    callback menu-send-to-device();
    callback menu-stop-transmission();
    callback menu-pause-transmission();
    callback menu-resume-transmission();
    
    // Custom editor callbacks
    callback undo_requested();
    callback redo_requested();
    callback text_changed(string);
    callback text_inserted(int, int, string);  // line, col, text
    callback text_deleted(int, int, int, int);  // start-line, start-col, end-line, end-col
    callback cursor_moved(int, int);
    callback scroll_changed(int);
    callback end_key_pressed();  // End key pressed - let Rust handle line-end positioning
    callback ctrl_home_pressed();  // Ctrl+Home - jump to beginning of file
    callback ctrl_end_pressed();  // Ctrl+End - jump to end of file
    callback request_focus();  // Called when panel becomes visible/active
    callback key_pressed_event(string);  // Forward key events
    callback editor_clicked();  // Debug: Track mouse clicks on editor
    
    HorizontalLayout {
        spacing: 0px;
        padding: 0px;

        // ═════════════════════════════════════════════
        // LEFT SIDEBAR: Controls
        // ═════════════════════════════════════════════
        Rectangle {
            width: 200px;
            horizontal-stretch: 0;
            background: #2c3e50;

            VerticalLayout {
                padding: 10px;
                spacing: 10px;
                alignment: start;

                Text {
                    text: "Editor";
                    font-weight: 700;
                    font-size: 14px;
                    color: #ecf0f1;
                }

                Rectangle { height: 10px; }

                Text {
                    text: "Transmission";
                    font-weight: 700;
                    font-size: 12px;
                    color: #bdc3c7;
                }

                HorizontalLayout {
                    spacing: 5px;
                    EditorToolButton {
                        icon: "▶";
                        tooltip: "Send";
                        enabled: root.gcode-content != "";
                        clicked => { root.menu-send-to-device(); }
                    }
                    EditorToolButton {
                        icon: "⏸";
                        tooltip: "Pause";
                        clicked => { root.menu-pause-transmission(); }
                    }
                    EditorToolButton {
                        icon: "▶"; // Resume icon same as play usually, or maybe ⏯
                        text: "R"; // Fallback if icon font issue
                        tooltip: "Resume";
                        clicked => { root.menu-resume-transmission(); }
                    }
                    EditorToolButton {
                        icon: "⏹";
                        tooltip: "Stop";
                        clicked => { root.menu-stop-transmission(); }
                    }
                }
            }
            
            // Right border separator
            Rectangle {
                width: 1px;
                height: 100%;
                x: parent.width - 1px;
                background: #34495e;
            }
        }

        // ═════════════════════════════════════════════
        // CENTER: Editor Area
        // ═════════════════════════════════════════════
        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            background: #1e1e1e; // Keep dark editor background
            clip: true;
            
            // Wrapper FocusScope for editor focus management
            editor-focus := FocusScope {
                width: 100%;
                height: 100%;
                
                key-pressed(event) => {
                    return reject;  // Let it bubble to CustomTextEdit
                }
                
                touch-area := TouchArea {
                    clicked => {
                        root.editor_clicked();
                        editor-focus.focus();
                    }
                }
                
                // Custom G-Code Editor with virtual scrolling
                custom-editor := CustomTextEdit {
                    width: 100%;
                    height: 100%;
                    text: root.gcode-content;
                    can-undo: root.can-undo;
                    can-redo: root.can-redo;
                    cursor-line <=> root.cursor-line;
                    cursor-column <=> root.cursor-column;
                    visible-lines <=> root.visible-lines;
                    visible-start-line <=> root.visible-start-line;
                    total-lines <=> root.total-lines;
                    show-line-numbers: true;
                    focus-trigger <=> root.focus-trigger;
                    cursor-blink-visible: root.cursor-blink-visible;
                    
                    // Theme overrides
                    background-color: #1e1e1e;
                    gutter-background-color: #2c3e50;
                    text-color: #ecf0f1;
                    line-number-color: #bdc3c7;
                    current-line-color: #34495e;
                    
                    text-changed(text) => {
                        root.gcode-content = text;
                        root.text-changed(text);
                    }
                    
                    undo-requested => {
                        root.undo_requested();
                    }
                    
                    redo-requested => {
                        root.redo_requested();
                    }
                    
                    scroll-changed(line) => {
                        // update panel visible start line for status indicator
                        root.visible-start-line = line;
                        root.scroll-changed(line);
                    }
                    
                    cursor-moved(line, col) => {
                        root.cursor_moved(line, col);
                    }
                    
                    end-key-pressed() => {
                        root.end_key_pressed();
                    }
                    
                    ctrl-home-pressed() => {
                        root.ctrl_home_pressed();
                    }
                    
                    ctrl-end-pressed() => {
                        root.ctrl_end_pressed();
                    }
                    
                    text-inserted(line, col, text) => {
                        root.text_inserted(line, col, text);
                    }
                    
                    text-deleted(start-line, start_col, end_line, end_col) => {
                        root.text_deleted(start_line, start_col, end_line, end_col);
                    }
                    
                    key-pressed(event) => {
                        root.key_pressed-event("key=" + event.text);
                        return accept;
                    }
                    
                    request-focus() => {
                        editor-focus.focus();
                    }
                }
            }
            
            // Floating Status Pill (Bottom Right)
            Rectangle {
                x: parent.width - status-layout.preferred-width - 30px;
                y: parent.height - 40px;
                height: 30px;
                width: status-layout.preferred-width + 20px;
                background: #2c3e50;
                border-radius: 15px;
                opacity: 0.9;
                border-width: 1px;
                border-color: #34495e;
                
                status-layout := HorizontalLayout {
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 15px;
                    
                    Text {
                        text: root.gcode-filename;
                        color: #ecf0f1;
                        font-size: 12px;
                        font-weight: 700;
                        vertical-alignment: center;
                    }
                    
                    Text {
                        text: "Line " + root.cursor-line + ":" + root.cursor-column;
                        color: #bdc3c7;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                    
                    Text {
                        text: "Total: " + root.total-lines;
                        color: #bdc3c7;
                        font-size: 12px;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}
