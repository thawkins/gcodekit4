/// G-Code Editor Panel Component
/// Displays the G-code text editor with file operations toolbar and undo/redo

import { Button, LineEdit, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { CustomTextEdit } from "../ui/ui_components/custom_text_edit.slint";

export struct TextLine {
    line_number: int,
    content: string,
    is_dirty: bool,
}

export component GcodeEditorPanel inherits VerticalBox {
   
    spacing: 0px;
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    
    in-out property <string> gcode-content: "";
    in-out property <string> gcode-filename: "untitled.gcode";
    in-out property <int> focus-trigger: 0;  // Incrementing this triggers focus on editor
    
    // Custom editor properties
    in-out property <bool> can-undo: false;
    in-out property <bool> can-redo: false;
    in-out property <int> cursor-line: 0;
    in-out property <int> cursor-column: 0;
    in-out property <[TextLine]> visible-lines: [];
    in-out property <int> total-lines: 0;
    in-out property <int> visible-start-line: 0;
    
    callback menu-file-new();
    callback menu-file-open();
    callback menu-file-save();
    callback menu-file-save-as();
    callback menu-send-to-device();
    callback menu-stop-transmission();
    callback menu-pause-transmission();
    callback menu-resume-transmission();
    
    // Custom editor callbacks
    callback undo_requested();
    callback redo_requested();
    callback text_changed(string);
    callback text_inserted(int, int, string);  // line, col, text
    callback text_deleted(int, int, int, int);  // start-line, start-col, end-line, end-col
    callback cursor_moved(int, int);
    callback scroll_changed(int);
    callback end_key_pressed();  // End key pressed - let Rust handle line-end positioning
    callback ctrl_home_pressed();  // Ctrl+Home - jump to beginning of file
    callback ctrl_end_pressed();  // Ctrl+End - jump to end of file
    callback request_focus();  // Called when panel becomes visible/active
    callback key_pressed_event(string);  // Forward key events
    callback editor_clicked();  // Debug: Track mouse clicks on editor
    
    // Toolbar with undo/redo and file operations
    Rectangle {
        height: 40px;
        background: #2d2d30;
        
        HorizontalBox {
            padding: 5px;
            spacing: 5px;
            
            // Undo button
            Rectangle {
                width: 80px;
                height: 30px;
                border-radius: 3px;
                border-width: 1px;
                border-color: #555555;
                
                undo-area := TouchArea {
                    enabled: root.can-undo;
                    clicked => {
                        root.undo-requested();
                    }
                }
                
                background: undo-area.has-hover ? #3e3e42 : #333337;
                
                HorizontalBox {
                    alignment: center;
                    Text {
                        text: "‚éå Undo";
                        color: root.can-undo ? #ffffff : #666666;
                        font-size: 12px;
                    }
                }
            }
            
            // Redo button
            Rectangle {
                width: 80px;
                height: 30px;
                border-radius: 3px;
                border-width: 1px;
                border-color: #555555;
                
                redo-area := TouchArea {
                    enabled: root.can-redo;
                    clicked => {
                        root.redo-requested();
                    }
                }
                
                background: redo-area.has-hover ? #3e3e42 : #333337;
                
                HorizontalBox {
                    alignment: center;
                    Text {
                        text: "‚éå Redo";
                        color: root.can-redo ? #ffffff : #666666;
                        font-size: 12px;
                    }
                }
            }
            
            Rectangle { width: 10px; }
            
            // File operation buttons
            Button {
                text: "New";
                clicked => {
                    root.menu-file-new();
                }
            }
            Button {
                text: "Open";
                clicked => {
                    root.menu-file-open();
                }
            }
            Button {
                text: "Save";
                enabled: root.gcode-content != "";
                clicked => {
                    root.menu-file-save();
                }
            }
            Button {
                text: "Save As";
                enabled: root.gcode-content != "";
                clicked => {
                    root.menu-file-save-as();
                }
            }
            
            Rectangle { width: 10px; }
            
            // Transmission buttons
            Button {
                text: "Send";
                enabled: root.gcode-content != "";
                clicked => {
                    root.menu-send-to-device();
                }
            }
            Button {
                text: "Stop";
                clicked => {
                    root.menu-stop-transmission();
                }
            }
            Button {
                text: "Pause";
                clicked => {
                    root.menu-pause-transmission();
                }
            }
            Button {
                text: "Resume";
                clicked => {
                    root.menu-resume-transmission();
                }
            }
            
            // Status on right
            Rectangle {
                horizontal-stretch: 1;
            }
            
            Text {
                text: root.gcode-filename;
                color: #cccccc;
                font-size: 12px;
                vertical-alignment: center;
            }
            
            Rectangle { width: 10px; }
            
            Text {
                text: "Line " + root.cursor-line + ":" + root.cursor-column;
                color: #cccccc;
                font-size: 12px;
                vertical-alignment: center;
            }
            Rectangle { width: 10px; }
            Text {
                text: "lines: " + (root.visible-start-line + 1) + "/" + root.total-lines;
                color: #cccccc;
                font-size: 12px;
                vertical-alignment: center;
            }
        }
    }
    
    // Wrapper FocusScope for editor focus management
    editor-focus := FocusScope {
        vertical-stretch: 1;
        horizontal-stretch: 1;
        
        touch-area := TouchArea {
            clicked => {
                debug("üñ±Ô∏è [MAIN-WINDOW] GcodeEditorPanel.TouchArea clicked!");
                root.editor_clicked();
            }
        }
        
        // Custom G-Code Editor with virtual scrolling
        CustomTextEdit {
            vertical-stretch: 1;
            horizontal-stretch: 1;
            text: root.gcode-content;
            can-undo: root.can-undo;
            can-redo: root.can-redo;
            cursor-line <=> root.cursor-line;
            cursor-column <=> root.cursor-column;
            visible-lines <=> root.visible-lines;
            visible-start-line <=> root.visible-start-line;
            total-lines <=> root.total-lines;
            show-line-numbers: true;
            focus-trigger <=> root.focus-trigger;
            
            text-changed(text) => {
            root.gcode-content = text;
            root.text-changed(text);
        }
        
        undo-requested => {
            root.undo-requested();
        }
        
        redo-requested => {
            root.redo-requested();
        }
        
        scroll-changed(line) => {
            // update panel visible start line for status indicator
            root.visible-start-line = line;
            root.scroll-changed(line);
        }
        
        cursor-moved(line, col) => {
            root.cursor-moved(line, col);
        }
        
        end-key-pressed() => {
            root.end_key_pressed();
        }
        
        ctrl-home-pressed() => {
            root.ctrl_home_pressed();
        }
        
        ctrl-end-pressed() => {
            root.ctrl_end_pressed();
        }
        
        text_inserted(line, col, text) => {
            root.text_inserted(line, col, text);
        }
        
        text_deleted(start_line, start_col, end_line, end_col) => {
            root.text_deleted(start_line, start_col, end_line, end_col);
        }
        
        key_pressed(event) => {
            root.key_pressed-event("key=" + event.text);
            return accept;
        }
        
        request-focus() => {
            editor-focus.focus();
        }
        }
    }
}
