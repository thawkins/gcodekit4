// Materials Manager UI Panel
// Provides CRUD interface for managing materials database

import { Button, VerticalBox, HorizontalBox, ListView, LineEdit, ComboBox, TextEdit, 
         ScrollView, GroupBox, TabWidget, CheckBox, SpinBox } from "std-widgets.slint";
import { Theme } from "../ui/theme.slint";
import { StandardButton, StandardInput, StandardCheckBox, StandardSpinBox, StandardSidebar } from "../ui/ui_components/shared.slint";

// Material data structure for UI
export struct MaterialData {
    id: string,
    name: string,
    category: string,
    subcategory: string,
    description: string,
    density: float,
    machinability_rating: int,
    tensile_strength: float,
    melting_point: float,
    chip_type: string,
    heat_sensitivity: string,
    abrasiveness: string,
    surface_finish: string,
    dust_hazard: string,
    fume_hazard: string,
    coolant_required: bool,
    custom: bool,
    notes: string,
}

// Cutting parameters structure
export struct CuttingParamsData {
    tool_type: string,
    rpm_min: int,
    rpm_max: int,
    feed_rate_min: float,
    feed_rate_max: float,
    plunge_rate_percent: float,
    max_doc: float,
    stepover_min: float,
    stepover_max: float,
    coolant_type: string,
    notes: string,
}

// PPE requirement structure
export struct PPERequirement {
    name: string,
    required: bool,
}

component MMTabButton inherits Rectangle {
    in property <string> text;
    in property <bool> selected;
    callback clicked;
    
    height: 35px;
    background: root.selected ? Theme.panel-background : transparent;
    
    Text {
        text: root.text;
        color: root.selected ? Theme.primary : Theme.text-secondary;
        font-size: 14px;
        font-weight: root.selected ? 700 : 400;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    Rectangle {
        height: 2px;
        width: 100%;
        y: parent.height - self.height;
        background: root.selected ? Theme.primary : transparent;
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

export component MaterialsManager inherits Rectangle {
    // Callbacks for CRUD operations
    callback load_materials();
    callback create_material(MaterialData);
    callback update_material(MaterialData);
    callback delete_material(string /* id */);
    callback select_material(string /* id */);
    callback search_materials(string /* query */);
    callback filter_by_category(string /* category */);
    
    // Material list data
    in-out property <[MaterialData]> materials: [];
    in-out property <MaterialData> selected_material;
    in-out property <string> search_query: "";
    in-out property <bool> is_editing: false;
    in-out property <bool> is_creating: false;
    
    // Editable properties (for two-way binding)
    in-out property <string> edit_id: "";
    in-out property <string> edit_name: "";
    in-out property <string> edit_category: "Wood";
    in-out property <string> edit_subcategory: "";
    in-out property <string> edit_description: "";
    in-out property <float> edit_density: 750.0;
    in-out property <int> edit_machinability: 7;
    in-out property <float> edit_tensile_strength: 0.0;
    in-out property <float> edit_melting_point: 0.0;
    in-out property <string> edit_chip_type: "Continuous";
    in-out property <string> edit_heat_sensitivity: "Low";
    in-out property <string> edit_abrasiveness: "Low";
    in-out property <string> edit_surface_finish: "Good";
    in-out property <string> edit_dust_hazard: "Minimal";
    in-out property <string> edit_fume_hazard: "None";
    in-out property <bool> edit_coolant_required: false;
    in-out property <string> edit_notes: "";
    
    // Internal state
    private property <int> active-tab: 0;
    
    // Categories for ComboBox
    property <[string]> categories: [
        "Wood",
        "Engineered Wood",
        "Plastic",
        "Non-Ferrous Metal",
        "Ferrous Metal",
        "Composite",
        "Stone & Ceramic"
    ];
    
    property <[string]> chip_types: ["Continuous", "Segmented", "Granular", "Small"];
    property <[string]> heat_sensitivities: ["Low", "Moderate", "High"];
    property <[string]> abrasiveness_levels: ["Low", "Moderate", "High"];
    property <[string]> surface_finishes: ["Excellent", "Good", "Fair", "Rough"];
    property <[string]> hazard_levels: ["None", "Minimal", "Moderate", "High"];
    property <[string]> coolant_types: ["None", "Air Only", "Mineral Oil", "Water Soluble", "Synthetic"];
    
    background: Theme.background;
    
    VerticalBox {
        padding: 10px;
        spacing: 10px;
        
        // Header with search and actions
        HorizontalBox {
            spacing: 10px;
            height: 40px;
            
            Text {
                text: "Materials Manager";
                font-size: 20px;
                font-weight: 700;
                color: Theme.text-primary;
                vertical-alignment: center;
            }
            
            Rectangle {
                horizontal-stretch: 1;
            }
            
            StandardInput {
                width: 250px;
                placeholder-text: "Search materials...";
                text <=> search_query;
                edited => {
                    root.search_materials(search_query);
                }
            }
            
            StandardButton {
                text: "âž• New Material";
                primary: true;
                width: 120px;
                tooltip: "Create New Material";
                clicked => {
                    is_creating = true;
                    is_editing = false;
                    edit_id = "";
                    edit_name = "";
                    edit_category = "Wood";
                    edit_subcategory = "";
                    edit_description = "";
                    edit_density = 750.0;
                    edit_machinability = 7;
                    edit_tensile_strength = 0.0;
                    edit_melting_point = 0.0;
                    edit_chip_type = "Continuous";
                    edit_heat_sensitivity = "Low";
                    edit_abrasiveness = "Low";
                    edit_surface_finish = "Good";
                    edit_dust_hazard = "Minimal";
                    edit_fume_hazard = "None";
                    edit_coolant_required = false;
                    edit_notes = "";
                }
            }
            
            StandardButton {
                text: "ðŸ”„ Refresh";
                width: 100px;
                tooltip: "Reload Materials List";
                clicked => {
                    root.load_materials();
                }
            }
        }
        
        // Filter by category
        HorizontalBox {
            spacing: 10px;
            height: 30px;
            
            Text {
                text: "Filter by Category:";
                vertical-alignment: center;
                color: Theme.text-secondary;
            }
            
            ComboBox {
                model: ["All", "Wood", "Engineered Wood", "Plastic", 
                        "Non-Ferrous Metal", "Ferrous Metal", "Composite", 
                        "Stone & Ceramic"];
                current-value: "All";
                width: 200px;
                selected => {
                    if (self.current-value != "All") {
                        root.filter_by_category(self.current-value);
                    } else {
                        root.load_materials();
                    }
                }
            }
        }
        
        // Main content area
        HorizontalBox {
            spacing: 10px;
            
            // Left panel - Materials list
            StandardSidebar {
                width: 350px; // Override width to match original design if needed, but StandardSidebar is 250px.
                // Let's stick to 250px for consistency.
                
                VerticalBox {
                    padding: 10px;
                    spacing: 10px;
                    
                    Text {
                        text: "Materials (" + materials.length + ")";
                        font-size: 14px;
                        font-weight: 600;
                        color: Theme.text-primary;
                    }
                    
                    ScrollView {
                        VerticalBox {
                            spacing: 5px;
                            
                            for material[index] in materials: Rectangle {
                                height: 70px;
                                background: material.id == selected_material.id ? Theme.sidebar-item-selected : (touch.has-hover ? Theme.sidebar-item-hover : Theme.panel-background);
                                border-radius: 5px;
                                border-width: 1px;
                                border-color: material.id == selected_material.id ? Theme.primary : Theme.border;
                                
                                touch := TouchArea {
                                    clicked => {
                                        selected_material = material;
                                        is_editing = true;
                                        is_creating = false;
                                        edit_id = material.id;
                                        edit_name = material.name;
                                        edit_category = material.category;
                                        edit_subcategory = material.subcategory;
                                        edit_description = material.description;
                                        edit_density = material.density;
                                        edit_machinability = material.machinability_rating;
                                        edit_tensile_strength = material.tensile_strength;
                                        edit_melting_point = material.melting_point;
                                        edit_chip_type = material.chip_type;
                                        edit_heat_sensitivity = material.heat_sensitivity;
                                        edit_abrasiveness = material.abrasiveness;
                                        edit_surface_finish = material.surface_finish;
                                        edit_dust_hazard = material.dust_hazard;
                                        edit_fume_hazard = material.fume_hazard;
                                        edit_coolant_required = material.coolant_required;
                                        edit_notes = material.notes;
                                        root.select_material(material.id);
                                    }
                                }
                                
                                HorizontalBox {
                                    padding: 10px;
                                    spacing: 10px;
                                    
                                    VerticalBox {
                                        spacing: 2px;
                                        
                                        Text {
                                            text: material.name;
                                            font-size: 13px;
                                            font-weight: 700;
                                            color: material.id == selected_material.id ? Theme.text-primary : Theme.text-secondary;
                                        }
                                        
                                        Text {
                                            text: material.category + " - " + material.subcategory;
                                            font-size: 11px;
                                            color: material.id == selected_material.id ? Theme.text-primary : Theme.text-muted;
                                        }
                                        
                                        Text {
                                            text: "Machinability: " + material.machinability_rating + "/10";
                                            font-size: 10px;
                                            color: material.machinability_rating >= 7 ? Theme.success : 
                                                   material.machinability_rating >= 5 ? Theme.warning : Theme.danger;
                                        }
                                    }
                                    
                                    Rectangle {
                                        horizontal-stretch: 1;
                                    }
                                    
                                    if material.custom: Rectangle {
                                        width: 50px;
                                        Text {
                                            text: "Custom";
                                            font-size: 9px;
                                            color: material.id == selected_material.id ? Theme.text-primary : Theme.primary;
                                            font-weight: 600;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Right panel - Details or Edit form
            Rectangle {
                background: Theme.panel-background;
                border-radius: 5px;
                
                if !is_editing && !is_creating: VerticalBox {
                    alignment: center;
                    Text {
                        text: "Select a material to view details\nor create a new material";
                        font-size: 16px;
                        color: Theme.text-muted;
                        horizontal-alignment: center;
                    }
                }
                
                if is_editing || is_creating: VerticalBox {
                    padding: 20px;
                    spacing: 15px;
                    
                    // Header
                    HorizontalBox {
                        spacing: 10px;
                        
                        Text {
                            text: is_creating ? "Create New Material" : "Edit Material";
                            font-size: 18px;
                            font-weight: 700;
                            color: Theme.text-primary;
                            horizontal-alignment: left;
                        }
                        
                        Rectangle {
                            horizontal-stretch: 1;
                        }
                        
                        StandardButton {
                            text: "ðŸ’¾ Save";
                            primary: true;
                            width: 80px;
                            tooltip: "Save Material Changes";
                            clicked => {
                                selected_material = {
                                    id: edit_id,
                                    name: edit_name,
                                    category: edit_category,
                                    subcategory: edit_subcategory,
                                    description: edit_description,
                                    density: edit_density,
                                    machinability_rating: edit_machinability,
                                    tensile_strength: edit_tensile_strength,
                                    melting_point: edit_melting_point,
                                    chip_type: edit_chip_type,
                                    heat_sensitivity: edit_heat_sensitivity,
                                    abrasiveness: edit_abrasiveness,
                                    surface_finish: edit_surface_finish,
                                    dust_hazard: edit_dust_hazard,
                                    fume_hazard: edit_fume_hazard,
                                    coolant_required: edit_coolant_required,
                                    custom: true,
                                    notes: edit_notes,
                                };
                                if (is_creating) {
                                    root.create_material(selected_material);
                                } else {
                                    root.update_material(selected_material);
                                }
                                is_editing = false;
                                is_creating = false;
                            }
                        }
                        
                        StandardButton {
                            text: "âŒ Cancel";
                            width: 80px;
                            tooltip: "Cancel Editing";
                            clicked => {
                                is_editing = false;
                                is_creating = false;
                            }
                        }
                        
                        if !is_creating && selected_material.custom: StandardButton {
                            text: "ðŸ—‘ï¸ Delete";
                            destructive: true;
                            width: 80px;
                            tooltip: "Delete Material";
                            clicked => {
                                root.delete_material(selected_material.id);
                                is_editing = false;
                            }
                        }
                    }
                    
                    // Custom Tab Bar
                    HorizontalBox {
                        spacing: 10px;
                        alignment: start;
                        height: 40px;
                        
                        MMTabButton { text: "Basic Info"; selected: root.active-tab == 0; width: 100px; clicked => { root.active-tab = 0; } }
                        MMTabButton { text: "Properties"; selected: root.active-tab == 1; width: 100px; clicked => { root.active-tab = 1; } }
                        MMTabButton { text: "Machining"; selected: root.active-tab == 2; width: 100px; clicked => { root.active-tab = 2; } }
                        MMTabButton { text: "Safety"; selected: root.active-tab == 3; width: 100px; clicked => { root.active-tab = 3; } }
                        MMTabButton { text: "Notes"; selected: root.active-tab == 4; width: 100px; clicked => { root.active-tab = 4; } }
                    }
                    
                    // Tab Content
                    Rectangle {
                        vertical-stretch: 1;
                        
                        // Basic Info Tab
                        if root.active-tab == 0 : ScrollView {
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding-top: 10px;
                                
                                // Material ID (only for new materials)
                                if is_creating: HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "ID:"; width: 120px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardInput {
                                        placeholder-text: "unique_id";
                                        text <=> edit_id;
                                    }
                                }
                                
                                // Name
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Name:"; width: 120px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardInput {
                                        placeholder-text: "Material name";
                                        text <=> edit_name;
                                    }
                                }
                                
                                // Category
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Category:"; width: 120px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: categories;
                                        current-value <=> edit_category;
                                    }
                                }
                                
                                // Subcategory
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Subcategory:"; width: 120px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardInput {
                                        placeholder-text: "e.g., Hardwood, Alloy";
                                        text <=> edit_subcategory;
                                    }
                                }
                                
                                // Description
                                VerticalBox {
                                    spacing: 4px;
                                    Text { text: "Description:"; color: Theme.text-secondary; }
                                    TextEdit {
                                        height: 60px;
                                        text <=> edit_description;
                                    }
                                }
                            }
                        }
                        
                        // Properties Tab
                        if root.active-tab == 1 : ScrollView {
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding-top: 10px;
                                
                                // Density
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Density (kg/mÂ³):"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_density;
                                        input-type: decimal;
                                        edited(val) => {
                                            edit_density = val.to-float();
                                        }
                                    }
                                }
                                
                                // Machinability rating
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Machinability (1-10):"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardSpinBox {
                                        minimum: 1;
                                        maximum: 10;
                                        value <=> edit_machinability;
                                    }
                                }
                                
                                // Tensile strength
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Tensile Strength (MPa):"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_tensile_strength;
                                        input-type: decimal;
                                        placeholder-text: "Optional";
                                        edited(val) => {
                                            edit_tensile_strength = val.to-float();
                                        }
                                    }
                                }
                                
                                // Melting point
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Melting Point (Â°C):"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    StandardInput {
                                        text: edit_melting_point;
                                        input-type: decimal;
                                        placeholder-text: "Optional";
                                        edited(val) => {
                                            edit_melting_point = val.to-float();
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Machining Tab
                        if root.active-tab == 2 : ScrollView {
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding-top: 10px;
                                
                                // Chip type
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Chip Type:"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: chip_types;
                                        current-value <=> edit_chip_type;
                                    }
                                }
                                
                                // Heat sensitivity
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Heat Sensitivity:"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: heat_sensitivities;
                                        current-value <=> edit_heat_sensitivity;
                                    }
                                }
                                
                                // Abrasiveness
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Abrasiveness:"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: abrasiveness_levels;
                                        current-value <=> edit_abrasiveness;
                                    }
                                }
                                
                                // Surface finish
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Surface Finish:"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: surface_finishes;
                                        current-value <=> edit_surface_finish;
                                    }
                                }
                            }
                        }
                        
                        // Safety Tab
                        if root.active-tab == 3 : ScrollView {
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding-top: 10px;
                                
                                // Dust hazard
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Dust Hazard:"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: hazard_levels;
                                        current-value <=> edit_dust_hazard;
                                    }
                                }
                                
                                // Fume hazard
                                HorizontalBox {
                                    spacing: 8px;
                                    Text { text: "Fume Hazard:"; width: 150px; vertical-alignment: center; color: Theme.text-secondary; }
                                    ComboBox {
                                        model: hazard_levels;
                                        current-value <=> edit_fume_hazard;
                                    }
                                }
                                
                                // Coolant required
                                HorizontalBox {
                                    spacing: 8px;
                                    StandardCheckBox {
                                        text: "Coolant Required";
                                        checked <=> edit_coolant_required;
                                    }
                                }
                                
                                // PPE Requirements
                                GroupBox {
                                    title: "Required PPE";
                                    
                                    VerticalBox {
                                        spacing: 5px;
                                        
                                        Text {
                                            text: "Eye Protection, Respiratory, Hearing Protection, Gloves, Apron";
                                            font-size: 11px;
                                            color: Theme.text-muted;
                                            wrap: word-wrap;
                                        }
                                        
                                        Text {
                                            text: "(PPE management to be implemented)";
                                            font-size: 10px;
                                            color: Theme.text-muted;
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Notes Tab
                        if root.active-tab == 4 : ScrollView {
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding-top: 10px;
                                
                                Text {
                                    text: "Additional Notes and Tips:";
                                    color: Theme.text-secondary;
                                }
                                
                                TextEdit {
                                    height: 200px;
                                    text <=> edit_notes;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
