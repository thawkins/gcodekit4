// Materials Manager UI Panel
// Provides CRUD interface for managing materials database

import { Button, VerticalBox, HorizontalBox, ListView, LineEdit, ComboBox, TextEdit, 
         ScrollView, GroupBox, TabWidget, CheckBox, SpinBox } from "std-widgets.slint";

// Material data structure for UI
export struct MaterialData {
    id: string,
    name: string,
    category: string,
    subcategory: string,
    description: string,
    density: float,
    machinability_rating: int,
    tensile_strength: float,
    melting_point: float,
    chip_type: string,
    heat_sensitivity: string,
    abrasiveness: string,
    surface_finish: string,
    dust_hazard: string,
    fume_hazard: string,
    coolant_required: bool,
    custom: bool,
    notes: string,
}

// Cutting parameters structure
export struct CuttingParamsData {
    tool_type: string,
    rpm_min: int,
    rpm_max: int,
    feed_rate_min: float,
    feed_rate_max: float,
    plunge_rate_percent: float,
    max_doc: float,
    stepover_min: float,
    stepover_max: float,
    coolant_type: string,
    notes: string,
}

// PPE requirement structure
export struct PPERequirement {
    name: string,
    required: bool,
}

export component MaterialsManager inherits Rectangle {
    // Callbacks for CRUD operations
    callback load_materials();
    callback create_material(MaterialData);
    callback update_material(MaterialData);
    callback delete_material(string /* id */);
    callback select_material(string /* id */);
    callback search_materials(string /* query */);
    callback filter_by_category(string /* category */);
    
    // Material list data
    in-out property <[MaterialData]> materials: [];
    in-out property <MaterialData> selected_material;
    in-out property <string> search_query: "";
    in-out property <bool> is_editing: false;
    in-out property <bool> is_creating: false;
    
    // Editable properties (for two-way binding)
    in-out property <string> edit_id: "";
    in-out property <string> edit_name: "";
    in-out property <string> edit_category: "Wood";
    in-out property <string> edit_subcategory: "";
    in-out property <string> edit_description: "";
    in-out property <float> edit_density: 750.0;
    in-out property <int> edit_machinability: 7;
    in-out property <float> edit_tensile_strength: 0.0;
    in-out property <float> edit_melting_point: 0.0;
    in-out property <string> edit_chip_type: "Continuous";
    in-out property <string> edit_heat_sensitivity: "Low";
    in-out property <string> edit_abrasiveness: "Low";
    in-out property <string> edit_surface_finish: "Good";
    in-out property <string> edit_dust_hazard: "Minimal";
    in-out property <string> edit_fume_hazard: "None";
    in-out property <bool> edit_coolant_required: false;
    in-out property <string> edit_notes: "";
    
    // Categories for ComboBox
    property <[string]> categories: [
        "Wood",
        "Engineered Wood",
        "Plastic",
        "Non-Ferrous Metal",
        "Ferrous Metal",
        "Composite",
        "Stone & Ceramic"
    ];
    
    property <[string]> chip_types: ["Continuous", "Segmented", "Granular", "Small"];
    property <[string]> heat_sensitivities: ["Low", "Moderate", "High"];
    property <[string]> abrasiveness_levels: ["Low", "Moderate", "High"];
    property <[string]> surface_finishes: ["Excellent", "Good", "Fair", "Rough"];
    property <[string]> hazard_levels: ["None", "Minimal", "Moderate", "High"];
    property <[string]> coolant_types: ["None", "Air Only", "Mineral Oil", "Water Soluble", "Synthetic"];
    
    background: #ecf0f1;
    
    HorizontalBox {
        padding: 10px;
        spacing: 10px;
        
        // Left panel - Materials list
        VerticalBox {
            width: 350px;
            spacing: 10px;
            
            // Search and filter controls
            GroupBox {
                title: "Search & Filter";
                vertical-stretch: 0;
                
                VerticalBox {
                    alignment: start;
                    spacing: 8px;
                    
                    HorizontalBox {
                        spacing: 5px;
                        
                        LineEdit {
                            height: 32px;
                            placeholder-text: "Search materials...";
                            text <=> search_query;
                            edited => {
                                root.search_materials(self.text);
                            }
                        }
                        
                        Button {
                            text: "ðŸ”";
                            width: 40px;
                            height: 32px;
                            clicked => {
                                root.search_materials(search_query);
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 5px;
                        Text {
                            text: "Category:";
                            vertical-alignment: center;
                            width: 70px;
                        }
                        
                        ComboBox {
                            height: 32px;
                            model: ["All", "Wood", "Engineered Wood", "Plastic", 
                                    "Non-Ferrous Metal", "Ferrous Metal", "Composite", 
                                    "Stone & Ceramic"];
                            selected => {
                                if (self.current-value != "All") {
                                    root.filter_by_category(self.current-value);
                                }
                            }
                        }
                    }
                }
            }
            
            // Action buttons
            HorizontalBox {
                spacing: 5px;
                vertical-stretch: 0;
                
                Button {
                    text: "âž• New Material";
                    height: 32px;
                    primary: true;
                    clicked => {
                        is_creating = true;
                        is_editing = false;
                        edit_id = "";
                        edit_name = "";
                        edit_category = "Wood";
                        edit_subcategory = "";
                        edit_description = "";
                        edit_density = 750.0;
                        edit_machinability = 7;
                        edit_tensile_strength = 0.0;
                        edit_melting_point = 0.0;
                        edit_chip_type = "Continuous";
                        edit_heat_sensitivity = "Low";
                        edit_abrasiveness = "Low";
                        edit_surface_finish = "Good";
                        edit_dust_hazard = "Minimal";
                        edit_fume_hazard = "None";
                        edit_coolant_required = false;
                        edit_notes = "";
                    }
                }
                
                Button {
                    text: "ðŸ”„ Refresh";
                    height: 32px;
                    clicked => {
                        root.load_materials();
                    }
                }
            }
            
            // Materials list
            GroupBox {
                title: "Materials (" + materials.length + ")";
                vertical-stretch: 1;
                
                ScrollView {
                    
                    VerticalLayout {
                        spacing: 2px;
                        
                        for material[index] in materials: Rectangle {
                            height: 60px;
                            background: material.id == selected_material.id ? #3498db : white;
                            border-radius: 4px;
                            border-width: 1px;
                            border-color: material.id == selected_material.id ? #2980b9 : #bdc3c7;
                            
                            TouchArea {
                                clicked => {
                                    selected_material = material;
                                    is_editing = true;
                                    is_creating = false;
                                    edit_id = material.id;
                                    edit_name = material.name;
                                    edit_category = material.category;
                                    edit_subcategory = material.subcategory;
                                    edit_description = material.description;
                                    edit_density = material.density;
                                    edit_machinability = material.machinability_rating;
                                    edit_tensile_strength = material.tensile_strength;
                                    edit_melting_point = material.melting_point;
                                    edit_chip_type = material.chip_type;
                                    edit_heat_sensitivity = material.heat_sensitivity;
                                    edit_abrasiveness = material.abrasiveness;
                                    edit_surface_finish = material.surface_finish;
                                    edit_dust_hazard = material.dust_hazard;
                                    edit_fume_hazard = material.fume_hazard;
                                    edit_coolant_required = material.coolant_required;
                                    edit_notes = material.notes;
                                    root.select_material(material.id);
                                }
                            }
                            
                            HorizontalBox {
                                padding: 8px;
                                spacing: 8px;
                                
                                VerticalLayout {
                                    Text {
                                        text: material.name;
                                        font-size: 14px;
                                        font-weight: 700;
                                        color: material.id == selected_material.id ? white : #2c3e50;
                                    }
                                    
                                    Text {
                                        text: material.category + " - " + material.subcategory;
                                        font-size: 11px;
                                        color: material.id == selected_material.id ? #ecf0f1 : #7f8c8d;
                                    }
                                    
                                    Text {
                                        text: "Machinability: " + material.machinability_rating + "/10";
                                        font-size: 10px;
                                        color: material.machinability_rating >= 7 ? #27ae60 : 
                                               material.machinability_rating >= 5 ? #f39c12 : #e74c3c;
                                    }
                                }
                                
                                if material.custom: Rectangle {
                                    width: 50px;
                                    Text {
                                        text: "Custom";
                                        font-size: 9px;
                                        color: material.id == selected_material.id ? white : #3498db;
                                        font-weight: 600;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // Right panel - Material details/editor
        VerticalBox {
            spacing: 10px;
            
            if !is_editing && !is_creating: VerticalBox {
                alignment: center;
                Text {
                    text: "Select a material to view details\nor create a new material";
                    font-size: 16px;
                    color: #7f8c8d;
                    horizontal-alignment: center;
                }
            }
            
            if is_editing || is_creating: ScrollView {
                VerticalBox {
                    alignment: start;
                    spacing: 10px;
                    padding: 10px;
                    
                    // Header
                    HorizontalBox {
                        spacing: 10px;
                        
                        Text {
                            text: is_creating ? "Create New Material" : "Edit Material";
                            font-size: 18px;
                            font-weight: 700;
                            color: #2c3e50;
                            horizontal-alignment: left;
                        }
                        
                        Rectangle {
                            horizontal-stretch: 1;
                        }
                        
                        Button {
                            text: "ðŸ’¾ Save";
                            height: 32px;
                            primary: true;
                            clicked => {
                                selected_material = {
                                    id: edit_id,
                                    name: edit_name,
                                    category: edit_category,
                                    subcategory: edit_subcategory,
                                    description: edit_description,
                                    density: edit_density,
                                    machinability_rating: edit_machinability,
                                    tensile_strength: edit_tensile_strength,
                                    melting_point: edit_melting_point,
                                    chip_type: edit_chip_type,
                                    heat_sensitivity: edit_heat_sensitivity,
                                    abrasiveness: edit_abrasiveness,
                                    surface_finish: edit_surface_finish,
                                    dust_hazard: edit_dust_hazard,
                                    fume_hazard: edit_fume_hazard,
                                    coolant_required: edit_coolant_required,
                                    custom: true,
                                    notes: edit_notes,
                                };
                                if (is_creating) {
                                    root.create_material(selected_material);
                                } else {
                                    root.update_material(selected_material);
                                }
                                is_editing = false;
                                is_creating = false;
                            }
                        }
                        
                        Button {
                            text: "âŒ Cancel";
                            height: 32px;
                            clicked => {
                                is_editing = false;
                                is_creating = false;
                            }
                        }
                        
                        if !is_creating && selected_material.custom: Button {
                            text: "ðŸ—‘ï¸ Delete";
                            height: 32px;
                            clicked => {
                                root.delete_material(selected_material.id);
                                is_editing = false;
                            }
                        }
                    }
                    
                    TabWidget {
                        Tab {
                            title: "Basic Info";
                            
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding: 10px;
                                
                                // Material ID (only for new materials)
                                if is_creating: HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "ID:";
                                        width: 120px;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        height: 32px;
                                        placeholder-text: "unique_id";
                                        text <=> edit_id;
                                    }
                                }
                                
                                // Name
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Name:";
                                        width: 120px;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        height: 32px;
                                        placeholder-text: "Material name";
                                        text <=> edit_name;
                                    }
                                }
                                
                                // Category
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Category:";
                                        width: 120px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: categories;
                                        current-value <=> edit_category;
                                    }
                                }
                                
                                // Subcategory
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Subcategory:";
                                        width: 120px;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        height: 32px;
                                        placeholder-text: "e.g., Hardwood, Alloy";
                                        text <=> edit_subcategory;
                                    }
                                }
                                
                                // Description
                                VerticalBox {
                                    spacing: 4px;
                                    Text {
                                        text: "Description:";
                                    }
                                    TextEdit {
                                        height: 60px;
                                        text <=> edit_description;
                                    }
                                }
                            }
                        }
                        
                        Tab {
                            title: "Properties";
                            
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding: 10px;
                                
                                // Density
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Density (kg/mÂ³):";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        height: 32px;
                                        text: edit_density;
                                        input-type: decimal;
                                        edited => {
                                            edit_density = self.text.to-float();
                                        }
                                    }
                                }
                                
                                // Machinability rating
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Machinability (1-10):";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    SpinBox {
                                        height: 32px;
                                        minimum: 1;
                                        maximum: 10;
                                        value <=> edit_machinability;
                                    }
                                }
                                
                                // Tensile strength
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Tensile Strength (MPa):";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        height: 32px;
                                        text: edit_tensile_strength;
                                        input-type: decimal;
                                        placeholder-text: "Optional";
                                        edited => {
                                            edit_tensile_strength = self.text.to-float();
                                        }
                                    }
                                }
                                
                                // Melting point
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Melting Point (Â°C):";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        height: 32px;
                                        text: edit_melting_point;
                                        input-type: decimal;
                                        placeholder-text: "Optional";
                                        edited => {
                                            edit_melting_point = self.text.to-float();
                                        }
                                    }
                                }
                            }
                        }
                        
                        Tab {
                            title: "Machining";
                            
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding: 10px;
                                
                                // Chip type
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Chip Type:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: chip_types;
                                        current-value <=> edit_chip_type;
                                    }
                                }
                                
                                // Heat sensitivity
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Heat Sensitivity:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: heat_sensitivities;
                                        current-value <=> edit_heat_sensitivity;
                                    }
                                }
                                
                                // Abrasiveness
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Abrasiveness:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: abrasiveness_levels;
                                        current-value <=> edit_abrasiveness;
                                    }
                                }
                                
                                // Surface finish
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Surface Finish:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: surface_finishes;
                                        current-value <=> edit_surface_finish;
                                    }
                                }
                            }
                        }
                        
                        Tab {
                            title: "Safety";
                            
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding: 10px;
                                
                                // Dust hazard
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Dust Hazard:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: hazard_levels;
                                        current-value <=> edit_dust_hazard;
                                    }
                                }
                                
                                // Fume hazard
                                HorizontalBox {
                                    spacing: 8px;
                                    Text {
                                        text: "Fume Hazard:";
                                        width: 150px;
                                        vertical-alignment: center;
                                    }
                                    ComboBox {
                                        height: 32px;
                                        model: hazard_levels;
                                        current-value <=> edit_fume_hazard;
                                    }
                                }
                                
                                // Coolant required
                                HorizontalBox {
                                    spacing: 8px;
                                    CheckBox {
                                        height: 32px;
                                        text: "Coolant Required";
                                        checked <=> edit_coolant_required;
                                    }
                                }
                                
                                // PPE Requirements
                                GroupBox {
                                    title: "Required PPE";
                                    
                                    VerticalBox {
                                        spacing: 5px;
                                        
                                        Text {
                                            text: "Eye Protection, Respiratory, Hearing Protection, Gloves, Apron";
                                            font-size: 11px;
                                            color: #7f8c8d;
                                            wrap: word-wrap;
                                        }
                                        
                                        Text {
                                            text: "(PPE management to be implemented)";
                                            font-size: 10px;
                                            color: #95a5a6;
                                        }
                                    }
                                }
                            }
                        }
                        
                        Tab {
                            title: "Notes";
                            
                            VerticalBox {
                                alignment: start;
                                spacing: 10px;
                                padding: 10px;
                                
                                Text {
                                    text: "Additional Notes and Tips:";
                                }
                                
                                TextEdit {
                                    height: 200px;
                                    text <=> edit_notes;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
