//! GCodeKit4 Main UI
//! Universal G-Code Sender for CNC Machines
//! Modular UI with separated panel components

import "../../../assets/fonts/fira-code/FiraCode-Regular.ttf";

import { Button, ComboBox, LineEdit, TextEdit, VerticalBox, HorizontalBox, ScrollView, SpinBox, CheckBox } from "std-widgets.slint";

// Import all panel components
import { GcodeEditorPanel, TextLine } from "ui_panels/gcode_editor.slint";
import { DeviceConsolePanel } from "ui_panels/device_console.slint";
import { MachineControlPanel } from "ui_panels/machine_control.slint";
import { ConfigSettingsPanel, ConfigSetting } from "ui_panels/config_settings.slint";
import { DeviceInfoPanel, CapabilityItem } from "ui_panels/device_info.slint";
import { GcodeVisualizerPanel } from "ui_panels/gcode_visualizer.slint";
import { DesignerPanel } from "ui_panels/designer.slint";
import { CAMToolsPanel } from "ui_panels/cam_tools.slint";
import { MaterialsManager, MaterialData } from "ui_panels/materials_manager.slint";
import { ToolsManager, ToolData } from "ui_panels/tools_manager.slint";
import { MainMenu } from "ui/ui_components/mainmenu.slint";
import { SettingsDialog, SettingItem } from "ui/ui_components/settings_dialog.slint";
import { TabbedBoxDialog } from "ui_panels/tabbed_box_dialog.slint";

export struct PortInfo {
    port: string,
    description: string,
}

export struct DesignerShape {
    id: int,
    x: float,
    y: float,
    width: float,
    height: float,
    radius: float,
    x2: float,
    y2: float,
    shape_type: int,
    selected: bool,
}

export struct DesignerState {
    mode: int,
    zoom: float,
    pan_x: float,
    pan_y: float,
    selected_id: int,
    update_counter: int,
}

export component MainWindow inherits Window {
    title: "GCodeKit4 - Universal G-Code Sender";
    
    // Busy cursor while processing
    in-out property <bool> is-busy: false;
    
    // Dynamic properties exposed to Rust
    in property <[string]> available-ports: [];
    in-out property <string> selected-port: "";
    in property <bool> connected: false;
    in property <string> connection-status: "Disconnected";
    in-out property <float> progress-value: 0.0;
    in property <string> device-version: "Unknown";
    in property <string> firmware-capabilities: "No firmware detected";
    in property <bool> cap-supports-arcs: false;
    in property <bool> cap-supports-probing: false;
    in property <bool> cap-supports-tool-change: false;
    in property <bool> cap-supports-variable-spindle: false;
    in property <bool> cap-supports-homing: false;
    in property <bool> cap-supports-overrides: false;
    in property <int> cap-max-axes: 3;
    in property <int> cap-coordinate-systems: 1;
    in property <[SettingItem]> all-settings: [];
    in property <float> position-x: 0.0;
    in property <float> position-y: 0.0;
    in property <float> position-z: 0.0;
    in property <float> position-a: 0.0;
    in property <float> position-b: 0.0;
    in property <float> position-c: 0.0;
    in property <float> feed-rate: 0.0;
    in property <float> spindle-speed: 0.0;
    in property <string> machine-state: "DISCONNECTED";
    in property <string> raw-status-response: "";
    in property <string> app-version: "0.9.1";
    in property <string> app-build-date: "2025-10-22";
    in property <string> console-output: "[INFO] GCodeKit4 initialized\n[INFO] Ready for operation\n";
    in-out property <string> gcode-content: "";
    in-out property <string> current-view: "gcode-editor";
    in-out property <string> gcode-filename: "untitled.gcode";
    in property <int> console-scroll-trigger: 0;
    
    // Custom G-code Editor properties
    in-out property <bool> can-undo: false;
    in-out property <bool> can-redo: false;
    in-out property <int> cursor-line: 0;
    in-out property <int> cursor-column: 0;
    in-out property <[TextLine]> visible-lines: [];
    in-out property <int> total-lines: 0;
    in-out property <int> visible-start-line: 0;
    
    // Configuration settings properties
    in property <[ConfigSetting]> config-settings: [];
    in property <[ConfigSetting]> config-filtered-settings: [];
    in-out property <string> config-filter-text: "";
    in-out property <string> config-selected-category: "All";
    in property <string> config-status-message: "";
    in property <bool> config-has-loaded-settings: false;
    
    // Config edit dialog properties
    in-out property <bool> show-edit-dialog: false;
    in-out property <int> edit-setting-number: 0;
    in-out property <string> edit-setting-name: "";
    in-out property <string> edit-setting-value: "";
    in-out property <string> edit-setting-unit: "";
    in-out property <string> edit-setting-description: "";
    
    // Device Info Panel Properties
    in property <string> device-firmware-type: "";
    in property <string> device-firmware-version: "";
    in property <string> device-name: "Unknown Device";
    in property <[CapabilityItem]> device-capabilities: [];
    
    // Visualizer panel properties
    in property <float> visualizer-progress: 0.0;
    in property <string> visualizer-status: "Ready";
    in property <float> visualizer-x-offset: 0.0;
    in property <float> visualizer-y-offset: 0.0;
    in property <float> visualizer-zoom-scale: 1.0;
    in-out property <bool> visualizer-show-grid: true;
    in-out property <bool> visualizer-show-rapid-moves: true;
    in-out property <int> gcode-focus-trigger: 0;  // Incrementing this triggers editor focus
    in-out property <float> visualizer-canvas-width: 800.0;
    in-out property <float> visualizer-canvas-height: 600.0;
    in-out property <string> visualization-path-data: "";
    in-out property <string> visualization-rapid-moves-data: "";
    in-out property <string> visualization-grid-data: "";
    in-out property <string> visualization-origin-data: "";
    
    // Designer panel properties (Phase 2)
    in property <[DesignerShape]> designer-shapes: [];
    in property <DesignerState> designer-state: {
        mode: 0,
        zoom: 1.0,
        pan_x: 0.0,
        pan_y: 0.0,
        selected_id: -1,
    };
    in-out property <float> designer-feed-rate: 120.0;
    in-out property <float> designer-spindle-speed: 3000.0;
    in-out property <float> designer-tool-diameter: 3.175;
    in-out property <float> designer-cut-depth: -5.0;
    in property <float> designer-safe-z: 10.0;
    in property <string> designer-generated-gcode: "";
    in property <bool> designer-gcode-generated: false;
    in property <string> designer-canvas-crosshair-data: "";
    in property <string> designer-canvas-shapes-data: "";
    in property <string> designer-canvas-selected-shapes-data: "";
    in property <string> designer-canvas-handles-data: "";
    in property <float> designer-selected-shape-x: 0.0;
    in property <float> designer-selected-shape-y: 0.0;
    in property <float> designer-selected-shape-w: 0.0;
    in property <float> designer-selected-shape-h: 0.0;
    in property <int> designer-selected-shape-type: 0;
    in property <float> designer-selected-shape-radius: 5.0;
    
    // Materials Manager properties
    in-out property <[MaterialData]> materials: [];
    
    // CNC Tools Manager properties
    in-out property <[ToolData]> cnc_tools: [];
    
    // Tabbed Box Maker properties (boxes.py algorithm)
    in-out property <string> tbox-x: "100.0";
    in-out property <string> tbox-y: "100.0";
    in-out property <string> tbox-h: "100.0";
    in-out property <string> tbox-thickness: "3.0";
    in-out property <string> tbox-burn: "0.1";
    in-out property <string> tbox-finger-width: "2.0";
    in-out property <string> tbox-space-width: "2.0";
    in-out property <string> tbox-surrounding-spaces: "2.0";
    in-out property <string> tbox-play: "0.0";
    in-out property <int> tbox-finger-style: 0;
    in-out property <int> tbox-box-type: 0;
    in-out property <bool> tbox-outside-dims: false;
    in-out property <string> tbox-laser-passes: "3";
    in-out property <string> tbox-laser-power: "1000";
    in-out property <string> tbox-feed-rate: "500";
    in-out property <string> tbox-offset-x: "10.0";
    in-out property <string> tbox-offset-y: "10.0";
    
    // Jigsaw Puzzle properties
    in-out property <string> puzzle-width: "200.0";
    in-out property <string> puzzle-height: "150.0";
    in-out property <string> puzzle-pieces-across: "4";
    in-out property <string> puzzle-pieces-down: "3";
    in-out property <string> puzzle-kerf: "0.5";
    in-out property <string> puzzle-laser-passes: "3";
    in-out property <string> puzzle-laser-power: "1000";
    in-out property <string> puzzle-feed-rate: "500";
    in-out property <string> puzzle-seed: "42";
    in-out property <string> puzzle-tab-size: "20.0";
    in-out property <string> puzzle-jitter: "4.0";
    in-out property <string> puzzle-corner-radius: "2.0";
    in-out property <string> puzzle-offset-x: "10.0";
    in-out property <string> puzzle-offset-y: "10.0";
    
    callback refresh-ports();
    callback connect(string, int);
    callback disconnect();
    callback menu-file-new();
    callback menu-file-open();
    callback menu-file-save();
    callback menu-file-save-as();
    callback menu-send-to-device();
    callback menu-stop-transmission();
    callback menu-pause-transmission();
    callback menu-resume-transmission();
    callback menu-file-exit();
    callback undo-requested();
    callback redo-requested();
    callback text-changed(string);
    callback scroll-changed(int);
    callback machine-jog-home();
    callback machine-jog-x-positive(float);
    callback machine-jog-x-negative(float);
    callback machine-jog-y-positive(float);
    callback machine-jog-y-negative(float);
    callback machine-jog-z-positive(float);
    callback machine-jog-z-negative(float);
    callback machine-jog-a-positive(float);
    callback machine-jog-a-negative(float);
    callback machine-jog-b-positive(float);
    callback machine-jog-b-negative(float);
    callback machine-unlock();
    callback menu-edit-preferences();
    callback menu-settings-save();
    callback menu-settings-cancel();
    callback menu-settings-restore-defaults();
    callback menu-view-fullscreen();
    callback menu-view-gcode-editor();
    callback menu-view-machine();
    callback menu-view-device-console();
    callback menu-view-gcode-visualizer();
    callback menu-view-designer();
    callback menu-view-materials();
    callback menu-view-cnc-tools();
    callback menu-help-about();
    callback key-pressed-event(string);  // Debug callback for keyboard events
    callback editor-clicked();  // Debug callback for editor clicks
    
    // Materials Manager callbacks
    callback load_materials();
    callback create_material(MaterialData);
    callback update_material(MaterialData);
    callback delete_material(string);
    callback select_material(string);
    callback search_materials(string);
    callback filter_by_category(string);
    
    // CNC Tools Manager callbacks
    callback load_tools();
    callback create_tool(ToolData);
    callback update_tool(ToolData);
    callback delete_tool(string);
    callback select_tool(string);
    callback search_tools(string);
    callback filter_by_tool_type(string);
    callback import_gtc_package(string);
    
    // Configuration settings callbacks
    callback config-retrieve-settings();
    callback config-save-to-file();
    callback config-load-from-file();
    callback config-restore-to-device();
    callback config-edit-setting(int);
    callback config-save-edited-setting(int, string);
    callback config-filter-changed();
    callback update-setting(string, string);
    callback console-clear-clicked();
    callback console-copy-clicked();
    callback send-command(string);
    callback refresh-visualization(/* canvas_width */ float, /* canvas_height */ float);
    callback zoom-in(/* canvas_width */ float, /* canvas_height */ float);
    callback zoom-out(/* canvas_width */ float, /* canvas_height */ float);
    callback reset-view(/* canvas_width */ float, /* canvas_height */ float);
    callback fit-to-view(/* canvas_width */ float, /* canvas_height */ float);
    callback toggle-grid();
    callback pan-by-mouse(/* dx */ float, /* dy */ float);
    
    // Designer callbacks (Phase 2)
    callback designer-set-mode(int);
    callback designer-zoom-in();
    callback designer-zoom-out();
    callback designer-zoom-fit();
    callback designer-reset-view();
    callback designer-delete-selected();
    callback designer-clear-canvas();
    callback designer-generate-toolpath();
    callback designer-export-gcode();
    callback designer-import-dxf();
    callback designer-import-svg();
    callback designer-export-design();
    callback designer-canvas-click(float, float);
    callback designer-detect-handle(float, float) -> int;  // x, y - returns handle index
    callback designer-shape-drag(int, float, float);        // shape_id, dx, dy
    callback designer-handle-drag(int, int, float, float);  // shape_id, handle_index, dx, dy
    callback designer-canvas-pan(float, float);             // dx, dy - pan the viewport
    callback designer-deselect-all();
    callback designer-set-shift-pressed(bool);              // Shift key state
    callback designer-save-shape-properties();              // Save all properties
    callback designer-update-shape-property(int, float);    // property_id, value
    callback designer-update-feed-rate(float);
    callback designer-update-spindle-speed(float);
    callback designer-update-tool-diameter(float);
    callback designer-update-cut-depth(float);
    callback designer-file-new();
    callback designer-file-open();
    callback designer-file-save();
    callback designer-file-save-as();
    
     // CAM Tool callbacks
    callback generate-tabbed-box();
    callback generate-jigsaw-puzzle();
    callback generate-laser-engraving();
    callback generate-vector-engraving();
    
    // Custom editor callbacks
    callback clear_editor();
    callback append_gcode_line(string);
    callback load_editor_text(string);
    callback text_inserted(int, int, string);  // line, column, text
    callback text_deleted(int, int, int, int);  // start_line, start_col, end_line, end_col
    callback cursor_moved(int, int);  // line, column
    callback end_key_pressed();  // End key pressed
    callback ctrl_home_pressed();  // Ctrl+Home pressed
    callback ctrl_end_pressed();  // Ctrl+End pressed
    callback mouse_clicked(int, int);  // x, y in pixels
    callback find_requested(string);  // search text
    callback replace_requested(string, string);  // search, replace
    
    // Internal state for UI selections
    private property <int> port-index: 0;
    private property <int> console-scroll-ref: 0;
    private property <float> step-size: 1.0;
    private property <int> step-index: 1;
    
    // Private properties for dialogs
    private property <bool> about-dialog-visible: false;
    private property <bool> settings-dialog-visible: false;
    private property <string> settings-category: "controller";
    // Native menu bar with dark theme support
    MenuBar {
        Menu {
            title: @tr("File");
            MenuItem {
                title: @tr("Open File");
                activated => { root.menu-file-open(); }
            }
            MenuItem {
                title: @tr("Save File");
                activated => { root.menu-file-save(); }
            }
            MenuItem {
                title: @tr("Save As");
                activated => { root.menu-file-save-as(); }
            }
            MenuItem {
                title: @tr("Exit");
                activated => { root.menu-file-exit(); }
            }
        }
        
        Menu {
            title: @tr("Edit");
            MenuItem {
                title: @tr("Preferences");
                activated => { 
                    root.menu-edit-preferences();
                    settings-dialog-visible = true;
                }
            }
        }
        
        Menu {
            title: @tr("View");
            MenuItem {
                title: current-view == "gcode-editor" ? @tr("‚úì G-Code Editor") : @tr("G-Code Editor");
                activated => {
                    if (current-view != "gcode-editor") {
                        current-view = "gcode-editor";
                        root.menu-view-gcode-editor();
                    } else {
                        root.menu-view-gcode-editor();
                    }
                }
            }
            MenuItem {
                title: current-view == "machine" ? @tr("‚úì Machine") : @tr("Machine");
                activated => {
                    if (current-view != "machine") {
                        current-view = "machine";
                        root.menu-view-machine();
                    }
                }
            }
            MenuItem {
                title: current-view == "device-console" ? @tr("‚úì Device Console") : @tr("Device Console");
                activated => {
                    if (current-view != "device-console") {
                        current-view = "device-console";
                        root.menu-view-device-console();
                    }
                }
            }

            MenuItem {
                title: current-view == "gcode-visualizer" ? @tr("‚úì Visualizer") : @tr("Visualizer");
                activated => {
                    if (current-view != "gcode-visualizer") {
                        current-view = "gcode-visualizer";
                        root.menu-view-gcode-visualizer();
                    }
                }
            }
            MenuItem {
                title: current-view == "designer" ? @tr("‚úì Designer") : @tr("Designer");
                activated => {
                    if (current-view != "designer") {
                        current-view = "designer";
                        root.menu-view-designer();
                    }
                }
            }
            MenuItem {
                title: current-view == "materials" ? @tr("‚úì Materials") : @tr("Materials");
                activated => {
                    if (current-view != "materials") {
                        current-view = "materials";
                        root.menu-view-materials();
                    }
                }
            }
        }
        
        Menu {
            title: @tr("Help");
            MenuItem {
                title: @tr("About");
                activated => { 
                    root.menu-help-about();
                    about-dialog-visible = true;
                }
            }
        }
    }
    
    // Busy cursor overlay
    if root.is-busy : TouchArea {
        width: 100%;
        height: 100%;
        mouse-cursor: MouseCursor.wait;
    }
    
    // Wrap main content in FocusScope to capture keyboard events
    // Wrap main content in FocusScope to capture keyboard events
    FocusScope {
        key-pressed(event) => {
            debug("üî¥ MainWindow.FocusScope.key-pressed: text=[" + event.text + "]");
            
            // Let arrow keys, Enter, Backspace, Delete, Tab, etc. pass through to child FocusScopes
            if (event.text == Key.LeftArrow || event.text == Key.RightArrow ||
                event.text == Key.UpArrow || event.text == Key.DownArrow ||
                event.text == Key.Home || event.text == Key.End ||
                event.text == Key.PageUp || event.text == Key.PageDown ||
                event.text == Key.Return || event.text == "\u{8}" ||  // Backspace
                event.text == Key.Delete || event.text == Key.Tab) {
                debug("üî¥ MainWindow.FocusScope: Navigation key - rejecting to let editor handle it");
                return reject;
            }
            
            // Forward to editor for handling
            root.key_pressed_event("FOCUSSCOPE: " + event.text);
            
            // Handle printable characters only if editor doesn't have focus
            if (event.text != "" && event.text != Key.Escape &&
                !(event.modifiers.control || event.modifiers.meta)) {
                debug("üî¥ MainWindow.FocusScope: Calling text_inserted");
                root.text_inserted(1, 1, event.text);
                return accept;
            }
            
            return reject;
        }
    
    VerticalBox {
        spacing: 0px;
        
        // Main content area
        HorizontalBox {
            spacing: 10px;
            padding: 10px;
            
            // Main content area - File and Viewer
            VerticalBox {
                spacing: 0px;
                horizontal-stretch: 1.0;
                vertical-stretch: 1.0;
                
                // Tab bar
                Rectangle {
                    background: #2c3e50;
                    height: 40px;
                    
                    HorizontalBox {
                        padding: 4px;
                        spacing: 2px;
                        alignment: start;
                        
                        // G-Code Editor Tab
                        Rectangle {
                            width: 140px;
                            height: 32px;
                            background: current-view == "gcode-editor" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "G-Code Editor";
                                color: current-view == "gcode-editor" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "gcode-editor" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "gcode-editor";
                                    root.menu-view-gcode-editor();
                                }
                            }
                        }
                        
                        // Machine Control Tab
                        Rectangle {
                            width: 140px;
                            height: 32px;
                            background: current-view == "machine" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "Machine Control";
                                color: current-view == "machine" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "machine" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "machine";
                                    root.menu-view-machine();
                                }
                            }
                        }
                        
                        // Device Console Tab
                        Rectangle {
                            width: 140px;
                            height: 32px;
                            background: current-view == "device-console" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "Device Console";
                                color: current-view == "device-console" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "device-console" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "device-console";
                                    root.menu-view-device-console();
                                }
                            }
                        }
                        
                        // Device Info Tab
                        Rectangle {
                            width: 110px;
                            height: 32px;
                            background: current-view == "device-info" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "üì± Device Info";
                                color: current-view == "device-info" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "device-info" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "device-info";
                                }
                            }
                        }
                        
                        // Config Tab
                        Rectangle {
                            width: 100px;
                            height: 32px;
                            background: current-view == "config-settings" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "‚öôÔ∏è Config";
                                color: current-view == "config-settings" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "config-settings" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "config-settings";
                                }
                            }
                        }
                        
                        // GCode Visualizer Tab
                        Rectangle {
                            width: 120px;
                            height: 32px;
                            background: current-view == "gcode-visualizer" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "Visualizer";
                                color: current-view == "gcode-visualizer" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "gcode-visualizer" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "gcode-visualizer";
                                    root.menu-view-gcode-visualizer();
                                }
                            }
                        }

                        // Designer Tab
                        Rectangle {
                            width: 120px;
                            height: 32px;
                            background: current-view == "designer" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "Designer";
                                color: current-view == "designer" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "designer" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "designer";
                                    root.menu-view-designer();
                                }
                            }
                        }
                        
                        // CAM Tools Tab
                        Rectangle {
                            width: 120px;
                            height: 32px;
                            background: current-view == "cam-tools" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "üîß CAM Tools";
                                color: current-view == "cam-tools" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "cam-tools" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "cam-tools";
                                }
                            }
                        }
                        
                        // Materials Tab
                        Rectangle {
                            width: 120px;
                            height: 32px;
                            background: current-view == "materials" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "üì¶ Materials";
                                color: current-view == "materials" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "materials" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "materials";
                                }
                            }
                        }
                        
                        // CNC Tools Tab
                        Rectangle {
                            width: 120px;
                            height: 32px;
                            background: current-view == "cnc-tools" ? #34495e : #3d5470;
                            border-radius: 3px;
                            
                            Text {
                                text: "üî© CNC Tools";
                                color: current-view == "cnc-tools" ? white : #bdc3c7;
                                font-size: 12px;
                                font-weight: current-view == "cnc-tools" ? 700 : 400;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                            
                            TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    current-view = "cnc-tools";
                                    root.load_tools();
                                }
                            }
                        }
                    }
                }
                
                // GCode Editor View - using imported component
                if current-view == "gcode-editor" : Rectangle {
                    background: transparent;
                    vertical-stretch: 1;
                    horizontal-stretch: 1;
                    
                    editor-focus-wrapper := FocusScope {
                        vertical-stretch: 1;
                        horizontal-stretch: 1;
                        
                        // Use a timer to ensure focus is set after layout completes
                        focus-timer := Timer {
                            interval: 50ms;
                            triggered => {
                                debug("üéØ [TIMER] Focus timer triggered - calling focus");
                                editor-focus-wrapper.focus();
                                focus-timer.stop();
                            }
                        }
                        
                        init => {
                            debug("üéØ [MAIN-WINDOW] editor-focus-wrapper init - starting focus timer");
                            focus-timer.restart();
                        }
                        
                        // Debug TouchArea for main view
                        main-editor-touch := TouchArea {
                            clicked => {
                                debug("üñ±Ô∏è [MAIN-WINDOW] Main editor view clicked!");
                            }
                        }
                        
                        gcode-editor-panel := GcodeEditorPanel {
                    gcode-content <=> root.gcode-content;
                    gcode-filename <=> root.gcode-filename;
                    focus-trigger <=> root.gcode-focus-trigger;
                    can-undo <=> root.can-undo;
                    can-redo <=> root.can-redo;
                    cursor-line <=> root.cursor-line;
                    cursor-column <=> root.cursor-column;
                    visible-lines <=> root.visible-lines;
                    total-lines <=> root.total-lines;
                    visible-start-line <=> root.visible-start-line;
                    menu-file-new => {
                        root.menu-file-new();
                    }
                    menu-file-open => {
                        root.menu-file-open();
                    }
                    menu-file-save => {
                        root.menu-file-save();
                    }
                    menu-file-save-as => {
                        root.menu-file-save-as();
                    }
                    menu-send-to-device => {
                        root.menu-send-to-device();
                    }
                    menu-stop-transmission => {
                        root.menu-stop-transmission();
                    }
                    menu-pause-transmission => {
                        root.menu-pause-transmission();
                    }
                    menu-resume-transmission => {
                        root.menu-resume-transmission();
                    }
                    undo-requested => {
                        root.undo_requested();
                    }
                    redo-requested => {
                        root.redo_requested();
                    }
                    text-changed(text) => {
                        root.text-changed(text);
                    }
                    scroll-changed(line) => {
                        root.scroll_changed(line);
                    }
                    
                    end_key_pressed() => {
                        root.end_key_pressed();
                    }
                    
                    ctrl_home_pressed() => {
                        root.ctrl_home_pressed();
                    }
                    
                    ctrl_end_pressed() => {
                        root.ctrl_end_pressed();
                    }
                    
                    cursor_moved(line, col) => {
                        root.cursor_moved(line, col);
                    }
                    
                    request-focus => {
                        // Called when editor tab becomes active - handled from Rust
                    }
                    
                    text-inserted(line, col, text) => {
                        root.text_inserted(line, col, text);
                    }
                    
                    text-deleted(start-line, start-col, end-line, end-col) => {
                        root.text_deleted(start-line, start-col, end-line, end-col);
                    }
                    
                    key-pressed-event(msg) => {
                        root.key_pressed_event(msg);
                    }
                    
                    editor_clicked => {
                        debug("üñ±Ô∏è [UI] GcodeEditorPanel.editor_clicked received!");
                    }
                        }
                    }
                }
                
                // Device Console View
                // Device Console View - using imported component
                if current-view == "device-console" : DeviceConsolePanel {
                    console-output: root.console-output;
                    connected: root.connected;
                    console-clear-clicked => {
                        root.console-clear-clicked();
                    }
                    console-copy-clicked => {
                        root.console-copy-clicked();
                    }
                    send-command(cmd) => {
                        root.send-command(cmd);
                    }
                }
                
                // Machine Control View
                if current-view == "machine" : MachineControlPanel {
                    connected: root.connected;
                    available-ports: root.available-ports;
                    selected-port: root.selected-port;
                    position-x: root.position-x;
                    position-y: root.position-y;
                    position-z: root.position-z;
                    position-a: root.position-a;
                    position-b: root.position-b;
                    position-c: root.position-c;
                    feed-rate: root.feed-rate;
                    spindle-speed: root.spindle-speed;
                    machine-state: root.machine-state;
                    port-selected(port) => {
                        root.selected-port = port;
                    }
                    connect-clicked => {
                        root.connect(root.selected-port, 115200);
                    }
                    disconnect-clicked => {
                        root.disconnect();
                    }
                    refresh-ports-clicked => {
                        root.refresh-ports();
                    }
                    jog-home-clicked => {
                        root.machine-jog-home();
                    }
                    jog-x-positive(step) => {
                        root.machine-jog-x-positive(step);
                    }
                    jog-x-negative(step) => {
                        root.machine-jog-x-negative(step);
                    }
                    jog-y-positive(step) => {
                        root.machine-jog-y-positive(step);
                    }
                    jog-y-negative(step) => {
                        root.machine-jog-y-negative(step);
                    }
                    jog-z-positive(step) => {
                        root.machine-jog-z-positive(step);
                    }
                    jog-z-negative(step) => {
                        root.machine-jog-z-negative(step);
                    }
                    jog-a-positive(step) => {
                        root.machine-jog-a-positive(step);
                    }
                    jog-a-negative(step) => {
                        root.machine-jog-a-negative(step);
                    }
                    jog-b-positive(step) => {
                        root.machine-jog-b-positive(step);
                    }
                    jog-b-negative(step) => {
                        root.machine-jog-b-negative(step);
                    }
                    unlock-clicked => {
                        root.machine-unlock();
                    }
                    send-command(cmd) => {
                        root.send-command(cmd);
                    }
                }
                
                // Device Info View
                if current-view == "device-info" : device-info := DeviceInfoPanel {
                    connected: root.connected;
                    firmware-type: root.device-firmware-type;
                    firmware-version: root.device-firmware-version;
                    device-name: root.device-name;
                    capabilities: root.device-capabilities;
                }
                
                // Configuration Settings View
                if current-view == "config-settings" : config-panel := ConfigSettingsPanel {
                    connected: root.connected;
                    settings: root.config-settings;
                    filtered-settings: root.config-filtered-settings;
                    filter-text <=> root.config-filter-text;
                    selected-category <=> root.config-selected-category;
                    status-message: root.config-status-message;
                    has-loaded-settings: root.config-has-loaded-settings;
                    show-edit-dialog <=> root.show-edit-dialog;
                    edit-setting-number <=> root.edit-setting-number;
                    edit-setting-name <=> root.edit-setting-name;
                    edit-setting-value <=> root.edit-setting-value;
                    edit-setting-unit <=> root.edit-setting-unit;
                    edit-setting-description <=> root.edit-setting-description;
                    
                    retrieve-settings => {
                        root.config-retrieve-settings();
                    }
                    
                    save-to-file => {
                        root.config-save-to-file();
                    }
                    
                    load-from-file => {
                        root.config-load-from-file();
                    }
                    
                    restore-to-device => {
                        root.config-restore-to-device();
                    }
                    
                    edit-setting(number) => {
                        root.config-edit-setting(number);
                    }
                    
                    save-edited-setting(number, value) => {
                        root.config-save-edited-setting(number, value);
                    }
                    
                    filter-changed => {
                        root.config-filter-changed();
                    }
                }

                // GCode Visualizer View
                if current-view == "gcode-visualizer" : visualizer-panel := GcodeVisualizerPanel {
                    gcode-filename <=> root.gcode-filename;
                    gcode-content <=> root.gcode-content;
                    visualization-path-data: root.visualization-path-data;
                    visualization-rapid-moves-data: root.visualization-rapid-moves-data;
                    visualization-grid-data: root.visualization-grid-data;
                    visualization-origin-data: root.visualization-origin-data;
                    machine-x: Math.round(root.position-x * 1000) / 1000 + "";
                    machine-y: Math.round(root.position-y * 1000) / 1000 + "";
                    machine-z: Math.round(root.position-z * 1000) / 1000 + "";
                    work-x: Math.round(root.position-a * 1000) / 1000 + "";
                    work-y: Math.round(root.position-b * 1000) / 1000 + "";
                    work-z: Math.round(root.position-c * 1000) / 1000 + "";
                    progress: root.visualizer-progress;
                    visualizer-status: root.visualizer-status;
                    x-offset: root.visualizer-x-offset;
                    y-offset: root.visualizer-y-offset;
                    zoom-scale: root.visualizer-zoom-scale;
                    show-grid <=> root.visualizer-show-grid;
                    show-rapid-moves <=> root.visualizer-show-rapid-moves;
                    
                    refresh-visualization(canvas-width, canvas-height) => {
                        root.visualizer-canvas-width = canvas-width;
                        root.visualizer-canvas-height = canvas-height;
                        root.refresh-visualization(canvas-width, canvas-height);
                    }
                    
                    zoom-in(canvas-width, canvas-height) => {
                        root.visualizer-canvas-width = canvas-width;
                        root.visualizer-canvas-height = canvas-height;
                        root.zoom-in(canvas-width, canvas-height);
                    }
                    
                    zoom-out(canvas-width, canvas-height) => {
                        root.visualizer-canvas-width = canvas-width;
                        root.visualizer-canvas-height = canvas-height;
                        root.zoom-out(canvas-width, canvas-height);
                    }
                    
                    reset-view(canvas-width, canvas-height) => {
                        root.visualizer-canvas-width = canvas-width;
                        root.visualizer-canvas-height = canvas-height;
                        root.reset-view(canvas-width, canvas-height);
                    }
                    
                    fit-to-view(canvas-width, canvas-height) => {
                        root.visualizer-canvas-width = canvas-width;
                        root.visualizer-canvas-height = canvas-height;
                        root.fit-to-view(canvas-width, canvas-height);
                    }
                    
                    toggle-grid => {
                        root.toggle-grid();
                    }
                    
                    pan-by-mouse(dx, dy) => {
                        root.pan-by-mouse(dx, dy);
                    }
                }

                // Designer View
                if current-view == "designer" : DesignerPanel {
                    shapes: root.designer-shapes;
                    designer_state: root.designer-state;
                    feed_rate <=> root.designer-feed-rate;
                    spindle_speed <=> root.designer-spindle-speed;
                    tool_diameter <=> root.designer-tool-diameter;
                    cut_depth <=> root.designer-cut-depth;
                    generated_gcode: root.designer-generated-gcode;
                    gcode_generated: root.designer-gcode-generated;
                    zoom_scale: root.designer-state.zoom;
                    x_offset: root.designer-state.pan_x;
                    y_offset: root.designer-state.pan_y;
                    canvas_crosshair_data: root.designer-canvas-crosshair-data;
                    canvas_shapes_data: root.designer-canvas-shapes-data;
                    canvas_selected_shapes_data: root.designer-canvas-selected-shapes-data;
                    canvas_handles_data: root.designer-canvas-handles-data;
                    selected_shape_x: root.designer-selected-shape-x;
                    selected_shape_y: root.designer-selected-shape-y;
                    selected_shape_w: root.designer-selected-shape-w;
                    selected_shape_h: root.designer-selected-shape-h;
                    selected_shape_type: root.designer-selected-shape-type;
                    selected_shape_radius: root.designer-selected-shape-radius;
                    
                    set_mode(m) => {
                        root.designer-set-mode(m);
                    }
                    
                    zoom_in => {
                        root.designer-zoom-in();
                    }
                    
                    zoom_out => {
                        root.designer-zoom-out();
                    }
                    
                    zoom_fit => {
                        root.designer-zoom-fit();
                    }
                    
                    reset_view => {
                        root.designer-reset-view();
                    }
                    
                    delete_selected => {
                        root.designer-delete-selected();
                    }
                    
                    clear_canvas => {
                        root.designer-clear-canvas();
                    }
                    
                    generate_toolpath => {
                        root.designer-generate-toolpath();
                    }
                    
                    export_gcode => {
                        root.designer-export-gcode();
                    }
                    
                    import_dxf => {
                        root.designer-import-dxf();
                    }
                    
                    import_svg => {
                        root.designer-import-svg();
                    }
                    
                    export_design => {
                        root.designer-export-design();
                    }
                    
                    canvas_click(x, y) => {
                        root.designer-canvas-click(x, y);
                    }
                    
                    detect_handle(x, y) => {
                        return root.designer-detect-handle(x, y);
                    }
                    
                    shape_drag(id, dx, dy) => {
                        root.designer-shape-drag(id, dx, dy);
                    }
                    
                    handle_drag(id, handle, dx, dy) => {
                        root.designer-handle-drag(id, handle, dx, dy);
                    }
                    
                    canvas_pan(dx, dy) => {
                        root.designer-canvas-pan(dx, dy);
                    }
                    
                    deselect_all => {
                        root.designer-deselect-all();
                    }
                    
                    set_shift_pressed(pressed) => {
                        root.designer-set-shift-pressed(pressed);
                    }
                    
                    save_shape_properties() => {
                        root.designer-save-shape-properties();
                    }
                    
                    update_shape_property(prop_id, value) => {
                        root.designer-update-shape-property(prop_id, value);
                    }
                    
                    update_feed_rate(rate) => {
                        root.designer-update-feed-rate(rate);
                    }
                    
                    update_spindle_speed(speed) => {
                        root.designer-update-spindle-speed(speed);
                    }
                    
                    update_tool_diameter(diameter) => {
                        root.designer-update-tool-diameter(diameter);
                    }
                    
                    update_cut_depth(depth) => {
                        root.designer-update-cut-depth(depth);
                    }
                    
                    file_new => {
                        root.designer-file-new();
                    }
                    
                    file_open => {
                        root.designer-file-open();
                    }
                    
                    file_save => {
                        root.designer-file-save();
                    }
                    
                    file_save_as => {
                        root.designer-file-save-as();
                    }
                }
                
                // CAM Tools View
                if current-view == "cam-tools" : CAMToolsPanel {
                    open-tabbed-box-maker => {
                        root.generate-tabbed-box();
                    }
                    open-jigsaw-puzzle-maker => {
                        root.generate-jigsaw-puzzle();
                    }
                    open-laser-engraver => {
                        root.generate-laser-engraving();
                    }
                    open-vector-engraver => {
                        root.generate-vector-engraving();
                    }
                }
                
                // Materials View
                if current-view == "materials" : MaterialsManager {
                    materials <=> root.materials;
                    load_materials => {
                        root.load_materials();
                    }
                    create_material(data) => {
                        root.create_material(data);
                    }
                    update_material(data) => {
                        root.update_material(data);
                    }
                    delete_material(id) => {
                        root.delete_material(id);
                    }
                    select_material(id) => {
                        root.select_material(id);
                    }
                    search_materials(query) => {
                        root.search_materials(query);
                    }
                    filter_by_category(category) => {
                        root.filter_by_category(category);
                    }
                }
                
                // CNC Tools View
                if current-view == "cnc-tools" : ToolsManager {
                    tools <=> root.cnc_tools;
                    load_tools => {
                        root.load_tools();
                    }
                    create_tool(data) => {
                        root.create_tool(data);
                    }
                    update_tool(data) => {
                        root.update_tool(data);
                    }
                    delete_tool(id) => {
                        root.delete_tool(id);
                    }
                    select_tool(id) => {
                        root.select_tool(id);
                    }
                    search_tools(query) => {
                        root.search_tools(query);
                    }
                    filter_by_type(tool_type) => {
                        root.filter_by_tool_type(tool_type);
                    }
                    import_gtc_package(file_path) => {
                        root.import_gtc_package(file_path);
                    }
                }
            }
        }
        
        // Status Panel - Compact Single Line
        Rectangle {
            height: 30px;
            background: #2c3e50;
            
            // Left side status text
            HorizontalBox {
                padding-top: 5px;
                padding-bottom: 5px;
                padding-left: 10px;
                padding-right: 10px;
                spacing: 0px;
                alignment: start;
                
                // Connection Status Indicator (colored square)
                Rectangle {
                    width: 16px;
                    height: 16px;
                    background: root.connected ? #2ecc71 : #e74c3c;
                    border-radius: 2px;
                }
                
                // Separator 1
                Text {
                    text: " \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                }
                
                // Port Display
                Text {
                    text: root.connected ? root.selected-port : "Disconnected";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
                
                // Separator between Port and Version
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }
                
                // Version Label and Device Info
                Text {
                    text: root.connected ? "Version: " + root.device-version : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
                
                // Separator 2 - Visual separator with EM spaces
                Text {
                    text: " \u{2003} | \u{2003} ";
                    color: white;
                    font-size: 13.2px;
                    visible: root.connected;
                }
                
                // Position Label
                Text {
                    text: "Position:";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                    visible: root.connected;
                }
                
                // Position Display (X, Y, Z, A, B, C) - shown only when connected
                Text {
                    text: root.connected ? "\u{2003}X: " + round(root.position-x * 1000.0) / 1000.0 + "  Y: " + round(root.position-y * 1000.0) / 1000.0 + "  Z: " + round(root.position-z * 1000.0) / 1000.0 + "  A: " + round(root.position-a * 1000.0) / 1000.0 + "  B: " + round(root.position-b * 1000.0) / 1000.0 + "  C: " + round(root.position-c * 1000.0) / 1000.0 : "";
                    color: white;
                    font-size: 13.2px;
                    font-family: "Monospace";
                }
            }
            
            // Progress indicator - absolutely positioned on the right
            HorizontalBox {
                x: parent.width - self.width - 30px;
                y: -1px;
                width: 150px;
                spacing: 5px;
                alignment: end;
                
                Text {
                    text: "Progress:";
                    color: white;
                    font-size: 13.2px;
                    visible: root.progress-value > 0.0;
                }
                
                Rectangle {
                    width: 100px;
                    height: 18px;
                    border-width: 1px;
                    border-color: white;
                    border-radius: 3px;
                    visible: root.progress-value > 0.0;
                    
                    Rectangle {
                        x: 0;
                        y: 0;
                        width: parent.width * root.progress-value / 100.0;
                        height: parent.height;
                        background: #3498db;
                        border-radius: 3px;
                    }
                    
                    Text {
                        text: round(root.progress-value) + "%";
                        color: white;
                        font-size: 11px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
    }  // Close FocusScope
    

    

    
    // About Dialog
    if about-dialog-visible : Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z: 2000;
        
        TouchArea {
            // Close dialog on background click
            clicked => {
                about-dialog-visible = false;
            }
        }
        
        Rectangle {
            x: (parent.width - 400px) / 2;
            y: (parent.height - 300px) / 2;
            width: 400px;
            height: 300px;
            background: #ecf0f1;
            border-radius: 5px;
            z: 2001;
            
            VerticalBox {
                padding: 20px;
                spacing: 15px;
                
                // Program Name - Triple Size
                Text {
                    text: "GCodeKit4";
                    font-size: 42px;
                    font-weight: 700;
                    color: #2c3e50;
                    horizontal-alignment: center;
                }
                
                // Version
                Text {
                    text: "Version: " + root.app-version;
                    font-size: 13px;
                    color: #34495e;
                    horizontal-alignment: center;
                }
                
                // Build Date
                Text {
                    text: "Built: " + root.app-build-date;
                    font-size: 13px;
                    color: #34495e;
                    horizontal-alignment: center;
                }
                
                // Spacer
                Rectangle {
                    height: 30px;
                }
                
                // OK Button - Lower Right
                HorizontalBox {
                    alignment: end;
                    
                    Button {
                        text: "Ok";
                        width: 80px;
                        height: 35px;
                        clicked => {
                            about-dialog-visible = false;
                        }
                    }
                }
            }
        }
    }
    
    // Settings Dialog
    SettingsDialog {
        visible: settings-dialog-visible;
        dialog-visible: settings-dialog-visible;
        settings-category: settings-category;
        all-settings: all-settings;
        menu-settings-save => { root.menu-settings-save(); }
        menu-settings-cancel => { root.menu-settings-cancel(); }
        menu-settings-restore-defaults => { root.menu-settings-restore-defaults(); }
        update-setting(id, value) => { root.update-setting(id, value); }
    }
}
