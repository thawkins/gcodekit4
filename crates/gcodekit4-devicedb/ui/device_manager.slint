import { Button, LineEdit, ComboBox, CheckBox, ScrollView, ListView, VerticalBox, HorizontalBox, TabWidget } from "std-widgets.slint";
import { Theme } from "../../gcodekit4-ui/ui/theme.slint";
import { StandardButton, StandardInput, StandardCheckBox, StandardSidebar } from "../../gcodekit4-ui/ui/ui_components/shared.slint";

export struct DeviceProfileUiModel {
    id: string,
    name: string,
    description: string,
    device-type: string,
    controller-type: string,
    x-min: string,
    x-max: string,
    y-min: string,
    y-max: string,
    z-min: string,
    z-max: string,
    has-spindle: bool,
    has-laser: bool,
    has-coolant: bool,
    cnc-spindle-watts: string,
    laser-watts: string,
    connection-type: string,
    baud-rate: string,
    port: string,
    tcp-port: string,
    timeout-ms: string,
    auto-reconnect: bool,
    is-active: bool,
}

component DeviceListItem inherits Rectangle {
    in property <DeviceProfileUiModel> profile;
    in property <bool> selected;
    callback clicked();

    height: 40px;
    background: root.selected ? Theme.primary : (touch.has-hover ? Theme.input-background : transparent);
    border-radius: Theme.border-radius;

    HorizontalBox {
        padding-left: 10px;
        alignment: start;
        spacing: 10px;
        
        Text {
            text: root.profile.name;
            color: Theme.text-primary;
            font-size: 13px;
            vertical-alignment: center;
            font-weight: root.profile.is-active ? 700 : 400;
        }
        
        if root.profile.is-active : Text {
            text: "(Active)";
            color: Theme.success;
            font-size: 11px;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

component DMTabButton inherits Rectangle {
    in property <string> text;
    in property <bool> selected;
    callback clicked;
    
    height: 35px;
    background: root.selected ? Theme.panel-background : transparent;
    
    Text {
        text: root.text;
        color: root.selected ? Theme.primary : Theme.text-secondary;
        font-size: 14px;
        font-weight: root.selected ? 700 : 400;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    Rectangle {
        height: 2px;
        width: 100%;
        y: parent.height - self.height;
        background: root.selected ? Theme.primary : transparent;
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

export component DeviceManagerPanel inherits Rectangle {
    in property <[DeviceProfileUiModel]> profiles;
    in property <DeviceProfileUiModel> active-profile;
    in-out property <int> selected-index: -1;
    private property <DeviceProfileUiModel> temp-profile;
    private property <int> active-tab: 0;
    
    callback select-profile(int);
    callback add-profile();
    callback delete-profile(string);
    callback save-profile(DeviceProfileUiModel);
    callback set-active-profile(string);
    
    background: Theme.background;
    
    HorizontalBox {
        spacing: 0px;
        
        // Left Pane: List
        StandardSidebar {
            VerticalBox {
                padding: Theme.padding;
                spacing: Theme.spacing;
                
                Text {
                    text: "Devices";
                    color: Theme.text-primary;
                    font-size: 16px;
                    font-weight: 700;
                    height: 40px;
                    vertical-alignment: center;
                }
                
                ListView {
                    for profile[i] in root.profiles : DeviceListItem {
                        profile: profile;
                        selected: i == root.selected-index;
                        clicked => { 
                            root.selected-index = -1;
                            root.selected-index = i;
                            root.select-profile(i);
                        }
                    }
                }
                
                Rectangle {
                    height: 50px;
                    HorizontalBox {
                        alignment: center;
                        StandardButton {
                            text: "Add Device";
                            primary: true;
                            width: 120px;
                            clicked => { root.add-profile(); }
                        }
                    }
                }
            }
        }
        
        // Right Pane: Details
        Rectangle {
            background: Theme.background;
            
            if root.selected-index >= 0 && root.selected-index < root.profiles.length : VerticalBox {
                padding: 20px;
                spacing: 20px;
                
                property <DeviceProfileUiModel> p: root.profiles[root.selected-index];
                
                HorizontalBox {
                    alignment: space-between;
                    Text {
                        text: "Edit Device: " + p.name;
                        font-size: 18px;
                        font-weight: 700;
                        color: Theme.text-primary;
                    }
                    
                    if !p.is-active : StandardButton {
                        text: "Set as Active";
                        width: 120px;
                        clicked => { root.set-active-profile(p.id); }
                    }
                }
                
                // Custom Tab Bar
                HorizontalBox {
                    spacing: 10px;
                    alignment: start;
                    height: 40px;
                    
                    DMTabButton { text: "General"; selected: root.active-tab == 0; width: 100px; clicked => { root.active-tab = 0; } }
                    DMTabButton { text: "Dimensions"; selected: root.active-tab == 1; width: 100px; clicked => { root.active-tab = 1; } }
                    DMTabButton { text: "Capabilities"; selected: root.active-tab == 2; width: 100px; clicked => { root.active-tab = 2; } }
                }
                
                // Tab Content Area
                Rectangle {
                    vertical-stretch: 1;
                    
                    // General Tab
                    if root.active-tab == 0 : Flickable {
                        viewport-height: general-content.preferred-height;
                        general-content := VerticalBox {
                        spacing: 15px;
                        alignment: start;
                        padding-top: 15px;
                        
                        Text { text: "Name:"; color: Theme.text-secondary; }
                        StandardInput {
                            text: p.name;
                            edited(s) => { 
                                root.temp-profile = p;
                                root.temp-profile.name = s;
                                root.save-profile(root.temp-profile);
                            }
                        }
                        
                        Text { text: "Description:"; color: Theme.text-secondary; }
                        StandardInput {
                            text: p.description;
                            edited(s) => { 
                                root.temp-profile = p;
                                root.temp-profile.description = s;
                                root.save-profile(root.temp-profile);
                            }
                        }
                        
                        Text { text: "Device Type:"; color: Theme.text-secondary; }
                        ComboBox {
                            model: ["CNC Mill", "CNC Lathe", "Laser Cutter", "3D Printer", "Plotter"];
                            current-value: p.device-type;
                            selected(s) => {
                                root.temp-profile = p;
                                root.temp-profile.device-type = s;
                                root.save-profile(root.temp-profile);
                            }
                        }
                        
                        Text { text: "Controller Type:"; color: Theme.text-secondary; }
                        ComboBox {
                            model: ["GRBL", "TinyG", "g2core", "Smoothieware", "FluidNC", "Marlin"];
                            current-value: p.controller-type;
                            selected(s) => {
                                root.temp-profile = p;
                                root.temp-profile.controller-type = s;
                                root.save-profile(root.temp-profile);
                            }
                        }

                        Rectangle { height: 10px; }
                        Text { text: "Connection Settings:"; color: Theme.text-primary; font-weight: 700; }

                        Text { text: "Connection Type:"; color: Theme.text-secondary; }
                        ComboBox {
                            model: ["Serial", "TCP/IP", "WebSocket"];
                            current-value: p.connection-type;
                            selected(s) => {
                                root.temp-profile = p;
                                root.temp-profile.connection-type = s;
                                root.save-profile(root.temp-profile);
                            }
                        }

                        if p.connection-type == "Serial" : VerticalBox {
                            spacing: 10px;
                            padding: 0px;
                            Text { text: "Baud Rate:"; color: Theme.text-secondary; }
                            ComboBox {
                                model: ["9600", "19200", "38400", "57600", "115200", "250000"];
                                current-value: p.baud-rate;
                                selected(s) => {
                                    root.temp-profile = p;
                                    root.temp-profile.baud-rate = s;
                                    root.save-profile(root.temp-profile);
                                }
                            }
                            Text { text: "Port:"; color: Theme.text-secondary; }
                            StandardInput {
                                text: p.port;
                                edited(s) => {
                                    root.temp-profile = p;
                                    root.temp-profile.port = s;
                                    root.save-profile(root.temp-profile);
                                }
                            }
                        }

                        if p.connection-type != "Serial" : VerticalBox {
                            spacing: 10px;
                            padding: 0px;
                            Text { text: "TCP Port:"; color: Theme.text-secondary; }
                            StandardInput {
                                text: p.tcp-port;
                                edited(s) => {
                                    root.temp-profile = p;
                                    root.temp-profile.tcp-port = s;
                                    root.save-profile(root.temp-profile);
                                }
                            }
                        }

                        Text { text: "Timeout (ms):"; color: Theme.text-secondary; }
                        StandardInput {
                            text: p.timeout-ms;
                            edited(s) => {
                                root.temp-profile = p;
                                root.temp-profile.timeout-ms = s;
                                root.save-profile(root.temp-profile);
                            }
                        }

                        StandardCheckBox {
                            text: "Auto Reconnect";
                            checked: p.auto-reconnect;
                            toggled => {
                                root.temp-profile = p;
                                root.temp-profile.auto-reconnect = self.checked;
                                root.save-profile(root.temp-profile);
                            }
                        }
                    }
                    }
                    
                    // Dimensions Tab
                    if root.active-tab == 1 : Flickable {
                        viewport-height: dimensions-content.preferred-height;
                        dimensions-content := VerticalBox {
                        spacing: 15px;
                        alignment: start;
                        padding-top: 15px;
                        
                        HorizontalBox {
                            Text { text: "X Axis (mm):"; width: 100px; vertical-alignment: center; color: Theme.text-secondary; }
                            Text { text: "Min:"; vertical-alignment: center; font-size: 10px; color: Theme.text-secondary; }
                            StandardInput { text: p.x-min; width: 70px; placeholder-text: "0.0"; edited(s) => { root.temp-profile = p; root.temp-profile.x-min = s; root.save-profile(root.temp-profile); } }
                            Text { text: "Max:"; vertical-alignment: center; font-size: 10px; color: Theme.text-secondary; }
                            StandardInput { text: p.x-max; width: 70px; placeholder-text: "200.0"; edited(s) => { root.temp-profile = p; root.temp-profile.x-max = s; root.save-profile(root.temp-profile); } }
                        }
                        
                        HorizontalBox {
                            Text { text: "Y Axis (mm):"; width: 100px; vertical-alignment: center; color: Theme.text-secondary; }
                            Text { text: "Min:"; vertical-alignment: center; font-size: 10px; color: Theme.text-secondary; }
                            StandardInput { text: p.y-min; width: 70px; placeholder-text: "0.0"; edited(s) => { root.temp-profile = p; root.temp-profile.y-min = s; root.save-profile(root.temp-profile); } }
                            Text { text: "Max:"; vertical-alignment: center; font-size: 10px; color: Theme.text-secondary; }
                            StandardInput { text: p.y-max; width: 70px; placeholder-text: "200.0"; edited(s) => { root.temp-profile = p; root.temp-profile.y-max = s; root.save-profile(root.temp-profile); } }
                        }
                        
                        HorizontalBox {
                            Text { text: "Z Axis (mm):"; width: 100px; vertical-alignment: center; color: Theme.text-secondary; }
                            Text { text: "Min:"; vertical-alignment: center; font-size: 10px; color: Theme.text-secondary; }
                            StandardInput { text: p.z-min; width: 70px; placeholder-text: "0.0"; edited(s) => { root.temp-profile = p; root.temp-profile.z-min = s; root.save-profile(root.temp-profile); } }
                            Text { text: "Max:"; vertical-alignment: center; font-size: 10px; color: Theme.text-secondary; }
                            StandardInput { text: p.z-max; width: 70px; placeholder-text: "100.0"; edited(s) => { root.temp-profile = p; root.temp-profile.z-max = s; root.save-profile(root.temp-profile); } }
                        }
                    }
                    }
                    
                    // Capabilities Tab
                    if root.active-tab == 2 : Flickable {
                        viewport-height: capabilities-content.preferred-height;
                        capabilities-content := VerticalBox {
                        spacing: 15px;
                        alignment: start;
                        padding-top: 15px;
                        
                        StandardCheckBox {
                            text: "Has Spindle";
                            checked: p.has-spindle;
                            toggled => { root.temp-profile = p; root.temp-profile.has-spindle = self.checked; root.save-profile(root.temp-profile); }
                        }
                        
                        StandardCheckBox {
                            text: "Has Laser";
                            checked: p.has-laser;
                            toggled => { root.temp-profile = p; root.temp-profile.has-laser = self.checked; root.save-profile(root.temp-profile); }
                        }
                        
                        StandardCheckBox {
                            text: "Has Coolant Control";
                            checked: p.has-coolant;
                            toggled => { root.temp-profile = p; root.temp-profile.has-coolant = self.checked; root.save-profile(root.temp-profile); }
                        }
                        
                        Rectangle { height: 10px; }
                        Text { text: "Power Settings:"; color: Theme.text-primary; font-weight: 700; }
                        
                        HorizontalBox {
                            Text { text: "Spindle Power (W):"; width: 140px; vertical-alignment: center; color: Theme.text-secondary; }
                            StandardInput { 
                                text: p.cnc-spindle-watts; 
                                width: 100px; 
                                enabled: p.has-spindle;
                                edited(s) => { root.temp-profile = p; root.temp-profile.cnc-spindle-watts = s; root.save-profile(root.temp-profile); } 
                            }
                        }
                        
                        HorizontalBox {
                            Text { text: "Laser Power (W):"; width: 140px; vertical-alignment: center; color: Theme.text-secondary; }
                            StandardInput { 
                                text: p.laser-watts; 
                                width: 100px; 
                                enabled: p.has-laser;
                                edited(s) => { root.temp-profile = p; root.temp-profile.laser-watts = s; root.save-profile(root.temp-profile); } 
                            }
                        }
                    }
                    }
                }
                
                HorizontalBox {
                    alignment: end;
                    StandardButton {
                        text: "Delete Device";
                        destructive: true;
                        width: 120px;
                        clicked => { root.delete-profile(p.id); }
                    }
                }
            }
            
            if root.selected-index == -1 : Text {
                text: "Select a device to edit or create a new one.";
                color: Theme.text-muted;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}
