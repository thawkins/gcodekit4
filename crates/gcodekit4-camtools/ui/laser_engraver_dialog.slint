// Laser Image Engraving Dialog
import { Button, ScrollView, VerticalBox, HorizontalBox, LineEdit, ComboBox, CheckBox, Slider, GroupBox } from "std-widgets.slint";

export struct EngravingParams {
    width-mm: float,
    feed-rate: float,
    travel-rate: float,
    min-power: float,
    max-power: float,
    pixels-per-mm: float,
    scan-direction: string,
    bidirectional: bool,
    invert: bool,
    line-spacing: float,
    power-scale: float,
    mirror-x: bool,
    mirror-y: bool,
    rotation: string,
    halftone: string,
    halftone-dot-size: int,
    halftone-threshold: int,
}

export component LaserEngraverDialog inherits Window {
    in-out property <string> image-path: "";
    in property <image> preview-image;
    in property <string> estimated-time: "0:00";
    in property <string> output-size: "0 x 0 mm";
    in property <string> unit-label: "mm";
    
    // Individual parameter properties for two-way binding
    in-out property <string> width-mm: "100.0";
    in-out property <string> feed-rate: "1000.0";
    in-out property <string> travel-rate: "3000.0";
    in-out property <float> min-power: 0.0;
    in-out property <float> max-power: 100.0;
    in-out property <string> pixels-per-mm: "10.0";
    in-out property <string> scan-direction: "Horizontal";
    in-out property <bool> bidirectional: true;
    in-out property <bool> invert: false;
    in-out property <string> line-spacing: "1.0";
    in-out property <string> power-scale: "1000.0";
    in-out property <bool> mirror-x: false;
    in-out property <bool> mirror-y: false;
    in-out property <string> rotation: "0°";
    in-out property <string> halftone: "None";
    in-out property <int> halftone-dot-size: 4;
    in-out property <int> halftone-threshold: 127;
    in-out property <string> offset-x: "10.0";
    in-out property <string> offset-y: "10.0";
    
    callback load-image();
    callback generate-gcode();
    callback update-preview();
    callback close-dialog();
    callback load-params();
    callback save-params();
    
    title: "Laser Image Engraving";
    preferred-width: 800px;
    preferred-height: 600px;
    always-on-top: true;
    
    VerticalBox {
        padding: 10px;
        spacing: 10px;
        
        // Header with image selection
        HorizontalBox {
            spacing: 10px;
            alignment: start;
            
            Text {
                text: "Image File:";
                vertical-alignment: center;
            }
            
            LineEdit {
                text <=> image-path;
                placeholder-text: "Select an image file...";
                horizontal-stretch: 1;
                enabled: false;
            }
            
            Button {
                text: "Browse...";
                clicked => {
                    load-image();
                }
            }
        }
        
        // Main content area with preview and parameters
        HorizontalBox {
            spacing: 10px;
            vertical-stretch: 1;
            
            // Left side - Image preview
            GroupBox {
                title: "Preview";
                horizontal-stretch: 1;
                
                VerticalBox {
                    Rectangle {
                        background: #2a2a2a;
                        border-color: #555;
                        border-width: 1px;
                        
                        if preview-image.width > 0: Image {
                            source: preview-image;
                            image-fit: contain;
                            width: 100%;
                            height: 100%;
                        }
                        
                        if preview-image.width == 0: Text {
                            text: "No image loaded";
                            color: #888;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                    
                    Text {
                        text: output-size;
                        horizontal-alignment: center;
                        color: #aaa;
                    }
                }
            }
            
            // Right side - Parameters
            ScrollView {
                width: 350px;
                
                VerticalBox {
                    spacing: 15px;
                    padding: 5px;
                    
                    // Size parameters
                    GroupBox {
                        title: "Size";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Width (" + root.unit-label + "):"; width: 120px; }
                                LineEdit {
                                    text <=> width-mm;
                                    horizontal-stretch: 1;
                                    edited => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Resolution (px/" + root.unit-label + "):"; width: 120px; }
                                LineEdit {
                                    text <=> pixels-per-mm;
                                    horizontal-stretch: 1;
                                    edited => {
                                        update-preview();
                                    }
                                }
                            }
                        }
                    }
                    
                    // Scanning parameters
                    GroupBox {
                        title: "Scanning";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Direction:"; width: 120px; }
                                ComboBox {
                                    model: ["Horizontal", "Vertical"];
                                    current-value <=> scan-direction;
                                    horizontal-stretch: 1;
                                }
                            }
                            
                            HorizontalBox {
                                CheckBox {
                                    text: "Bidirectional (faster)";
                                    checked <=> bidirectional;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Line Spacing:"; width: 120px; }
                                LineEdit {
                                    text <=> line-spacing;
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }
                    
                    // Laser power parameters
                    GroupBox {
                        title: "Laser Power";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Min Power (%):"; width: 120px; }
                                Slider {
                                    minimum: 0;
                                    maximum: 100;
                                    value <=> min-power;
                                    horizontal-stretch: 1;
                                }
                                Text {
                                    text: min-power;
                                    width: 40px;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Max Power (%):"; width: 120px; }
                                Slider {
                                    minimum: 0;
                                    maximum: 100;
                                    value <=> max-power;
                                    horizontal-stretch: 1;
                                }
                                Text {
                                    text: max-power;
                                    width: 40px;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Power Scale:"; width: 120px; }
                                LineEdit {
                                    text <=> power-scale;
                                    placeholder-text: "1000 for GRBL";
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }
                    
                    // Speed parameters
                    GroupBox {
                        title: "Speed";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Feed Rate:"; width: 120px; }
                                LineEdit {
                                    text <=> feed-rate;
                                    horizontal-stretch: 1;
                                    edited => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Travel Rate:"; width: 120px; }
                                LineEdit {
                                    text <=> travel-rate;
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }
                    
                    // Image options
                    GroupBox {
                        title: "Image";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                CheckBox {
                                    text: "Invert (negative)";
                                    checked <=> invert;
                                }
                            }
                            
                            // Mirror options
                            HorizontalBox {
                                CheckBox {
                                    text: "Mirror X (horizontal flip)";
                                    checked <=> mirror-x;
                                    toggled => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                CheckBox {
                                    text: "Mirror Y (vertical flip)";
                                    checked <=> mirror-y;
                                    toggled => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            // Rotation
                            HorizontalBox {
                                Text { text: "Rotation:"; width: 120px; }
                                ComboBox {
                                    model: ["0°", "90°", "180°", "270°"];
                                    current-value <=> rotation;
                                    horizontal-stretch: 1;
                                    selected(idx) => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            // Halftoning
                            HorizontalBox {
                                Text { text: "Halftoning:"; width: 120px; }
                                ComboBox {
                                    model: ["None", "Threshold", "Bayer 4x4", "Floyd-Steinberg", "Atkinson"];
                                    current-value <=> halftone;
                                    horizontal-stretch: 1;
                                    selected(idx) => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            // Halftone dot size slider (visible when halftone is enabled)
                            if halftone != "None": HorizontalBox {
                                Text { text: "Dot Size (px):"; width: 120px; }
                                Slider {
                                    minimum: 1;
                                    maximum: 10;
                                    value: halftone-dot-size;
                                    changed(val) => {
                                        halftone-dot-size = round(val);
                                        update-preview();
                                    }
                                    horizontal-stretch: 1;
                                }
                                Text {
                                    text: halftone-dot-size;
                                    width: 40px;
                                }
                            }
                        }
                    }
                    
                    // Work Origin Offsets
                    GroupBox {
                        title: "Work Origin Offsets (" + root.unit-label + ")";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Offset X:"; width: 120px; }
                                LineEdit {
                                    text <=> offset-x;
                                    placeholder-text: "10.0";
                                    horizontal-stretch: 1;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Offset Y:"; width: 120px; }
                                LineEdit {
                                    text <=> offset-y;
                                    placeholder-text: "10.0";
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }
                    
                    // Estimated time
                    Rectangle {
                        background: #3a3a3a;
                        border-color: #555;
                        border-width: 1px;
                        border-radius: 4px;
                        
                        HorizontalBox {
                            padding: 10px;
                            spacing: 10px;
                            
                            Text {
                                text: "Estimated Time:";
                                color: #aaa;
                            }
                            
                            Text {
                                text: estimated-time;
                                color: #4a9eff;
                                font-weight: 700;
                            }
                        }
                    }
                }
            }
        }
        
        // Bottom buttons
        HorizontalBox {
            spacing: 10px;
            alignment: end;
            
            Button {
                text: "Load";
                clicked => {
                    load-params();
                }
            }

            Button {
                text: "Save";
                clicked => {
                    save-params();
                }
            }

            Button {
                text: "Generate G-code";
                primary: true;
                enabled: preview-image.width > 0;
                clicked => {
                    generate-gcode();
                }
            }
            
            Button {
                text: "Close";
                clicked => {
                    close-dialog();
                }
            }
        }
    }
}
