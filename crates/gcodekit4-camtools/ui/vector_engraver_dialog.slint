// Laser Vector Image Engraving Dialog
import { Button, ScrollView, VerticalBox, HorizontalBox, LineEdit, ComboBox, CheckBox, Slider, GroupBox } from "std-widgets.slint";

export struct VectorEngravingParams {
    feed-rate: float,
    travel-rate: float,
    cut-power: float,
    engrave-power: float,
    power-scale: float,
    multi-pass: bool,
    num-passes: int,
    z-increment: float,
    invert-power: bool,
    desired-width: float,
    offset-x: float,
    offset-y: float,
    enable-hatch: bool,
    hatch-angle: float,
    hatch-spacing: float,
    hatch-tolerance: float,
}

export component VectorEngraverDialog inherits Window {
    in-out property <string> vector-path: "";
    in property <string> file-info: "No file selected";
    in property <image> preview-image;
    in property <string> estimated-time: "0:00";
    
    // Individual parameter properties for two-way binding
    in-out property <float> feed-rate: 600.0;
    in-out property <float> travel-rate: 3000.0;
    in-out property <float> cut-power: 100.0;
    in-out property <float> engrave-power: 50.0;
    in-out property <float> power-scale: 1000.0;
    in-out property <bool> multi-pass: false;
    in-out property <int> num-passes: 1;
    in-out property <float> z-increment: 0.5;
    in-out property <bool> invert-power: false;
    in-out property <float> desired-width: 100.0;
    in property <float> output-width: 0.0;
    in property <float> output-height: 0.0;
    in-out property <string> offset-x: "10.0";
    in-out property <string> offset-y: "10.0";
    in-out property <bool> enable-hatch: false;
    in-out property <float> hatch-angle: 45.0;
    in-out property <float> hatch-spacing: 1.0;
    in-out property <float> hatch-tolerance: 0.1;
    in-out property <bool> cross-hatch: false;
    in-out property <bool> enable-dwell: false;
    in-out property <float> dwell-time: 0.1;
    
    callback load-vector-file();
    callback generate-gcode();
    callback update-preview();
    callback close-dialog();
    callback load-params();
    callback save-params();
    
    title: "Laser Vector Image Engraver";
    preferred-width: 800px;
    preferred-height: 600px;
    always-on-top: true;
    
    VerticalBox {
        padding: 10px;
        spacing: 10px;
        
        // Header with file selection
        HorizontalBox {
            spacing: 10px;
            alignment: start;
            
            Text {
                text: "Vector File:";
                vertical-alignment: center;
            }
            
            LineEdit {
                text <=> vector-path;
                placeholder-text: "Select an SVG or DXF file...";
                horizontal-stretch: 1;
                enabled: false;
            }
            
            Button {
                text: "Browse...";
                clicked => {
                    load-vector-file();
                }
            }
        }
        
        // Main content area with preview and parameters
        HorizontalBox {
            spacing: 10px;
            vertical-stretch: 1;
            
            // Left side - Image preview
            GroupBox {
                title: "Preview";
                horizontal-stretch: 1;
                
                VerticalBox {
                    Rectangle {
                        background: #808080;
                        border-color: #555;
                        border-width: 1px;
                        
                        if preview-image.width > 0: Image {
                            source: preview-image;
                            image-fit: contain;
                            width: 100%;
                            height: 100%;
                        }
                        
                        if preview-image.width == 0: Text {
                            text: "No image selected";
                            color: #888;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                    
                    Text {
                        text: file-info;
                        horizontal-alignment: center;
                        color: #aaa;
                    }
                }
            }
            
            // Right side - Parameters
            ScrollView {
                width: 350px;
                
                VerticalBox {
                    spacing: 15px;
                    padding: 5px;
                    
                    // Cutting parameters
                    GroupBox {
                        title: "Cutting Parameters";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Cut Power (%):"; width: 140px; }
                                Slider {
                                    minimum: 0;
                                    maximum: 100;
                                    value <=> cut-power;
                                    horizontal-stretch: 1;
                                }
                                Text {
                                    text: cut-power;
                                    width: 40px;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Engrave Power (%):"; width: 140px; }
                                Slider {
                                    minimum: 0;
                                    maximum: 100;
                                    value <=> engrave-power;
                                    horizontal-stretch: 1;
                                }
                                Text {
                                    text: engrave-power;
                                    width: 40px;
                                }
                            }
                            
                            HorizontalBox {
                                CheckBox {
                                    text: "Invert Power";
                                    checked <=> invert-power;
                                }
                            }
                        }
                    }
                    
                    // Speed parameters
                    GroupBox {
                        title: "Speed";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Feed Rate (mm/min):"; width: 140px; }
                                LineEdit {
                                    text: feed-rate;
                                    horizontal-stretch: 1;
                                    edited => {
                                        feed-rate = self.text.to-float();
                                        update-preview();
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Travel Rate (mm/min):"; width: 140px; }
                                LineEdit {
                                    text: travel-rate;
                                    horizontal-stretch: 1;
                                    edited => {
                                        travel-rate = self.text.to-float();
                                    }
                                }
                            }
                        }
                    }
                    
                    // Multi-pass options
                    GroupBox {
                        title: "Multi-Pass Cutting";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                CheckBox {
                                    text: "Enable Multi-Pass";
                                    checked <=> multi-pass;
                                    toggled => {
                                        update-preview();
                                    }
                                }
                            }
                            
                            if multi-pass: HorizontalBox {
                                Text { text: "Number of Passes:"; width: 140px; }
                                Slider {
                                    minimum: 1;
                                    maximum: 10;
                                    value: num-passes;
                                    changed(val) => {
                                        num-passes = round(val);
                                        update-preview();
                                    }
                                    horizontal-stretch: 1;
                                }
                                Text {
                                    text: num-passes;
                                    width: 40px;
                                }
                            }
                            
                            if multi-pass: HorizontalBox {
                                Text { text: "Z Increment (mm):"; width: 140px; }
                                LineEdit {
                                    text: z-increment;
                                    horizontal-stretch: 1;
                                    edited => {
                                        z-increment = self.text.to-float();
                                    }
                                }
                            }
                        }
                    }
                    
                    // Laser power scale
                    GroupBox {
                        title: "Laser Configuration";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Desired Width (mm):"; width: 140px; }
                                LineEdit {
                                    text: desired-width;
                                    placeholder-text: "100";
                                    horizontal-stretch: 1;
                                    edited => {
                                        desired-width = self.text.to-float();
                                        update-preview();
                                    }
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Output Size (mm):"; width: 140px; }
                                Text {
                                    text: output-width > 0 ? root.output-width.round() + " × " + root.output-height.round() : "—";
                                    color: #4a9eff;
                                    font-weight: 500;
                                    horizontal-stretch: 1;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Power Scale:"; width: 140px; }
                                LineEdit {
                                    text: power-scale;
                                    placeholder-text: "1000 for GRBL";
                                    horizontal-stretch: 1;
                                    edited => {
                                        power-scale = self.text.to-float();
                                    }
                                }
                            }
    
                            HorizontalBox {
                                CheckBox {
                                    text: "Enable Laser Dwell";
                                    checked <=> enable-dwell;
                                }
                            }
    
                            if enable-dwell: HorizontalBox {
                                Text { text: "Dwell Time (s):"; width: 140px; }
                                LineEdit {
                                    text: dwell-time;
                                    horizontal-stretch: 1;
                                    edited => {
                                        dwell-time = self.text.to-float();
                                    }
                                }
                            }
                        }
                    }
                    
                    // Work Origin Offsets
                    GroupBox {
                        title: "Work Origin Offsets (mm)";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                Text { text: "Offset X:"; width: 140px; }
                                LineEdit {
                                    text <=> offset-x;
                                    placeholder-text: "10.0";
                                    horizontal-stretch: 1;
                                }
                            }
                            
                            HorizontalBox {
                                Text { text: "Offset Y:"; width: 140px; }
                                LineEdit {
                                    text <=> offset-y;
                                    placeholder-text: "10.0";
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }
    
                    // Hatching (Fill)
                    GroupBox {
                        title: "Hatching (Fill)";
                        
                        VerticalBox {
                            spacing: 8px;
                            
                            HorizontalBox {
                                CheckBox {
                                    text: "Enable Hatching";
                                    checked <=> enable-hatch;
                                    toggled => { update-preview(); }
                                }
                                
                                if enable-hatch: CheckBox {
                                    text: "Cross Hatch (+90°)";
                                    checked <=> cross-hatch;
                                    toggled => { update-preview(); }
                                }
                            }
                            
                            if enable-hatch: VerticalBox {
                                spacing: 8px;
                                
                                HorizontalBox {
                                    Text { text: "Angle (deg):"; width: 140px; }
                                    Slider {
                                        minimum: 0;
                                        maximum: 180;
                                        value <=> hatch-angle;
                                        horizontal-stretch: 1;
                                        changed => { update-preview(); }
                                    }
                                    Text { text: round(hatch-angle); width: 40px; }
                                }
                                
                                HorizontalBox {
                                    Text { text: "Spacing (mm):"; width: 140px; }
                                    LineEdit {
                                        text: hatch-spacing;
                                        horizontal-stretch: 1;
                                        edited => {
                                            hatch-spacing = self.text.to-float();
                                            update-preview();
                                        }
                                    }
                                }
                                
                                HorizontalBox {
                                    Text { text: "Tolerance (mm):"; width: 140px; }
                                    LineEdit {
                                        text: hatch-tolerance;
                                        horizontal-stretch: 1;
                                        edited => {
                                            hatch-tolerance = self.text.to-float();
                                            update-preview();
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Estimated time
                    Rectangle {
                        background: #3a3a3a;
                        border-color: #555;
                        border-width: 1px;
                        border-radius: 4px;
                        
                        HorizontalBox {
                            padding: 10px;
                            spacing: 10px;
                            
                            Text {
                                text: "Estimated Time:";
                                color: #aaa;
                            }
                            
                            Text {
                                text: estimated-time;
                                color: #4a9eff;
                                font-weight: 700;
                            }
                        }
                    }
                }
            }
        }
        
        // Bottom buttons
        HorizontalBox {
            spacing: 10px;
            alignment: end;
            
            Button {
                text: "Load";
                clicked => {
                    load-params();
                }
            }

            Button {
                text: "Save";
                clicked => {
                    save-params();
                }
            }

            Button {
                text: "Generate G-code";
                primary: true;
                enabled: vector-path != "";
                clicked => {
                    generate-gcode();
                }
            }
            
            Button {
                text: "Close";
                clicked => {
                    close-dialog();
                }
            }
        }
    }
}
