//! G-Code Visualizer Panel
//! Displays a 3D visualization of the loaded G-Code toolpath
//! Shows machine position, bounding box, and real-time tool movement

import { ScrollView, VerticalBox, HorizontalBox, Button, GridBox, CheckBox } from "std-widgets.slint";
import { Theme } from "../../gcodekit4-ui/ui/theme.slint";
import { StandardButton, StandardCheckBox, StandardSidebar } from "../../gcodekit4-ui/ui/ui_components/shared.slint";

export component GcodeVisualizerPanel inherits Rectangle {
    horizontal-stretch: 1.0;
    vertical-stretch: 1.0;
    background: Theme.sidebar-background;

    in property <string> gcode-filename: "untitled.gcode";
    in property <string> gcode-content: "";
    in property <string> visualization-path-data: "";
    in property <string> visualization-g1-data: "";
    in property <string> visualization-g2-data: "";
    in property <string> visualization-g3-data: "";
    in property <string> visualization-g4-data: "";
    in property <string> visualization-rapid-moves-data: "";
    in property <string> visualization-grid-data: "";
    in property <string> visualization-origin-data: "";
    in property <string> machine-x: "0.000";
    in property <string> machine-y: "0.000";
    in property <string> machine-z: "0.000";
    in property <string> work-x: "0.000";
    in property <string> work-y: "0.000";
    in property <string> work-z: "0.000";
    in property <float> progress: 0.0;
    in property <string> visualizer-status: "Ready";
    in property <float> x-offset: 0.0;
    in property <float> y-offset: 0.0;
    in property <float> zoom-scale: 1.0;
    in property <string> grid-size: "10mm";
    in property <string> bounding-box-info: "";
    in-out property <bool> show-grid: true;
    in-out property <bool> show-rapid-moves: true;
    in property <float> viewbox-x: 0;
    in property <float> viewbox-y: 0;
    in property <float> viewbox-width: 100;
    in property <float> viewbox-height: 100;
    out property <float> canvas-width: canvas-rect.width / 1px;
    out property <float> canvas-height: canvas-rect.height / 1px;
    
    callback refresh-visualization(/* canvas_width */ float, /* canvas_height */ float);
    callback zoom-in(/* canvas_width */ float, /* canvas_height */ float);
    callback zoom-out(/* canvas_width */ float, /* canvas_height */ float);
    callback fit-to-view(/* canvas_width */ float, /* canvas_height */ float);
    callback reset-view(/* canvas_width */ float, /* canvas_height */ float);
    callback toggle-grid();
    callback pan-by-mouse(/* dx */ float, /* dy */ float);

    HorizontalLayout {
        spacing: 0px;
        padding: 0px;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LEFT SIDEBAR: Controls
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        StandardSidebar {
            VerticalLayout {
                padding: Theme.padding;
                spacing: Theme.spacing;
                alignment: start;

                Text {
                    text: "Visualizer";
                    font-weight: 700;
                    font-size: 14px;
                    color: Theme.text-primary;
                }

                Rectangle { height: 10px; }

                Text {
                    text: "View Controls";
                    font-weight: 700;
                    font-size: 12px;
                    color: Theme.text-secondary;
                }

                HorizontalLayout {
                    spacing: 5px;
                    StandardButton {
                        icon: "üîÑ";
                        tooltip: "Refresh";
                        width: 40px;
                        clicked => { root.refresh-visualization(root.canvas-width, root.canvas-height); }
                    }
                    StandardButton {
                        icon: "‚ä°";
                        tooltip: "Fit to View";
                        width: 40px;
                        clicked => { root.fit-to-view(root.canvas-width, root.canvas-height); }
                    }
                    StandardButton {
                        icon: "‚Ü∫";
                        tooltip: "Reset View";
                        width: 40px;
                        clicked => { root.reset-view(root.canvas-width, root.canvas-height); }
                    }
                }

                Rectangle { height: 10px; }

                Text {
                    text: "Visibility";
                    font-weight: 700;
                    font-size: 12px;
                    color: Theme.text-secondary;
                }

                StandardCheckBox {
                    text: "Show Rapid Moves";
                    checked <=> root.show-rapid-moves;
                }

                StandardCheckBox {
                    text: "Show Grid";
                    checked <=> root.show-grid;
                    toggled => { root.toggle-grid(); }
                }
                
                Rectangle { height: 10px; }
                
                if root.bounding-box-info != "": VerticalLayout {
                    spacing: 5px;
                    Text {
                        text: "Bounds";
                        font-weight: 700;
                        font-size: 12px;
                        color: Theme.text-secondary;
                    }
                    Text {
                        text: root.bounding-box-info;
                        font-size: 11px;
                        color: Theme.text-primary;
                        wrap: word-wrap;
                    }
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CENTER: Canvas Area
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            background: Theme.sidebar-item-selected;
            clip: true;

            // Wrap canvas in FocusScope to enable mouse wheel handling if needed later
            canvas-focus := FocusScope {
                width: 100%;
                height: 100%;

                // Main visualization area
                canvas-rect := Rectangle {
                    width: 100%;
                    height: 100%;
                    
                    // Grid layer
                    if root.show-grid && root.visualization-grid-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #808080;
                        stroke-width: 1px;
                        commands: root.visualization-grid-data;
                    }
                    
                    // Origin marker layer (yellow cross at 0,0)
                    if root.visualization-origin-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: yellow;
                        stroke-width: 2px;
                        commands: root.visualization-origin-data;
                    }
                    
                    // Rapid moves layer (G0) - Cyan, 50% opacity
                    if root.show-rapid-moves && root.visualization-rapid-moves-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #00FFFF80;  // Cyan with 50% opacity
                        stroke-width: 1px;
                        commands: root.visualization-rapid-moves-data;
                    }
                    
                    // G1 layer - Yellow
                    if root.visualization-g1-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #FFFF00;
                        stroke-width: 1px;
                        commands: root.visualization-g1-data;
                    }

                    // G2 layer - Green
                    if root.visualization-g2-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #00FF00;
                        stroke-width: 1px;
                        commands: root.visualization-g2-data;
                    }

                    // G3 layer - Bright Red
                    if root.visualization-g3-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #FF0000;
                        stroke-width: 1px;
                        commands: root.visualization-g3-data;
                    }

                    // G4 layer - Bright Blue
                    if root.visualization-g4-data != "" : Path {
                        viewbox-x: root.viewbox-x;
                        viewbox-y: root.viewbox-y;
                        viewbox-width: root.viewbox-width;
                        viewbox-height: root.viewbox-height;
                        width: 100%;
                        height: 100%;
                        fill: transparent;
                        stroke: #0000FF;
                        stroke-width: 1px;
                        commands: root.visualization-g4-data;
                    }
                    
                    // Mouse drag support for panning
                    TouchArea {
                        width: 100%;
                        height: 100%;
                        mouse-cursor: self.pressed ? grabbing : grab;
                        
                        property <length> drag-start-x;
                        property <length> drag-start-y;
                        
                        moved => {
                            if (self.pressed) {
                                root.pan-by-mouse(
                                    (self.mouse-x - self.drag-start-x) / 1px,
                                    (self.mouse-y - self.drag-start-y) / 1px
                                );
                                self.drag-start-x = self.mouse-x;
                                self.drag-start-y = self.mouse-y;
                            }
                        }
                        
                        pointer-event(event) => {
                            if (event.kind == PointerEventKind.down) {
                                self.drag-start-x = self.mouse-x;
                                self.drag-start-y = self.mouse-y;
                            }
                        }
                        
                        scroll-event(event) => {
                            if (event.delta-y > 0) {
                                root.zoom-in(root.canvas-width, root.canvas-height);
                            } else {
                                root.zoom-out(root.canvas-width, root.canvas-height);
                            }
                            accept
                        }
                    }
                }

                // Floating Status Bar (Bottom Left)
                Rectangle {
                    x: 10px;
                    y: parent.height - 40px;
                    height: 30px;
                    width: status-layout.preferred-width + 20px;
                    background: Theme.sidebar-background;
                    border-radius: 15px;
                    opacity: 0.9;
                    border-width: 1px;
                    border-color: Theme.sidebar-item-selected;
                    
                    status-layout := HorizontalLayout {
                        padding-left: 10px;
                        padding-right: 10px;
                        spacing: 15px;
                        
                        Text {
                            text: Math.round(root.zoom-scale * 100.0) + "%";
                            color: Theme.text-primary;
                            font-size: 12px;
                            font-weight: 700;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "X: " + Math.round(root.x-offset * 10.0) / 10.0;
                            color: Theme.text-secondary;
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "Y: " + Math.round(root.y-offset * 10.0) / 10.0;
                            color: Theme.text-secondary;
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                        
                        if root.show-grid : Text {
                            text: root.grid_size;
                            color: Theme.text-secondary;
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                    }
                }
                
                // Floating Zoom Controls (Bottom Right)
                Rectangle {
                    x: parent.width - 100px;
                    y: parent.height - 40px;
                    height: 30px;
                    width: 90px;
                    background: Theme.sidebar-background;
                    border-radius: 15px;
                    opacity: 0.9;
                    border-width: 1px;
                    border-color: Theme.sidebar-item-selected;
                    
                    HorizontalLayout {
                        alignment: center;
                        spacing: 5px;
                        
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            background: transparent;
                            Text { text: "-"; color: Theme.text-primary; font-size: 16px; vertical-alignment: center; horizontal-alignment: center; }
                            TouchArea { clicked => { root.zoom-out(root.canvas-width, root.canvas-height); } }
                        }
                        
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            background: transparent;
                            Text { text: "Fit"; color: Theme.text-primary; font-size: 11px; vertical-alignment: center; horizontal-alignment: center; }
                            TouchArea { clicked => { root.fit-to-view(root.canvas-width, root.canvas-height); } }
                        }
                        
                        Rectangle {
                            width: 24px;
                            height: 24px;
                            background: transparent;
                            Text { text: "+"; color: Theme.text-primary; font-size: 16px; vertical-alignment: center; horizontal-alignment: center; }
                            TouchArea { width: 100%; height: 100%; clicked => { root.zoom-in(root.canvas-width, root.canvas-height); } }
                        }
                    }
                }
            }
        }
    }
}
